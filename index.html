<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Columbus East Tax Services</title>

<style>
  :root{
    --bg1:#020617;
    --bg2:#000;
    --card:#fff;
    --text:#0f172a;
    --muted:#475569;
    --ring:rgba(99,102,241,.25);

    --btnCall:#2563eb;
    --btnText:#16a34a;
    --btnEmail:#9333ea;
    --btnBook:#0f766e;

    --slotBorder:#34d399;
    --slotBg:#ecfdf5;

    --slotActiveBg:#c7d2fe;
    --slotActiveBorder:#6366f1;

    --slotDisabledBg:#f1f5f9;
    --slotDisabledBorder:#cbd5e1;
    --slotDisabledText:#94a3b8;

    --okBg:#dcfce7; --okText:#166534; --okBorder:#86efac;
    --badBg:#fee2e2; --badText:#991b1b; --badBorder:#fecaca;
    --warnBg:#fef3c7; --warnText:#92400e; --warnBorder:#fde68a;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:Arial, Helvetica, sans-serif;
    background: radial-gradient(circle at top, var(--bg1), var(--bg2));
    padding:22px;
  }
  .wrap{ max-width:980px; margin:0 auto; }
  .card{
    background:var(--card);
    border-radius:28px;
    padding:38px 28px;
    box-shadow:0 34px 85px rgba(0,0,0,.55);
    text-align:center;
  }

  .logo{
    width:360px;
    max-width:92%;
    margin:0 auto 14px;
    display:block;
  }

  .contact{
    font-size:22px;
    font-weight:900;
    color:#0b1220;
    line-height:1.5;
    margin:10px 0 20px;
  }

  .btn{
    width:100%;
    padding:18px;
    margin:14px 0;
    border:none;
    border-radius:18px;
    font-size:20px;
    font-weight:900;
    color:#fff;
    cursor:pointer;
    transition:transform .12s ease, opacity .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

  .call{ background:var(--btnCall); }
  .text{ background:var(--btnText); }
  .email{ background:var(--btnEmail); }
  .book{ background:var(--btnBook); }

  .booking{
    margin-top:18px;
    text-align:left;
    max-height:0;
    overflow:hidden;
    transition:max-height .5s ease;
  }
  .booking.open{ max-height:2600px; }

  .section{
    margin-top:18px;
    border:1px solid #e5e7eb;
    border-radius:20px;
    padding:16px;
    background:#fff;
  }

  .row{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media (max-width:720px){
    .row{ grid-template-columns: 1fr; }
  }

  label{
    font-size:13px;
    font-weight:900;
    color:#0f172a;
    display:block;
    margin:6px 0;
  }
  input, select{
    width:100%;
    padding:14px 14px;
    border-radius:14px;
    border:1px solid #cbd5e1;
    font-size:16px;
    outline:none;
    background:#fff;
  }
  input:focus, select:focus{
    border-color: rgba(99,102,241,.7);
    box-shadow: 0 0 0 4px var(--ring);
  }

  .subline{
    margin:8px 0 0;
    color:var(--muted);
    font-size:14px;
    font-weight:700;
  }
  .now{
    margin:6px 0 0;
    font-weight:900;
    color:#2563eb;
    font-size:14px;
  }

  .slotsTitle{
    margin:14px 0 10px;
    font-weight:900;
    color:#0b1220;
    font-size:16px;
  }
  .times{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
    gap:10px;
  }
  .slot{
    padding:14px 12px;
    border-radius:16px;
    border:1px solid var(--slotBorder);
    background:var(--slotBg);
    cursor:pointer;
    font-weight:900;
    color:#065f46;
    text-align:center;
    user-select:none;
    transition:transform .1s ease, box-shadow .1s ease;
  }
  .slot:hover{ transform: translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.08); }
  .slot.active{
    background:var(--slotActiveBg);
    border-color:var(--slotActiveBorder);
    color:#1e1b4b;
    box-shadow: 0 0 0 4px rgba(99,102,241,.18);
  }
  .slot.disabled{
    background:var(--slotDisabledBg);
    border-color:var(--slotDisabledBorder);
    color:var(--slotDisabledText);
    cursor:not-allowed;
    box-shadow:none;
    transform:none;
  }

  .confirm{
    background:#020617;
    margin-top:16px;
    border-radius:18px;
  }

  .msg{
    margin-top:12px;
    border-radius:14px;
    padding:12px 12px;
    font-weight:900;
    display:none;
  }
  .msg.ok{ display:block; background:var(--okBg); color:var(--okText); border:1px solid var(--okBorder); }
  .msg.bad{ display:block; background:var(--badBg); color:var(--badText); border:1px solid var(--badBorder); }
  .msg.warn{ display:block; background:var(--warnBg); color:var(--warnText); border:1px solid var(--warnBorder); }

  .confirmCard{
    display:none;
    margin-top:18px;
    border:1px solid #e5e7eb;
    border-radius:22px;
    padding:16px;
    background:#fff;
  }
  .confirmCard.show{ display:block; }
  .confirmHead{
    display:flex;
    gap:12px;
    align-items:center;
    padding:10px 10px 14px;
    border-bottom:1px solid #e5e7eb;
  }
  .check{
    width:44px;height:44px;border-radius:16px;
    background:var(--okBg);
    border:1px solid var(--okBorder);
    display:flex;align-items:center;justify-content:center;
    font-weight:900;color:var(--okText);
    font-size:22px;
    flex:0 0 auto;
  }
  .confirmTitle{
    margin:0;
    font-size:18px;
    font-weight:900;
    color:#0b1220;
  }
  .confirmSub{
    margin:2px 0 0;
    color:#334155;
    font-weight:700;
    font-size:14px;
  }
  .grid2{
    margin-top:14px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media (max-width:720px){
    .grid2{ grid-template-columns: 1fr; }
  }
  .miniBox{
    border:1px solid #e5e7eb;
    border-radius:16px;
    padding:12px;
    background:#fff;
  }
  .miniLabel{
    color:#64748b;
    font-size:13px;
    font-weight:900;
    margin-bottom:6px;
  }
  .miniVal{
    color:#0f172a;
    font-size:15px;
    font-weight:900;
    word-break:break-word;
  }
  .actionsRow{
    margin-top:14px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .secondary{
    background:#fff;
    color:#0b1220;
    border:1px solid #cbd5e1;
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <img class="logo" src="logo.png" alt="Columbus East Tax Services" />

    <div class="contact">
      614-259-7625<br>
      614-599-1185
    </div>

    <button class="btn call" id="callBtn">üìû Call Now</button>
    <button class="btn text" id="textBtn">üí¨ Text Us</button>
    <button class="btn email" id="emailBtn">‚úâÔ∏è Email Us</button>

    <button class="btn book" id="toggleBtn">üìÖ Book Appointment</button>

    <div id="booking" class="booking">
      <div class="section">
        <div class="subline">Book an Appointment</div>
        <div class="now" id="nowLine"></div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>Full Name</label>
            <input id="fullName" placeholder="Your full name" />
          </div>
          <div>
            <label>Email Address</label>
            <input id="email" placeholder="you@example.com" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Select Service</label>
            <select id="service">
              <option>W-2 / Individual Taxes</option>
              <option>1099 / Self-Employed Taxes</option>
              <option>LLC / Small Business Filing</option>
              <option>Audit Help & IRS Letters</option>
              <option>Amended Returns (1040-X)</option>
            </select>
          </div>
          <div>
            <label>Location</label>
            <select id="location">
              <option>CML Whitehall Branch ‚Äî 4445 E Broad St, Columbus, OH 43213</option>
              <option>CML Reynoldsburg Branch ‚Äî 1402 Brice Rd, Reynoldsburg, OH 43068</option>
              <option>3434 East Livingston Ave</option>
              <option>3980 S Hamilton Rd, Groveport</option>
              <option>Online / Phone / Text</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Pick a Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label>Appointment Length</label>
            <select id="duration">
              <option value="60">60 minutes</option>
            </select>
          </div>
        </div>

        <div class="slotsTitle">Available Times</div>
        <div class="times" id="times"></div>

        <button class="btn confirm" id="confirmBtn" disabled>Confirm Booking</button>

        <div id="msg" class="msg"></div>

        <div id="confirmCard" class="confirmCard">
          <div class="confirmHead">
            <div class="check">‚úì</div>
            <div>
              <h3 class="confirmTitle">Booking Confirmed</h3>
              <div class="confirmSub">You are scheduled successfully.</div>
            </div>
          </div>

          <div class="grid2">
            <div class="miniBox">
              <div class="miniLabel">Client</div>
              <div class="miniVal" id="cName">‚Äî</div>
            </div>
            <div class="miniBox">
              <div class="miniLabel">Email</div>
              <div class="miniVal" id="cEmail">‚Äî</div>
            </div>
            <div class="miniBox">
              <div class="miniLabel">Date & Time</div>
              <div class="miniVal" id="cWhen">‚Äî</div>
            </div>
            <div class="miniBox">
              <div class="miniLabel">Service</div>
              <div class="miniVal" id="cService">‚Äî</div>
            </div>
            <div class="miniBox">
              <div class="miniLabel">Location</div>
              <div class="miniVal" id="cLoc">‚Äî</div>
            </div>
            <div class="miniBox">
              <div class="miniLabel">Status</div>
              <div class="miniVal" style="color:#166534;">Confirmed ‚úì</div>
            </div>
          </div>

          <div class="actionsRow">
            <button class="btn" id="bookAnotherBtn" type="button">üìÖ Book Another Appointment</button>
            <button class="btn secondary" id="backTopBtn" type="button">‚Üë Back to Top</button>
          </div>

          <div class="subline" style="margin-top:10px;">Need changes? Call or text us anytime.</div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = "https://zleztbdrxnqirccgkvqx.supabase.co";
const supabaseKey = "sb_publishable_pXXUCH_hx0eg7tUbQNz3rw_DaJgACMR";
const supa = window.supabase.createClient(supabaseUrl, supabaseKey);

const callBtn = document.getElementById("callBtn");
const textBtn = document.getElementById("textBtn");
const emailBtn = document.getElementById("emailBtn");

const toggleBtn = document.getElementById("toggleBtn");
const booking = document.getElementById("booking");

const nowLine = document.getElementById("nowLine");
const fullNameEl = document.getElementById("fullName");
const emailEl = document.getElementById("email");
const serviceEl = document.getElementById("service");
const locationEl = document.getElementById("location");
const dateEl = document.getElementById("date");
const durationEl = document.getElementById("duration");

const timesBox = document.getElementById("times");
const confirmBtn = document.getElementById("confirmBtn");
const msg = document.getElementById("msg");

const confirmCard = document.getElementById("confirmCard");
const cName = document.getElementById("cName");
const cEmail = document.getElementById("cEmail");
const cWhen = document.getElementById("cWhen");
const cService = document.getElementById("cService");
const cLoc = document.getElementById("cLoc");
const bookAnotherBtn = document.getElementById("bookAnotherBtn");
const backTopBtn = document.getElementById("backTopBtn");

callBtn.onclick = () => window.location.href = "tel:6142597625";
textBtn.onclick = () => window.location.href = "sms:6142597625";
emailBtn.onclick = () => window.location.href = "mailto:columbuseast.taxservices@outlook.com";

function setMsg(type, text){
  msg.className = "msg " + type;
  msg.textContent = text;
}
function pad(n){ return String(n).padStart(2, "0"); }
function todayYMD(){
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function parseSlotTo24h(slot){
  const [time, ampm] = slot.split(" ");
  let [h, m] = time.split(":").map(Number);
  const upper = (ampm || "").toUpperCase();
  if(upper === "PM" && h !== 12) h += 12;
  if(upper === "AM" && h === 12) h = 0;
  return { h, m };
}
function makeLocalDateTime(ymdStr, slot){
  const {h,m} = parseSlotTo24h(slot);
  const [Y,M,D] = ymdStr.split("-").map(Number);
  return new Date(Y, M-1, D, h, m, 0, 0);
}
function fmtNice(dt){
  return new Intl.DateTimeFormat("en-US", {
    weekday:"short", month:"short", day:"2-digit", year:"numeric",
    hour:"numeric", minute:"2-digit"
  }).format(dt);
}

const slots = [
  "10:00 AM","10:30 AM","11:00 AM","11:30 AM",
  "12:00 PM","12:30 PM","01:00 PM","01:30 PM",
  "02:00 PM","02:30 PM","03:00 PM","03:30 PM",
  "04:00 PM","04:30 PM","05:00 PM"
];

let selectedSlot = null;
let bookedTimesSet = new Set();
let refreshTimer = null;

function tick(){
  nowLine.textContent = "Current date & time: " + new Date().toLocaleString();
}
tick();
setInterval(tick, 1000);

toggleBtn.onclick = () => {
  booking.classList.toggle("open");
  if(booking.classList.contains("open")){
    if(!dateEl.value) dateEl.value = todayYMD();
    refreshAvailability();
  }
};

function isPastDate(ymdStr){
  const today = new Date(); today.setHours(0,0,0,0);
  const d = new Date(ymdStr + "T00:00:00"); d.setHours(0,0,0,0);
  return d < today;
}
function isToday(ymdStr){ return ymdStr === todayYMD(); }
function isPastTimeToday(ymdStr, slot){
  if(!isToday(ymdStr)) return false;
  const slotDT = makeLocalDateTime(ymdStr, slot);
  return slotDT <= new Date();
}

async function fetchBookedForDate(ymdStr){
  const start = new Date(ymdStr + "T00:00:00");
  const end = new Date(ymdStr + "T23:59:59");

  const { data, error } = await supa
    .from("appointments")
    .select("start_time, status")
    .gte("start_time", start.toISOString())
    .lte("start_time", end.toISOString());

  if(error){
    console.warn(error);
    setMsg("bad", "Could not load booked slots: " + error.message);
    return new Set();
  }

  const set = new Set();
  for(const row of (data || [])){
    const st = (row.status || "confirmed").toLowerCase();
    if(st === "cancelled") continue;

    const dt = new Date(row.start_time);
    const normalized = dt.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", hour12:true }).replace(/^0/,'');
    set.add(normalized);
  }
  return set;
}

function renderSlots(){
  timesBox.innerHTML = "";
  selectedSlot = null;
  confirmBtn.disabled = true;

  const d = dateEl.value;
  if(!d){
    setMsg("warn", "Pick a date to see available times.");
    return;
  }

  const pastDay = isPastDate(d);
  let anyAvailable = false;

  slots.forEach(slot => {
    const div = document.createElement("div");
    div.className = "slot";
    div.textContent = slot;

    const booked = bookedTimesSet.has(slot);
    const pastTime = isPastTimeToday(d, slot);
    const disabled = pastDay || booked || pastTime;

    if(disabled){
      div.classList.add("disabled");
    } else {
      anyAvailable = true;
      div.onclick = () => {
        document.querySelectorAll(".slot").forEach(x => x.classList.remove("active"));
        div.classList.add("active");
        selectedSlot = slot;
        validateReady();
      };
    }

    timesBox.appendChild(div);
  });

  if(pastDay) setMsg("warn", "That date is in the past. Please choose a future date.");
  else if(!anyAvailable) setMsg("warn", "No available times on this date (all booked or past). Try another day.");
  else setMsg("warn", "Pick a time, then press Confirm Booking.");
}

function validateEmail(v){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
}
function validateReady(){
  const nameOk = (fullNameEl.value || "").trim().length >= 2;
  const emailOk = validateEmail((emailEl.value || "").trim());
  const dateOk = !!dateEl.value && !isPastDate(dateEl.value);
  const timeOk = !!selectedSlot;
  confirmBtn.disabled = !(nameOk && emailOk && dateOk && timeOk);
}

async function refreshAvailability(){
  confirmCard.classList.remove("show");
  const d = dateEl.value;
  if(!d) return;

  setMsg("warn", "Loading availability‚Ä¶");
  bookedTimesSet = await fetchBookedForDate(d);
  renderSlots();
  validateReady();

  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(async () => {
    if(!booking.classList.contains("open")) return;
    bookedTimesSet = await fetchBookedForDate(dateEl.value);
    renderSlots();
  }, 15000);
}

/* ‚úÖ NEW: Prevent same client booking ANY other confirmed appt on the same day */
async function clientAlreadyBookedSameDay(clientEmail, ymdStr){
  const start = new Date(ymdStr + "T00:00:00");
  const end = new Date(ymdStr + "T23:59:59");

  const { data, error } = await supa
    .from("appointments")
    .select("id, status, start_time")
    .eq("client_email", clientEmail)
    .gte("start_time", start.toISOString())
    .lte("start_time", end.toISOString())
    .limit(1);

  if(error){
    console.warn(error);
    return { blocked:true, reason:"Could not verify existing bookings: " + error.message };
  }

  if((data || []).length){
    const st = (data[0].status || "confirmed").toLowerCase();
    if(st !== "cancelled"){
      const when = new Date(data[0].start_time);
      return { blocked:true, reason:"You already have an appointment on this date at " + fmtNice(when) + "." };
    }
  }
  return { blocked:false };
}

confirmBtn.onclick = async () => {
  const name = (fullNameEl.value || "").trim();
  const email = (emailEl.value || "").trim().toLowerCase();
  const service = serviceEl.value;
  const location = locationEl.value;
  const ymdStr = dateEl.value;

  if(!selectedSlot){
    setMsg("bad", "Please select a time slot.");
    return;
  }

  if(isPastDate(ymdStr) || isPastTimeToday(ymdStr, selectedSlot)){
    setMsg("bad", "That time is no longer available. Please pick another.");
    await refreshAvailability();
    return;
  }

  // Build times
  const startDT = makeLocalDateTime(ymdStr, selectedSlot);
  const durationMin = Number(durationEl.value || "60");
  const endDT = new Date(startDT.getTime() + durationMin * 60000);

  // ‚úÖ Block same client booking same day
  setMsg("warn", "Checking your existing bookings‚Ä¶");
  const dupDay = await clientAlreadyBookedSameDay(email, ymdStr);
  if(dupDay.blocked){
    setMsg("bad", dupDay.reason);
    return;
  }

  // Live re-check slot
  bookedTimesSet = await fetchBookedForDate(ymdStr);
  if(bookedTimesSet.has(selectedSlot)){
    setMsg("bad", "That slot was just booked by someone else. Pick another time.");
    await refreshAvailability();
    return;
  }

  setMsg("warn", "Booking‚Ä¶");
  const { error } = await supa.from("appointments").insert([{
    client_name: name,
    client_email: email,
    service,
    location,
    start_time: startDT.toISOString(),
    end_time: endDT.toISOString(),
    status: "confirmed"
  }]);

  if(error){
    console.warn(error);
    setMsg("bad", "Booking failed: " + error.message);
    return;
  }

  setMsg("ok", "‚úÖ Booking confirmed!");
  confirmCard.classList.add("show");

  cName.textContent = name;
  cEmail.textContent = email;
  cWhen.textContent = fmtNice(startDT);
  cService.textContent = service;
  cLoc.textContent = location;

  await refreshAvailability();
  confirmCard.scrollIntoView({ behavior:"smooth", block:"start" });
};

bookAnotherBtn.onclick = async () => {
  fullNameEl.value = "";
  emailEl.value = "";
  serviceEl.selectedIndex = 0;
  locationEl.selectedIndex = 0;
  dateEl.value = todayYMD();
  selectedSlot = null;
  confirmCard.classList.remove("show");
  await refreshAvailability();
  validateReady();
};

backTopBtn.onclick = () => window.scrollTo({ top:0, behavior:"smooth" });

[fullNameEl, emailEl, serviceEl, locationEl, durationEl].forEach(el => {
  el.addEventListener("input", validateReady);
  el.addEventListener("change", validateReady);
});
dateEl.addEventListener("change", async () => {
  selectedSlot = null;
  await refreshAvailability();
  validateReady();
});

dateEl.value = todayYMD();
renderSlots();
validateReady();
</script>
</body>
</html>

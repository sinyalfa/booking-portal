<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book an Appointment ‚Äì Columbus East Tax Services</title>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#111827;
      --card:rgba(255,255,255,.96);
      --muted:#6b7280;
      --text:#0f172a;
      --ring:rgba(99,102,241,.35);
      --accent:#4f46e5;

      --okBg:#dcfce7; --okText:#166534; --okBorder:#86efac;
      --badBg:#fee2e2; --badText:#991b1b; --badBorder:#fecaca;
      --infoBg:#dbeafe; --infoText:#1e3a8a; --infoBorder:#93c5fd;

      --slotBg:#ecfdf5;
      --slotBorder:#34d399;
      --slotText:#065f46;

      --slotSelBg:#e0e7ff;
      --slotSelBorder:#6366f1;
      --slotSelText:#111827;

      --btnDark1:#111827;
      --btnDark2:#0b1220;
      --btnGreen:#0f766e;
    }

    *{ box-sizing:border-box; }
    html, body{ width:100%; max-width:100%; overflow-x:hidden; }

    body{
      margin:0;
      padding:14px;
      font-family: Arial, Helvetica, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(79,70,229,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(16,185,129,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:#e5e7eb;
    }

    .wrap{
      width:100%;
      max-width:1100px;
      margin:0 auto;
      display:grid;
      gap:14px;
    }

    .grid{
      display:grid;
      grid-template-columns: minmax(0, 420px) minmax(0, 1fr);
      gap:14px;
      align-items:start;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      body{ padding:10px; }
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 20px;
      box-shadow: 0 20px 55px rgba(0,0,0,.35);
      padding:14px;
      color: var(--text);
      backdrop-filter: blur(8px);
      overflow:hidden;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      margin-bottom:10px;
    }
    .logo{
      width:52px;height:52px;border-radius:18px;
      background: linear-gradient(135deg, rgba(79,70,229,1), rgba(16,185,129,1));
      box-shadow: 0 14px 30px rgba(79,70,229,.35);
      flex:0 0 auto;
    }
    h1{ margin:0; font-size:28px; font-weight:900; letter-spacing:.2px; }
    h2{ margin:0; font-size:22px; font-weight:900; }
    .muted{ color: var(--muted); font-size:13px; line-height:1.45; }
    .bigmuted{ color:#334155; font-size:14px; line-height:1.5; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px;
      border: 1px solid transparent;
      white-space:nowrap;
    }
    .pill.ok{ background:var(--okBg); color:var(--okText); border-color:var(--okBorder); }
    .pill.bad{ background:var(--badBg); color:var(--badText); border-color:var(--badBorder); }
    .pill.info{ background:var(--infoBg); color:var(--infoText); border-color:var(--infoBorder); }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      width:100%;
      min-width:0;
      margin-top:10px;
    }

    label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:#111827;
      margin:12px 0 6px;
    }

    input, select, button{
      padding:12px 12px;
      border-radius:12px;
      border:1px solid #d1d5db;
      font-size:14px;
      outline:none;
      background:#fff;
      min-height:44px;
      width:100%;
      max-width:100%;
    }

    input:focus, select:focus{
      border-color: rgba(79,70,229,.55);
      box-shadow: 0 0 0 4px var(--ring);
    }

    .two{
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .two{ grid-template-columns:1fr; }
    }

    .btn{
      border:none;
      background: linear-gradient(135deg, var(--btnDark1), var(--btnDark2));
      color:#fff;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      transition: transform .12s ease, opacity .12s ease;
      min-height:50px;
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btnGreen{
      background: linear-gradient(135deg, var(--btnGreen), #0b1220);
    }

    .ctaCol{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:14px;
    }

    .slotGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 980px){
      .slotGrid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .slotGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .slot{
      border:1px solid var(--slotBorder);
      background: var(--slotBg);
      color: var(--slotText);
      font-weight:900;
      border-radius:16px;
      padding:14px 10px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      min-height:52px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .slot:hover{ transform: translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.08); }
    .slot.sel{
      background: var(--slotSelBg);
      border-color: var(--slotSelBorder);
      color: var(--slotSelText);
      box-shadow: 0 0 0 4px rgba(99,102,241,.18);
    }
    .slot.dis{
      opacity:.35;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
      background:#f8fafc;
      border-color:#e5e7eb;
      color:#64748b;
    }

    .note{
      margin-top:10px;
      font-size:13px;
      color:#334155;
    }

    .alert{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#f8fafc;
      font-weight:900;
      font-size:13px;
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .alert.ok{ background:var(--okBg); border-color:var(--okBorder); color:var(--okText); }
    .alert.bad{ background:var(--badBg); border-color:var(--badBorder); color:var(--badText); }
    .alert.info{ background:var(--infoBg); border-color:var(--infoBorder); color:var(--infoText); }

    .confirmCard{
      border:1px solid #e5e7eb;
      border-radius:18px;
      padding:14px;
      background:#fff;
      margin-top:12px;
    }
    .confirmTop{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .check{
      width:44px;height:44px;border-radius:16px;
      background:var(--okBg);
      border:1px solid var(--okBorder);
      color:var(--okText);
      display:flex;align-items:center;justify-content:center;
      font-size:22px;
      font-weight:900;
      flex:0 0 auto;
    }
    .confirmGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .confirmGrid{ grid-template-columns:1fr; }
    }
    .miniBox{
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:10px 12px;
      background:#f8fafc;
    }
    .miniLabel{ font-size:12px; color:#64748b; font-weight:900; }
    .miniValue{ margin-top:4px; font-weight:900; color:#0f172a; }

    a{ color:inherit; text-decoration:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <!-- LEFT INFO CARD -->
      <div class="card">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>Columbus East Tax Services</h1>
            <div class="muted">Columbus, Ohio 43227</div>
          </div>
        </div>

        <div class="bigmuted" style="display:grid; gap:6px; margin-top:8px;">
          <div>üìû <b><a href="tel:16145991185">614-599-1185</a></b></div>
          <div>üìû <b><a href="tel:16142597625">614-259-7625</a></b></div>
          <div>‚úâÔ∏è <b><a href="mailto:columbuseast.taxservices@outlook.com">columbuseast.taxservices@outlook.com</a></b></div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div style="font-weight:900; font-size:16px; margin-bottom:8px;">Services Offered</div>
          <ul class="bigmuted" style="margin:0; padding-left:18px; display:grid; gap:6px;">
            <li>W-2 &amp; Individual Tax Returns</li>
            <li>1099 &amp; Self-Employed Taxes</li>
            <li>LLC &amp; Small Business Filing</li>
            <li>Audit Help &amp; IRS Letters</li>
            <li>Amended Returns (1040-X)</li>
          </ul>
        </div>

        <div class="ctaCol">
          <a class="btn" href="tel:16145991185">üìû Call Now</a>
          <a class="btn btnGreen" href="sms:16145991185">üí¨ Text Us</a>
          <a class="btn" style="background:linear-gradient(135deg,#7c3aed,#0b1220)" href="mailto:columbuseast.taxservices@outlook.com">‚úâÔ∏è Email Us</a>
          <a class="btn" style="background:linear-gradient(135deg,#0f766e,#0b1220)" href="#book">üóìÔ∏è Book Appointment</a>
        </div>

        <div class="muted" style="margin-top:10px;">Tap to call, text, email, or book online.</div>
      </div>

      <!-- RIGHT BOOKING CARD -->
      <div class="card" id="book">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
          <div>
            <h2>Book an Appointment</h2>

            <!-- LIVE CURRENT DATE/TIME (ET) -->
            <div class="row" style="margin-top:6px;">
              <span class="pill info" id="currentDate">üìÖ Loading date‚Ä¶</span>
              <span class="pill info" id="currentTime">‚è∞ Loading time‚Ä¶</span>
            </div>

            <div class="muted">Pick a date, choose a time, and confirm.</div>
          </div>
          <span class="pill info" id="durationPill">60 minutes</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <span class="pill info" id="jsPill">JS: loading‚Ä¶</span>
          <span class="pill info" id="sbPill">Supabase: loading‚Ä¶</span>
        </div>

        <!-- FORM -->
        <div class="two" style="margin-top:10px;">
          <div>
            <label for="fullName">Full Name</label>
            <input id="fullName" type="text" placeholder="Your name" autocomplete="name" />
          </div>
          <div>
            <label for="email">Email Address</label>
            <input id="email" type="email" placeholder="you@email.com" autocomplete="email" />
          </div>
        </div>

        <div class="two">
          <div>
            <label for="service">Select Service</label>
            <select id="service">
              <option>W-2 / Individual Taxes</option>
              <option>1099 / Self-Employed</option>
              <option>LLC / Small Business Filing</option>
              <option>Audit Help</option>
              <option>Amended Returns (1040-X)</option>
            </select>
          </div>
          <div>
            <label for="location">Location</label>
            <select id="location">
              <!-- NEW LOCATION OPTION -->
              <option value="Online / Phone / Text Appointment">Online / Phone / Text Appointment</option>

              <option value="CML Whitehall Branch ‚Äî 4445 E Broad St, Columbus, OH 43213">CML Whitehall Branch ‚Äî 4445 E Broad St</option>
              <option value="CML Barnett Branch ‚Äî 3434 E Livingston Ave, Columbus, OH 43227">CML Barnett Branch ‚Äî 3434 E Livingston Ave</option>
              <option value="CML Reynoldsburg Branch ‚Äî 1402 Brice Rd, Reynoldsburg, OH 43068">CML Reynoldsburg Branch ‚Äî 1402 Brice Rd</option>
              <option value="CML Southeast Branch ‚Äî 3980 S Hamilton Rd, Groveport, OH 43125">CML Southeast Branch ‚Äî 3980 S Hamilton Rd</option>
            </select>
          </div>
        </div>

        <div>
          <label for="date">Pick a Date</label>
          <input id="date" type="date" />
          <div class="note" id="hoursNote">
            <b>Hours:</b><br>
            Mon‚ÄìFri: 9:00 AM‚Äì8:00 PM (Blocked 2:00‚Äì5:00 PM)<br>
            Sat: 10:00 AM‚Äì6:00 PM<br>
            Sun: 12:00 PM‚Äì6:00 PM
          </div>
        </div>

        <div style="margin-top:10px;">
          <div style="font-weight:900; font-size:14px; color:#0f172a;">Available Times</div>
          <div class="slotGrid" id="slotGrid"></div>
        </div>

        <button class="btn" id="confirmBtn" type="button" style="margin-top:14px;" disabled>
          Confirm Booking
        </button>

        <div id="msgBox"></div>

        <!-- AFTER NOTE (changes on success) -->
        <div id="afterNote" class="note" style="margin-top:10px;">
          Pick a time, then press Confirm Booking.
        </div>

        <!-- CONFIRMATION CARD (hidden until success) -->
        <div id="confirmCard" class="confirmCard" style="display:none;">
          <div class="confirmTop">
            <div class="check">‚úì</div>
            <div>
              <div style="font-weight:900; font-size:22px; color:#0f172a;">Booking Confirmed</div>
              <div class="muted" style="font-weight:900;">You are scheduled successfully.</div>
            </div>
          </div>

          <div class="confirmGrid" id="confirmGrid"></div>

          <div class="two" style="margin-top:12px;">
            <button class="btn btnGreen" id="bookAnotherBtn" type="button">üóìÔ∏è Book Another Appointment</button>
            <button class="btn" id="backTopBtn" type="button">‚¨Ü Back to Top</button>
          </div>

          <div class="muted" style="margin-top:10px;">Need changes? Call or text us anytime.</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ========= Supabase =========
    const supabaseUrl = "https://zleztbdrxnqirccgkvqx.supabase.co";
    const supabaseKey = "sb_publishable_pXXUCH_hx0eg7tUbQNz3rw_DaJgACMR";
    const supa = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ========= UI =========
    const jsPill = document.getElementById("jsPill");
    const sbPill = document.getElementById("sbPill");

    const fullNameEl = document.getElementById("fullName");
    const emailEl = document.getElementById("email");
    const serviceEl = document.getElementById("service");
    const locationEl = document.getElementById("location");
    const dateEl = document.getElementById("date");
    const slotGrid = document.getElementById("slotGrid");
    const confirmBtn = document.getElementById("confirmBtn");
    const msgBox = document.getElementById("msgBox");
    const afterNote = document.getElementById("afterNote");

    const confirmCard = document.getElementById("confirmCard");
    const confirmGrid = document.getElementById("confirmGrid");
    const bookAnotherBtn = document.getElementById("bookAnotherBtn");
    const backTopBtn = document.getElementById("backTopBtn");

    const currentDateEl = document.getElementById("currentDate");
    const currentTimeEl = document.getElementById("currentTime");

    const TZ = "America/New_York";
    const SLOT_MINUTES = 30;        // show every 30 min
    const DURATION_MINUTES = 60;    // appointment length

    let selectedStartISO = null;    // ISO string (UTC) that we insert
    let selectedLabel = "";         // nice time label

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setMsg(type, text){
      msgBox.innerHTML = "";
      if(!text) return;
      const div = document.createElement("div");
      div.className = "alert " + (type === "ok" ? "ok" : type === "bad" ? "bad" : "info");
      div.textContent = text;
      msgBox.appendChild(div);
    }

    function pad(n){ return String(n).padStart(2,"0"); }

    // ========= Live Clock (ET) =========
    function updateClock(){
      const now = new Date();

      const dateStr = now.toLocaleDateString("en-US", {
        timeZone: TZ,
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
      });

      const timeStr = now.toLocaleTimeString("en-US", {
        timeZone: TZ,
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      });

      currentDateEl.textContent = "üìÖ " + dateStr;
      currentTimeEl.textContent = "‚è∞ " + timeStr + " ET";
    }

    // Build a "local" date-time and convert to ISO UTC.
    // You already display in ET; this works fine for a simple booking portal.
    function buildStartISO(yyyy, mm, dd, hh, min){
      const d = new Date(yyyy, mm-1, dd, hh, min, 0, 0);
      return d.toISOString();
    }

    function addMinutesISO(iso, mins){
      const d = new Date(iso);
      d.setMinutes(d.getMinutes() + mins);
      return d.toISOString();
    }

    function fmtTimeLabel(hh, mm){
      const d = new Date(2000,0,1,hh,mm,0,0);
      return d.toLocaleTimeString("en-US", { hour:"2-digit", minute:"2-digit" });
    }

    // ========= Hours rules =========
    // Mon‚ÄìFri: 9‚Äì8 (but block 2‚Äì5)
    // Sat: 10‚Äì6
    // Sun: 12‚Äì6
    function getDailyWindows(dayOfWeek){
      // 0=Sun..6=Sat
      if(dayOfWeek >= 1 && dayOfWeek <= 5){
        return [
          { start:{h:9,m:0}, end:{h:14,m:0} },  // 9:00 -> 2:00
          { start:{h:17,m:0}, end:{h:20,m:0} }, // 5:00 -> 8:00
        ];
      }
      if(dayOfWeek === 6){
        return [{ start:{h:10,m:0}, end:{h:18,m:0} }];
      }
      // Sunday
      return [{ start:{h:12,m:0}, end:{h:18,m:0} }];
    }

    function generateSlotsForDate(dateObj){
      const dow = dateObj.getDay();
      const windows = getDailyWindows(dow);

      const slots = [];
      for(const w of windows){
        let h = w.start.h, m = w.start.m;

        while(true){
          const start = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), h, m, 0, 0);
          const end = new Date(start);
          end.setMinutes(end.getMinutes() + DURATION_MINUTES);

          const windowEnd = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), w.end.h, w.end.m, 0, 0);
          if(end > windowEnd) break;

          slots.push({ hh:h, mm:m, label: fmtTimeLabel(h,m) });

          const next = new Date(start);
          next.setMinutes(next.getMinutes() + SLOT_MINUTES);
          h = next.getHours();
          m = next.getMinutes();
        }
      }
      return slots;
    }

    function dayStartEndISO(dateObj){
      const start = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 0,0,0,0);
      const end = new Date(start);
      end.setDate(end.getDate()+1);
      return { startISO: start.toISOString(), endISO: end.toISOString() };
    }

    async function fetchBookedTimesForDate(dateObj){
      const { startISO, endISO } = dayStartEndISO(dateObj);

      const { data, error } = await supa
        .from("appointments")
        .select("start_time, status")
        .gte("start_time", startISO)
        .lt("start_time", endISO);

      if(error){
        setMsg("bad", error.message);
        return new Set();
      }

      const booked = new Set();
      for(const r of (data || [])){
        const st = (r.status || "confirmed").toLowerCase();
        if(st === "cancelled") continue;
        const d = new Date(r.start_time);
        booked.add(pad(d.getHours()) + ":" + pad(d.getMinutes()));
      }
      return booked;
    }

    function renderSlots(slots, bookedSet, dateObj){
      slotGrid.innerHTML = "";
      selectedStartISO = null;
      selectedLabel = "";
      confirmBtn.disabled = true;

      const now = new Date();

      for(const s of slots){
        const key = pad(s.hh) + ":" + pad(s.mm);
        const start = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), s.hh, s.mm, 0, 0);

        const isBooked = bookedSet.has(key);
        const isPast = start < now;

        const div = document.createElement("div");
        div.className = "slot" + (isBooked || isPast ? " dis" : "");
        div.textContent = s.label;

        if(!(isBooked || isPast)){
          div.addEventListener("click", () => {
            Array.from(slotGrid.children).forEach(el => el.classList.remove("sel"));
            div.classList.add("sel");

            selectedLabel = s.label;

            const yyyy = dateObj.getFullYear();
            const mm = dateObj.getMonth()+1;
            const dd = dateObj.getDate();
            selectedStartISO = buildStartISO(yyyy, mm, dd, s.hh, s.mm);

            confirmBtn.disabled = false;
            setMsg("", "");
          });
        }

        slotGrid.appendChild(div);
      }

      if(!slots.length){
        slotGrid.innerHTML = `<div class="muted">No slots for this day.</div>`;
      }
    }

    async function refreshSlots(){
      setMsg("", "");
      confirmCard.style.display = "none";
      afterNote.textContent = "Pick a time, then press Confirm Booking.";

      const val = dateEl.value;
      if(!val){
        slotGrid.innerHTML = `<div class="muted">Select a date to see times.</div>`;
        confirmBtn.disabled = true;
        return;
      }

      const [yyyy, mm, dd] = val.split("-").map(Number);
      const dateObj = new Date(yyyy, mm-1, dd, 0,0,0,0);

      const slots = generateSlotsForDate(dateObj);
      const booked = await fetchBookedTimesForDate(dateObj);
      renderSlots(slots, booked, dateObj);
    }

    function niceDateTimeFromISO(iso){
      return new Intl.DateTimeFormat("en-US", {
        timeZone: TZ,
        weekday: "short",
        month: "short",
        day: "numeric",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      }).format(new Date(iso));
    }

    function showConfirmationCard(payload){
      const rows = [
        { label: "Client", value: payload.client_name },
        { label: "Email", value: payload.client_email },
        { label: "Date & Time", value: niceDateTimeFromISO(payload.start_time) },
        { label: "Service", value: payload.service },
        { label: "Location", value: payload.location },
        { label: "Status", value: "Confirmed ‚úÖ" },
      ];

      confirmGrid.innerHTML = rows.map(r => `
        <div class="miniBox">
          <div class="miniLabel">${escapeHtml(r.label)}</div>
          <div class="miniValue">${escapeHtml(r.value)}</div>
        </div>
      `).join("");

      confirmCard.style.display = "block";
      afterNote.textContent = "‚úÖ Confirmed. Check your email or contact us if you need changes.";
    }

    // ========= Booking =========
    confirmBtn.addEventListener("click", async () => {
      setMsg("", "");

      const client_name = (fullNameEl.value || "").trim();
      const client_email = (emailEl.value || "").trim();
      const service = serviceEl.value;
      const location = locationEl.value;

      if(!client_name){ setMsg("bad","Please enter your full name."); return; }
      if(!client_email || !client_email.includes("@")){ setMsg("bad","Please enter a valid email address."); return; }
      if(!dateEl.value){ setMsg("bad","Please pick a date."); return; }
      if(!selectedStartISO){ setMsg("bad","Please select an available time."); return; }

      confirmBtn.disabled = true;
      setMsg("info", "Booking‚Ä¶");

      const end_time = addMinutesISO(selectedStartISO, DURATION_MINUTES);

      const insertPayload = {
        client_name,
        client_email,
        service,
        location,
        start_time: selectedStartISO,
        end_time,
        status: "confirmed"
      };

      const { data, error } = await supa
        .from("appointments")
        .insert([insertPayload])
        .select("client_name, client_email, service, location, start_time, end_time, status")
        .single();

      if(error){
        setMsg("bad", error.message);
        confirmBtn.disabled = false;
        return;
      }

      setMsg("ok", "‚úÖ Booking confirmed! See you then.");
      showConfirmationCard(data || insertPayload);

      await refreshSlots();
    });

    // ========= Buttons =========
    bookAnotherBtn.addEventListener("click", async () => {
      confirmCard.style.display = "none";
      setMsg("", "");
      fullNameEl.focus();
      await refreshSlots();
    });

    backTopBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // ========= Init =========
    async function init(){
      // Start clock
      updateClock();
      setInterval(updateClock, 1000);

      jsPill.textContent = "JS: loaded";
      jsPill.className = "pill ok";

      const { error } = await supa.from("appointments").select("start_time").limit(1);
      if(error){
        sbPill.textContent = "Supabase: error";
        sbPill.className = "pill bad";
        setMsg("bad", error.message);
      } else {
        sbPill.textContent = "Supabase: loaded";
        sbPill.className = "pill ok";
      }

      const now = new Date();
      dateEl.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;

      await refreshSlots();
    }

    dateEl.addEventListener("change", refreshSlots);

    init();
  </script>
</body>
</html>

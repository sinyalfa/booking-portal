<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Columbus East Tax Services ‚Äì Booking</title>
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#111827;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --ring:rgba(99,102,241,.35);

      --okBg:#dcfce7; --okText:#166534; --okBorder:#86efac;
      --badBg:#fee2e2; --badText:#991b1b; --badBorder:#fecaca;

      --slotAvailBg:#ecfdf5; --slotAvailText:#065f46; --slotAvailBorder:#6ee7b7;
      --slotTakenBg:#f3f4f6; --slotTakenText:#6b7280; --slotTakenBorder:#e5e7eb;

      --primary:#111827;
      --accent:#4f46e5;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:22px;
      font-family: Arial, Helvetica, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(79,70,229,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(16,185,129,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      color:#e5e7eb;
    }

    .wrap{
      max-width: 1040px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 920px){ .wrap{ grid-template-columns:1fr; } }

    .card{
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 18px;
      box-shadow: 0 20px 55px rgba(0,0,0,.35);
      padding:18px;
      color: var(--text);
      backdrop-filter: blur(8px);
    }

    .brand{ display:flex; gap:12px; align-items:center; margin-bottom:8px; }
    .logo{
      width:46px; height:46px; border-radius:14px;
      background: linear-gradient(135deg, rgba(79,70,229,1), rgba(16,185,129,1));
      box-shadow: 0 14px 30px rgba(79,70,229,.35);
    }
    h1{ font-size:20px; margin:0; }
    .muted{ color: var(--muted); font-size:13px; line-height:1.4; }

    .info{ margin:10px 0; color:#334155; line-height:1.5; }
    .btns{ display:grid; gap:10px; margin-top:12px; }
    .btns a{
      text-decoration:none;
      color:white;
      font-weight:900;
      padding:12px 14px;
      border-radius:12px;
      display:flex;
      justify-content:center;
      align-items:center;
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      transition: transform .12s ease, opacity .12s ease;
    }
    .btns a:hover{ transform: translateY(-1px); opacity:.96; }
    .btnCall{ background: linear-gradient(135deg, #2563eb, #1d4ed8); }
    .btnText{ background: linear-gradient(135deg, #16a34a, #15803d); }
    .btnEmail{ background: linear-gradient(135deg, #9333ea, #6d28d9); }

    .sectionTitle{ margin-top:14px; font-weight:900; font-size:14px; color:#0f172a; }
    ul.services{ margin:8px 0 0 0; padding-left:18px; color:#334155; }
    ul.services li{ margin:6px 0; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px;
      border: 1px solid transparent;
    }
    .pill.ok{ background:var(--okBg); color:var(--okText); border-color:var(--okBorder); }
    .pill.bad{ background:var(--badBg); color:var(--badText); border-color:var(--badBorder); }

    .bookingTitle{ font-size:18px; font-weight:900; margin:0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0; }
    input, select, button{
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{
      border-color: rgba(79,70,229,.55);
      box-shadow: 0 0 0 4px var(--ring);
    }
    input, select{ flex:1; min-width:220px; }
    button{
      border:none;
      background: linear-gradient(135deg, #111827, #0b1220);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      transition: transform .12s ease, opacity .12s ease;
    }
    button:hover{ transform: translateY(-1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .slotWrap{ margin-top: 12px; }
    .slotHeader{
      display:flex; justify-content:space-between; gap:10px;
      flex-wrap:wrap; align-items:center;
      margin-top: 4px;
    }
    .slotHeader .nav{ display:flex; gap:8px; }
    .secondary{
      background:#fff;
      border:1px solid #d1d5db;
      color:#111827;
      font-weight:900;
      box-shadow:none;
    }

    .legend{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .legend .tag{
      font-size:12px; font-weight:900; border-radius:999px;
      padding:6px 10px; border:1px solid transparent;
    }
    .tag.avail{ background:var(--slotAvailBg); color:var(--slotAvailText); border-color:var(--slotAvailBorder); }
    .tag.taken{ background:var(--slotTakenBg); color:var(--slotTakenText); border-color:var(--slotTakenBorder); }

    .slots{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 900px){ .slots{ grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 520px){ .slots{ grid-template-columns: repeat(2, 1fr); } }

    .slot{
      border-radius: 14px;
      padding: 12px 10px;
      text-align:center;
      font-weight: 900;
      border: 1px solid;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .slot.avail{
      background: var(--slotAvailBg);
      color: var(--slotAvailText);
      border-color: var(--slotAvailBorder);
      cursor:pointer;
    }
    .slot.avail:hover{ transform: translateY(-1px); box-shadow:0 12px 22px rgba(16,185,129,.18); }
    .slot.active{
      background: linear-gradient(135deg, #111827, #0b1220);
      color:#fff;
      border-color: #111827;
      box-shadow: 0 16px 30px rgba(17,24,39,.25);
    }
    .slot.taken{
      background: var(--slotTakenBg);
      color: var(--slotTakenText);
      border-color: var(--slotTakenBorder);
      cursor:not-allowed;
      opacity:.85;
    }

    .confirmBox{
      margin-top: 14px;
      padding: 14px;
      border-radius: 16px;
      border:1px solid #e5e7eb;
      background: #fafafa;
    }
    .manageLink{
      word-break: break-all;
      color: var(--accent);
      font-weight: 900;
      text-decoration: none;
    }
  </style>
</head>
<body>

  <div class="wrap">
    <!-- Business Card -->
    <div class="card">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Columbus East Tax Services</h1>
          <div class="muted">Columbus, Ohio 43227</div>
        </div>
      </div>

      <div class="info">
        üìû <b>614-599-1185</b><br />
        üìû <b>614-259-7625</b>
      </div>

      <div class="info">
        ‚úâÔ∏è <b>Columbuseast.taxservices@outlook.com</b>
      </div>

      <div class="btns">
        <a class="btnCall" href="tel:16145991185">Call</a>
        <a class="btnText" href="sms:16145991185">Text</a>
        <a class="btnEmail" href="mailto:Columbuseast.taxservices@outlook.com">Email</a>
      </div>

      <div class="sectionTitle">Services</div>
      <ul class="services">
        <li>W-2 Tax Filing</li>
        <li>1099 / Self-Employed</li>
        <li>LLC / Small Business Taxes</li>
        <li>Audit Help / IRS Letters</li>
        <li>Tax Planning</li>
        <li>Amended Returns</li>
      </ul>

      <div style="margin-top:12px;">
        <div class="pill ok">Business Hours Rules</div>
        <div class="muted" style="margin-top:8px;">
          <b>Mon‚ÄìFri:</b> 10:00 AM‚Äì2:00 PM and 5:00 PM‚Äì8:00 PM<br/>
          <b>Sat‚ÄìSun:</b> 9:00 AM‚Äì8:00 PM
        </div>
      </div>
    </div>

    <!-- Booking Portal -->
    <div class="card">
      <div class="bookingTitle">Book an Appointment</div>
      <div class="muted" style="margin-top:6px;">
        Appointments are <b>60 minutes</b>. Only valid times are shown (blocked times are hidden).
      </div>

      <div class="row" style="margin-top:12px;">
        <input id="name" type="text" placeholder="Full Name" aria-label="Full Name" />
        <input id="email" type="email" placeholder="Email Address" aria-label="Email Address" />
      </div>

      <div class="row">
        <select id="service" aria-label="Service">
          <option value="W-2 Tax Filing">W-2 Tax Filing</option>
          <option value="1099 / Self-Employed">1099 / Self-Employed</option>
          <option value="LLC / Small Business Taxes">LLC / Small Business Taxes</option>
          <option value="Audit Help / IRS Letters">Audit Help / IRS Letters</option>
          <option value="Tax Planning">Tax Planning</option>
          <option value="Amended Returns">Amended Returns</option>
        </select>
      </div>

      <div class="slotWrap">
        <div class="slotHeader">
          <div class="muted" id="rangeLabel"></div>
          <div class="nav">
            <button class="secondary" id="prevDay" type="button">‚óÄ</button>
            <button class="secondary" id="todayBtn" type="button">Today</button>
            <button class="secondary" id="nextDay" type="button">‚ñ∂</button>
          </div>
        </div>

        <div class="legend">
          <div class="tag avail">Available</div>
          <div class="tag taken">Booked</div>
        </div>

        <div class="slots" id="slots"></div>
      </div>

      <div class="row" style="margin-top:14px;">
        <button id="bookBtn" type="button" disabled>Confirm Booking</button>
      </div>

      <div id="status" class="muted" style="margin-top:8px;"></div>

      <div id="confirmBox" class="confirmBox" style="display:none;">
        <div class="pill ok">Booked</div>
        <div style="margin-top:10px;">
          <div><b>Appointment Confirmed!</b></div>
          <div class="muted" id="confirmText" style="margin-top:6px;"></div>
          <div class="muted" style="margin-top:10px;">
            Manage/Cancel link:
            <a class="manageLink" id="manageUrl" href="#" target="_blank" rel="noopener noreferrer"></a>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== SETTINGS ======
    const APPOINTMENT_MINUTES = 60;
    const SLOT_MINUTES = 30;

    // Supabase
    const supabaseUrl = "https://zleztbdrxnqirccgkvqx.supabase.co";
    const supabaseKey = "sb_publishable_pXXUCH_hx0eg7tUbQNz3rw_DaJgACMR";
    const supa = window.supabase.createClient(supabaseUrl, supabaseKey);

    // UI
    const nameEl = document.getElementById("name");
    const emailEl = document.getElementById("email");
    const serviceEl = document.getElementById("service");
    const slotsEl = document.getElementById("slots");
    const rangeLabel = document.getElementById("rangeLabel");
    const bookBtn = document.getElementById("bookBtn");
    const statusEl = document.getElementById("status");
    const confirmBox = document.getElementById("confirmBox");
    const confirmText = document.getElementById("confirmText");
    const manageUrlEl = document.getElementById("manageUrl");
    const prevDayBtn = document.getElementById("prevDay");
    const nextDayBtn = document.getElementById("nextDay");
    const todayBtn = document.getElementById("todayBtn");

    // State
    let selectedDate = new Date();
    selectedDate.setHours(0,0,0,0);
    let selectedSlotISO = null;

    function fmtDay(d){
      return d.toLocaleDateString([], { weekday:"short", month:"short", day:"2-digit", year:"numeric" });
    }
    function fmtTime(d){
      return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
    }

    // === RULES ===
    function getDayRules(dateObj){
      const dow = dateObj.getDay(); // 0 Sun, 6 Sat
      const isWeekend = (dow === 0 || dow === 6);

      if (isWeekend) {
        return { allowedStartHour: 9, allowedEndHour: 20, breakStartHour: null, breakEndHour: null };
      }
      return { allowedStartHour: 10, allowedEndHour: 20, breakStartHour: 14, breakEndHour: 17 };
    }

    function isAllowedStart(startDateObj, rules){
      const end = new Date(startDateObj.getTime() + APPOINTMENT_MINUTES * 60 * 1000);
      const startH = startDateObj.getHours() + startDateObj.getMinutes()/60;
      const endH   = end.getHours() + end.getMinutes()/60;

      if (startH < rules.allowedStartHour) return false;
      if (endH > rules.allowedEndHour) return false;

      if (rules.breakStartHour != null) {
        const bs = new Date(startDateObj); bs.setHours(rules.breakStartHour, 0,0,0);
        const be = new Date(startDateObj); be.setHours(rules.breakEndHour, 0,0,0);
        // overlap check
        if (startDateObj < be && end > bs) return false;
      }

      return true;
    }

    async function fetchBookedSlotsForDay(dayStart) {
      const dayEnd = new Date(dayStart);
      dayEnd.setDate(dayEnd.getDate() + 1);

      const { data, error } = await supa
        .from("appointments")
        .select("start_time, status")
        .gte("start_time", dayStart.toISOString())
        .lt("start_time", dayEnd.toISOString());

      if (error) {
        console.warn(error);
        return new Set();
      }

      const taken = new Set();
      for (const r of (data || [])) {
        const status = (r.status || "confirmed").toLowerCase();
        if (status !== "cancelled") {
          taken.add(new Date(r.start_time).toISOString());
        }
      }
      return taken;
    }

    function validateForm() {
      const name = nameEl.value.trim();
      const email = emailEl.value.trim();
      const ok = name.length >= 2 && email.includes("@") && selectedSlotISO;
      bookBtn.disabled = !ok;
    }

    nameEl.addEventListener("input", validateForm);
    emailEl.addEventListener("input", validateForm);
    serviceEl.addEventListener("change", validateForm);

    prevDayBtn.onclick = async () => { selectedDate.setDate(selectedDate.getDate() - 1); await renderSlots(); };
    nextDayBtn.onclick = async () => { selectedDate.setDate(selectedDate.getDate() + 1); await renderSlots(); };
    todayBtn.onclick = async () => { selectedDate = new Date(); selectedDate.setHours(0,0,0,0); await renderSlots(); };

    async function renderSlots() {
      confirmBox.style.display = "none";
      statusEl.textContent = "";
      selectedSlotISO = null;
      bookBtn.disabled = true;

      const rules = getDayRules(selectedDate);
      const dow = selectedDate.getDay();
      const isWeekend = (dow === 0 || dow === 6);

      rangeLabel.textContent =
        `${fmtDay(selectedDate)} ‚Ä¢ ${isWeekend ? "Weekend 9AM‚Äì8PM" : "Weekdays 10‚Äì2 & 5‚Äì8"}`;

      const dayStart = new Date(selectedDate);
      const taken = await fetchBookedSlotsForDay(dayStart);

      // Generate ONLY allowed slots (blocked slots hidden)
      const slots = [];

      // Earliest start candidate = allowedStartHour:00
      const cur = new Date(dayStart);
      cur.setHours(rules.allowedStartHour, 0, 0, 0);

      // Iterate in 30-min steps until end boundary
      while (true) {
        if (!isAllowedStart(cur, rules)) {
          // If we're before end boundary but blocked (break overlap), just step forward
          // Stop only when even the earliest possible start would end after allowedEndHour
          const testEnd = new Date(cur.getTime() + APPOINTMENT_MINUTES * 60 * 1000);
          const endH = testEnd.getHours() + testEnd.getMinutes()/60;
          if (endH > rules.allowedEndHour) break;
          cur.setMinutes(cur.getMinutes() + SLOT_MINUTES);
          continue;
        }

        const iso = cur.toISOString();
        slots.push({
          iso,
          label: fmtTime(cur),
          taken: taken.has(iso)
        });

        cur.setMinutes(cur.getMinutes() + SLOT_MINUTES);

        const nextEnd = new Date(cur.getTime() + APPOINTMENT_MINUTES * 60 * 1000);
        const nextEndH = nextEnd.getHours() + nextEnd.getMinutes()/60;
        if (nextEndH > rules.allowedEndHour) break;
      }

      if (!slots.length) {
        slotsEl.innerHTML = `<div class="muted">No available times for this day.</div>`;
        return;
      }

      slotsEl.innerHTML = slots.map(s => {
        const kind = s.taken ? "taken" : "avail";
        return `<div class="slot ${kind}" data-iso="${s.iso}" data-kind="${kind}">${s.label}</div>`;
      }).join("");

      slotsEl.querySelectorAll(".slot").forEach(el => {
        el.addEventListener("click", () => {
          const kind = el.getAttribute("data-kind");
          if (kind !== "avail") return;

          slotsEl.querySelectorAll(".slot").forEach(x => x.classList.remove("active"));
          el.classList.add("active");
          selectedSlotISO = el.getAttribute("data-iso");
          validateForm();
        });
      });
    }

    bookBtn.onclick = async () => {
      statusEl.innerHTML = `<span class="pill ok">Submitting‚Ä¶</span>`;
      bookBtn.disabled = true;

      const client_name = nameEl.value.trim();
      const client_email = emailEl.value.trim();
      const service = serviceEl.value;

      const start = new Date(selectedSlotISO);
      const rules = getDayRules(start);

      // HARD BLOCK
      if (!isAllowedStart(start, rules)) {
        statusEl.innerHTML = `<span class="pill bad">Not allowed</span> Please choose a valid time.`;
        validateForm();
        return;
      }

      const startISO = start.toISOString();
      const endISO = new Date(start.getTime() + APPOINTMENT_MINUTES * 60 * 1000).toISOString();

      const { data, error } = await supa
        .from("appointments")
        .insert([{
          client_name,
          client_email,
          service,
          start_time: startISO,
          end_time: endISO,
          status: "confirmed"
        }])
        .select("id, client_name, client_email, service, start_time")
        .single();

      if (error) {
        console.error(error);
        statusEl.innerHTML = `<span class="pill bad">Error</span> ${error.message}`;
        validateForm();
        return;
      }

      const manageLink = new URL("manage.html", window.location.href);
      manageLink.searchParams.set("id", data.id);
      manageLink.searchParams.set("email", client_email);

      statusEl.innerHTML = `<span class="pill ok">Success</span> Appointment booked.`;
      confirmBox.style.display = "block";
      confirmText.textContent = `${data.client_name} ‚Ä¢ ${data.service} ‚Ä¢ ${fmtDay(new Date(data.start_time))} at ${fmtTime(new Date(data.start_time))}`;
      manageUrlEl.textContent = manageLink.toString();
      manageUrlEl.href = manageLink.toString();

      await renderSlots();
    };

    renderSlots();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Columbus East Tax Services ‚Äì Booking Portal</title>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }

    body{
      font-family: Arial, Helvetica, sans-serif;
      color:#fff;
      overflow-x:hidden;
      background: radial-gradient(circle at 30% 20%, #0b1a3c, #020617 70%);
      position:relative;
    }

    /* STARFIELD CANVAS */
    canvas#starfield{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      z-index:-4;
      display:block;
    }

    .wrap{
      width:min(980px, 100%);
      margin:0 auto;
      padding:22px;
      position:relative;
      z-index:5;
    }

    .card{
      position:relative;
      width:100%;
      background: linear-gradient(180deg, rgba(210, 235, 255, 0.26), rgba(170, 215, 255, 0.18));
      border-radius:28px;
      border:1px solid rgba(210, 235, 255, 0.38);
      box-shadow:0 32px 90px rgba(0,0,0,0.62);
      padding:36px 24px 28px;
      text-align:center;
      color:#0b1220;
      backdrop-filter: blur(18px) saturate(185%);
      -webkit-backdrop-filter: blur(18px) saturate(185%);
      overflow:hidden;
    }

    /* glossy shine */
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(circle at 20% 0%, rgba(255,255,255,0.45), rgba(255,255,255,0.08) 45%, rgba(255,255,255,0) 70%),
        radial-gradient(circle at 80% 10%, rgba(59,130,246,0.20), rgba(59,130,246,0) 60%);
      pointer-events:none;
      z-index:3;
    }
    .card > *{ position:relative; z-index:4; }

    /* ============================================================
       EARTH + CASH (BEHIND DARK GLASS)
       ============================================================ */
    .scene{
      position:absolute;
      inset:-40px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index:1;
      opacity:0.70;
      transform: translateZ(0);
    }

    /* dark glass ‚Äúblack circle‚Äù feel */
    .bg-dim{
      position:absolute;
      inset:0;
      z-index:2;
      pointer-events:none;
      background:
        radial-gradient(circle at 50% 45%,
          rgba(2,6,23,0.10),
          rgba(2,6,23,0.66) 62%,
          rgba(2,6,23,0.88) 100%);
      mix-blend-mode:multiply;
    }

    .earth-wrap{
      position:relative;
      width:min(92%, 760px);
      aspect-ratio:1/1;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      perspective: 1200px;
    }

    .earth-halo{
      position:absolute;
      inset:-6%;
      border-radius:50%;
      background: radial-gradient(circle, rgba(90,160,255,0.30), transparent 62%);
      opacity:0.9;
    }

    /* Earth (photo + continuous rotation illusion) */
    .earth{
      position:absolute;
      inset:0;
      border-radius:50%;
      background-image:url("https://upload.wikimedia.org/wikipedia/commons/9/97/The_Earth_seen_from_Apollo_17.jpg");
      background-repeat:repeat-x;
      background-size:220% 100%;
      background-position:0% 50%;
      animation:earthSpin 46s linear infinite;
      box-shadow:
        inset -160px 0 240px rgba(0,0,0,.92),
        inset 0 0 90px rgba(0,0,0,.32),
        0 0 120px rgba(59,130,246,.18);
      transform: translateZ(0);
    }

    @keyframes earthSpin{
      from{ background-position:0% 50% }
      to{ background-position:-220% 50% }
    }

    /* Bills ring */
    .money-layer{
      position:absolute;
      inset:-20%;
      border-radius:50%;
      transform-style: preserve-3d;
    }

    .bill{
      position:absolute;
      left:50%;
      top:50%;
      width:160px;
      height:70px;
      border-radius:10px;
      transform-style:preserve-3d;
      transform: translate(-50%,-50%);
      box-shadow:0 18px 30px rgba(0,0,0,.55);
      filter: contrast(1.10) saturate(1.10);
      will-change: transform;
      backface-visibility:hidden;
      -webkit-backface-visibility:hidden;
      overflow:hidden;
    }

    /* $100 bill image */
    .bill::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:10px;
      background-image:url("https://upload.wikimedia.org/wikipedia/commons/4/4e/US_%24100_Obverse.jpg");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      transform: scale(1.02);
    }

    /* glossy highlight */
    .bill::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:10px;
      background: linear-gradient(120deg, rgba(255,255,255,0.22), rgba(255,255,255,0) 58%);
      mix-blend-mode: screen;
      opacity:0.6;
      pointer-events:none;
    }

    /* BIG visible denomination overlay */
    .bill .denom{
      position:absolute;
      right:8px;
      bottom:6px;
      font-weight:900;
      font-size:24px;
      letter-spacing:0.5px;
      color:rgba(10, 100, 60, 0.95);
      text-shadow:
        0 2px 0 rgba(255,255,255,0.6),
        0 10px 18px rgba(0,0,0,0.55);
      background: rgba(255,255,255,0.22);
      border: 1px solid rgba(255,255,255,0.22);
      padding: 2px 8px;
      border-radius: 999px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    /* ============================================================
       HEADER + UI
       ============================================================ */
    .logo{
      width:360px;
      max-width:92%;
      display:block;
      margin:0 auto 14px;
      filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.18));
    }

    .clock-line{
      margin:10px auto 30px;
      max-width:420px;
      font-size:20px;
      font-weight:900;
      color:#e5f0ff;
      text-align:center;
      padding:10px 16px;
      border-radius:999px;
      background: radial-gradient(circle at 50% 0%, rgba(59,130,246,0.22), rgba(15,23,42,0.95));
      border:1px solid rgba(191,219,254,0.3);
      letter-spacing:0.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      animation:glowPulse 2.4s ease-in-out infinite;
    }

    @keyframes glowPulse{
      0%,100%{
        box-shadow:0 0 14px rgba(59,130,246,.55), 0 0 40px rgba(37,99,235,.45);
        transform:translateY(0);
      }
      50%{
        box-shadow:0 0 24px rgba(59,130,246,.85), 0 0 70px rgba(37,99,235,.75);
        transform:translateY(-1px);
      }
    }

    .btn{
      width:100%;
      padding:18px;
      margin:12px 0;
      border:none;
      border-radius:18px;
      font-size:18px;
      font-weight:900;
      color:#fff;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      box-shadow:0 10px 24px rgba(15,23,42,.5);
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 14px 30px rgba(15,23,42,.7)}
    .btn:active{transform:translateY(0); box-shadow:0 6px 16px rgba(15,23,42,.5)}
    .btn.call{background:#2563eb}
    .btn.text{background:#16a34a}
    .btn.email{background:#9333ea}
    .btn.book{background:#0f766e}

    .booking{
      margin-top:18px;
      text-align:left;
      max-height:0;
      overflow:hidden;
      transition:max-height .5s ease;
    }
    .booking.open{max-height:2600px}

    .section{
      margin-top:12px;
      border-radius:20px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      padding:16px;
    }
    .subline{font-size:15px;font-weight:900;color:#0f172a}
    .now{margin-top:4px;font-weight:700;font-size:13px;color:#2563eb}

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width:720px){ .row{grid-template-columns:1fr} }

    label{
      font-size:13px;
      font-weight:900;
      color:#0f172a;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .today-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      color:#0b1220;
      background:rgba(34,197,94,0.18);
      border:1px solid rgba(34,197,94,0.45);
    }

    input,select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid #cbd5e1;
      font-size:14px;
      outline:none;
    }
    input:focus,select:focus{
      border-color:rgba(37,99,235,0.85);
      box-shadow:0 0 0 3px rgba(96,165,250,0.4);
    }
    input.today{
      border-color:rgba(34,197,94,0.7);
      box-shadow:0 0 0 3px rgba(34,197,94,0.18), 0 0 18px rgba(34,197,94,0.18);
    }

    .slots-title{margin:16px 0 10px;font-weight:900;color:#0f172a;font-size:15px}
    .times{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(130px, 1fr));
      gap:10px;
    }
    .slot{
      padding:12px;
      border-radius:14px;
      border:1px solid #34d399;
      background:#ecfdf5;
      font-size:14px;
      font-weight:900;
      color:#065f46;
      text-align:center;
      cursor:pointer;
      transition:transform .1s ease, box-shadow .1s ease, background .1s ease;
    }
    .slot:hover{transform:translateY(-1px); box-shadow:0 8px 16px rgba(15,23,42,.12)}
    .slot.active{
      background:#c7d2fe;
      border-color:#6366f1;
      color:#1e1b4b;
      box-shadow:0 0 0 3px rgba(99,102,241,0.24);
    }
    .slot.disabled{
      background:#f1f5f9;
      border-color:#cbd5e1;
      color:#94a3b8;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .btn.confirm{ margin-top:16px; background:#020617; width:100%; }
    .btn.confirm:disabled{ opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }

    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:10px;
      font-size:13px;
      font-weight:900;
      display:none;
    }
    .msg.ok{display:block; background:#dcfce7; color:#166534; border:1px solid #86efac}
    .msg.bad{display:block; background:#fee2e2; color:#991b1b; border:1px solid #fecaca}
    .msg.warn{display:block; background:#fef3c7; color:#92400e; border:1px solid #fde68a}

    .confirm-card{
      display:none;
      margin-top:16px;
      border-radius:18px;
      border:1px solid #e5e7eb;
      background:#ffffff;
      padding:14px;
    }
    .confirm-card.show{display:block}
    .confirm-head{
      display:flex;
      align-items:center;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid #e5e7eb;
    }
    .check{
      width:40px;height:40px;border-radius:14px;
      background:#dcfce7;border:1px solid #86efac;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#166534;font-size:20px;
    }
    .confirm-title{font-size:17px;font-weight:900;color:#0f172a}
    .confirm-sub{font-size:13px;color:#475569;font-weight:700}

    .grid2{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
    .mini-box{
      border-radius:14px;border:1px solid #e5e7eb;
      padding:10px;background:#ffffff;
    }
    .mini-label{font-size:12px;font-weight:900;color:#64748b;margin-bottom:4px}
    .mini-val{font-size:14px;font-weight:900;color:#0f172a; word-break:break-word}

    @media (max-width:640px){
      .card{padding:28px 18px 20px}
      .clock-line{font-size:16px;padding:9px 10px}
      .bill{width:132px;height:58px}
      .bill .denom{font-size:20px}
    }
  </style>
</head>

<body>
  <canvas id="starfield"></canvas>

  <div class="wrap">
    <div class="card">

      <!-- Earth + Money background -->
      <div class="scene" aria-hidden="true">
        <div class="earth-wrap" id="earthWrap">
          <div class="earth-halo"></div>
          <div class="earth"></div>

          <div class="money-layer" id="moneyLayer"></div>
        </div>
      </div>
      <div class="bg-dim" aria-hidden="true"></div>

      <!-- Foreground UI -->
      <img class="logo" src="https://raw.githubusercontent.com/sinyalfa/booking-portal/main/logo11.png" alt="Columbus East Tax Services Logo" />
      <div id="clockLine" class="clock-line"></div>

      <button class="btn call" onclick="window.location='tel:6142597625'">üìû Call Now</button>
      <button class="btn text" onclick="window.location='sms:6142597625'">üí¨ Text Us</button>
      <button class="btn email" onclick="window.location='mailto:columbuseast.taxservices@outlook.com'">‚úâÔ∏è Email Us</button>

      <button class="btn book" id="toggleBtn">üìÖ Book Appointment</button>

      <div id="booking" class="booking">
        <div class="section">
          <div class="subline">Book an Appointment</div>
          <div id="nowLine" class="now"></div>

          <div class="row">
            <div>
              <label for="fullName">Full Name</label>
              <input id="fullName" placeholder="Your full name" />
            </div>
            <div>
              <label for="email">Email</label>
              <input id="email" placeholder="you@example.com" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="service">Service</label>
              <select id="service">
                <option>W-2 / Individual Taxes</option>
                <option>1099 / Self-Employed Taxes</option>
                <option>LLC / Small Business Filing</option>
                <option>Audit Help & IRS Letters</option>
                <option>Amended Returns (1040-X)</option>
              </select>
            </div>

            <div>
              <label for="location">Location</label>
              <select id="location">
                <option>CML Whitehall Branch ‚Äî 4445 E Broad St</option>
                <option>CML Reynoldsburg Branch ‚Äî 1402 Brice Rd</option>
                <option>CML Livingston Branch ‚Äî 3434 E Livingston Ave</option>
                <option>CML Groveport Branch ‚Äî 4980 S Hamilton Rd</option>
                <option>Online / Phone / Text</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="date">Date <span id="todayBadge" class="today-pill" style="display:none;">Today</span></label>
              <input id="date" type="date" />
            </div>
            <div>
              <label for="duration">Length</label>
              <select id="duration">
                <option value="60">60 minutes</option>
              </select>
            </div>
          </div>

          <div class="slots-title">Available Times</div>
          <div id="times" class="times"></div>

          <button id="confirmBtn" class="btn confirm" disabled>Confirm Booking</button>

          <div id="msg" class="msg"></div>

          <div id="confirmCard" class="confirm-card">
            <div class="confirm-head">
              <div class="check">‚úì</div>
              <div>
                <div class="confirm-title">Booking Confirmed</div>
                <div class="confirm-sub">Your appointment has been added to our schedule.</div>
              </div>
            </div>

            <div class="grid2">
              <div class="mini-box">
                <div class="mini-label">Client</div>
                <div id="cName" class="mini-val"></div>
              </div>
              <div class="mini-box">
                <div class="mini-label">Email</div>
                <div id="cEmail" class="mini-val"></div>
              </div>
              <div class="mini-box">
                <div class="mini-label">Date & Time</div>
                <div id="cWhen" class="mini-val"></div>
              </div>
              <div class="mini-box">
                <div class="mini-label">Service</div>
                <div id="cService" class="mini-val"></div>
              </div>
              <div class="mini-box">
                <div class="mini-label">Location</div>
                <div id="cLoc" class="mini-val"></div>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* ------------------------------------------------------------
       CLOCK
       ------------------------------------------------------------ */
    const clockLine = document.getElementById("clockLine");
    const nowLine = document.getElementById("nowLine");

    function updateClock() {
      const now = new Date();
      const datePart = new Intl.DateTimeFormat("en-US", {
        weekday: "short", month: "short", day: "2-digit", year: "numeric",
      }).format(now);

      const timePart = new Intl.DateTimeFormat("en-US", {
        hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false,
      }).format(now);

      clockLine.textContent = `${datePart} ‚Ä¢ ${timePart}`;
      nowLine.textContent = `Now: ${datePart} ‚Ä¢ ${timePart}`;
    }
    updateClock();
    setInterval(updateClock, 1000);

    /* ------------------------------------------------------------
       SUPABASE CONFIG
       ------------------------------------------------------------ */
    const SUPABASE_URL = "https://zleztbdrxnqirccgkvqx.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsZXp0YmRyeG5xaXJjY2drdnF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwODU5MjAsImV4cCI6MjA4MzY2MTkyMH0.k2BeeoNXCStyq5JqfGCEMYHhuPLN5LUSru9M-_HrOgs";

    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ------------------------------------------------------------
       BOOKING UI TOGGLE
       ------------------------------------------------------------ */
    const toggleBtn = document.getElementById("toggleBtn");
    const booking = document.getElementById("booking");

    toggleBtn.addEventListener("click", () => {
      booking.classList.toggle("open");
      if (booking.classList.contains("open")) {
        if (!dateEl.value) dateEl.value = todayYMD();
        refreshSlots();
      }
    });

    /* ------------------------------------------------------------
       UTILITIES
       ------------------------------------------------------------ */
    function pad(n) { return String(n).padStart(2, "0"); }
    function todayYMD() {
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }
    function fmtNice(dt) {
      return dt.toLocaleString("en-US", {
        weekday: "short", month: "short", day: "numeric",
        hour: "2-digit", minute: "2-digit", hour12: true,
      });
    }
    function makeLocalDateTimeFrom24(dateStr, hm) {
      const [H, M] = hm.split(":").map(Number);
      const [Y, m, D] = dateStr.split("-").map(Number);
      return new Date(Y, m - 1, D, H, M, 0, 0);
    }
    function isValidEmail(v) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }
    function getAllowedHours(dow) {
      if (dow >= 1 && dow <= 5) return [9, 10, 11, 12, 17, 18, 19, 20];
      if (dow === 6) return [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19];
      return [9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19];
    }
    function to12hLabel(hm) {
      let [H, M] = hm.split(":").map(Number);
      const ampm = H >= 12 ? "PM" : "AM";
      H = H % 12;
      if (H === 0) H = 12;
      return `${pad(H)}:${pad(M)} ${ampm}`;
    }

    /* ------------------------------------------------------------
       BOOKING LOGIC
       ------------------------------------------------------------ */
    const timesBox = document.getElementById("times");
    const confirmBtn = document.getElementById("confirmBtn");
    const msg = document.getElementById("msg");
    const confirmCard = document.getElementById("confirmCard");
    const todayBadge = document.getElementById("todayBadge");

    const fullNameEl = document.getElementById("fullName");
    const emailEl = document.getElementById("email");
    const serviceEl = document.getElementById("service");
    const locationEl = document.getElementById("location");
    const dateEl = document.getElementById("date");

    const cName = document.getElementById("cName");
    const cEmail = document.getElementById("cEmail");
    const cWhen = document.getElementById("cWhen");
    const cService = document.getElementById("cService");
    const cLoc = document.getElementById("cLoc");

    let selectedSlot = null;
    let bookedSet = new Set();

    function updateTodayHighlight() {
      const isToday = dateEl.value === todayYMD();
      todayBadge.style.display = isToday ? "inline-flex" : "none";
      dateEl.classList.toggle("today", isToday);
    }

    async function fetchBookedForDate(ymd) {
      const start = new Date(ymd + "T00:00:00");
      const end = new Date(ymd + "T23:59:59");

      const { data, error } = await supa
        .from("appointments")
        .select("start_time,status")
        .gte("start_time", start.toISOString())
        .lte("start_time", end.toISOString());

      if (error) {
        console.error("Fetch booked error:", error);
        return new Set();
      }

      const set = new Set();
      (data || []).forEach((row) => {
        if ((row.status || "").toLowerCase() === "cancelled") return;
        const dt = new Date(row.start_time);
        set.add(`${pad(dt.getHours())}:${pad(dt.getMinutes())}`);
      });
      return set;
    }

    async function refreshSlots() {
      const ymd = dateEl.value;
      timesBox.innerHTML = "";
      selectedSlot = null;
      confirmBtn.disabled = true;
      msg.className = "msg";
      msg.textContent = "";
      updateTodayHighlight();

      if (!ymd) {
        msg.className = "msg warn";
        msg.textContent = "Please pick a date.";
        return;
      }

      const dateObj = new Date(ymd + "T00:00:00");
      const dow = dateObj.getDay();
      const allowedHours = getAllowedHours(dow);

      bookedSet = await fetchBookedForDate(ymd);

      const now = new Date();
      let anyAvailable = false;

      allowedHours.forEach((H) => {
        const hm = `${pad(H)}:00`;
        const slotDate = makeLocalDateTimeFrom24(ymd, hm);
        const isPast = slotDate <= now;
        const isBooked = bookedSet.has(hm);

        const div = document.createElement("div");
        div.className = "slot";
        div.textContent = to12hLabel(hm);

        if (isBooked || isPast) {
          div.classList.add("disabled");
        } else {
          anyAvailable = true;
          div.addEventListener("click", () => {
            document.querySelectorAll(".slot").forEach((x) => x.classList.remove("active"));
            div.classList.add("active");
            selectedSlot = hm;
            validateForm();
          });
        }

        timesBox.appendChild(div);
      });

      if (!anyAvailable) {
        msg.className = "msg warn";
        msg.textContent = "No available times for this date.";
      } else {
        msg.className = "msg warn";
        msg.textContent = "Select a time to continue.";
      }
    }

    function validateForm() {
      const nameOk = (fullNameEl.value || "").trim().length > 1;
      const emailOk = isValidEmail((emailEl.value || "").trim());
      const slotOk = !!selectedSlot;
      confirmBtn.disabled = !(nameOk && emailOk && slotOk);
    }

    fullNameEl.addEventListener("input", validateForm);
    emailEl.addEventListener("input", validateForm);
    dateEl.addEventListener("change", () => { refreshSlots(); validateForm(); });

    async function hasSameDayBooking(email, ymd) {
      const start = new Date(ymd + "T00:00:00");
      const end = new Date(ymd + "T23:59:59");

      const { data, error } = await supa
        .from("appointments")
        .select("start_time,status")
        .eq("client_email", email)
        .gte("start_time", start.toISOString())
        .lte("start_time", end.toISOString());

      if (error) {
        console.error("Same-day check error:", error);
        return false;
      }
      return (data || []).some((row) => (row.status || "").toLowerCase() !== "cancelled");
    }

    confirmBtn.addEventListener("click", async () => {
      msg.className = "msg warn";
      msg.textContent = "Submitting your booking...";
      confirmBtn.disabled = true;

      const name = (fullNameEl.value || "").trim();
      const email = (emailEl.value || "").trim().toLowerCase();
      const service = serviceEl.value;
      const location = locationEl.value;
      const ymd = dateEl.value;

      if (!name || !isValidEmail(email) || !selectedSlot || !ymd) {
        msg.className = "msg bad";
        msg.textContent = "Please fill all fields and pick a time.";
        validateForm();
        return;
      }

      const already = await hasSameDayBooking(email, ymd);
      if (already) {
        msg.className = "msg bad";
        msg.textContent = "You already have an appointment booked for this day.";
        confirmBtn.disabled = false;
        return;
      }

      const startDT = makeLocalDateTimeFrom24(ymd, selectedSlot);
      const durationMin = parseInt(document.getElementById("duration").value, 10) || 60;
      const endDT = new Date(startDT.getTime() + durationMin * 60000);

      const { error } = await supa.from("appointments").insert([{
        client_name: name,
        client_email: email,
        service,
        location,
        start_time: startDT.toISOString(),
        end_time: endDT.toISOString(),
        status: "confirmed",
      }]);

      if (error) {
        console.error("Insert error:", error);
        msg.className = "msg bad";
        msg.textContent = "Booking failed. Please try again in a moment.";
        confirmBtn.disabled = false;
        return;
      }

      msg.className = "msg ok";
      msg.textContent = "Appointment confirmed! A staff member will review it.";

      confirmCard.classList.add("show");
      cName.textContent = name;
      cEmail.textContent = email;
      cWhen.textContent = fmtNice(startDT);
      cService.textContent = service;
      cLoc.textContent = location;

      await refreshSlots();
      validateForm();
    });

    dateEl.value = todayYMD();
    updateTodayHighlight();
    refreshSlots();
    validateForm();

    /* ------------------------------------------------------------
       CREATE 18 BILLS (ALL $100) + DENOM OVERLAY
       Change BILL_COUNT to 16..20 if you want.
       ------------------------------------------------------------ */
    const moneyLayer = document.getElementById("moneyLayer");
    const BILL_COUNT = 18;

    for (let i = 0; i < BILL_COUNT; i++) {
      const d = document.createElement("div");
      d.className = "bill";
      d.dataset.i = String(i);

      const denom = document.createElement("div");
      denom.className = "denom";
      denom.textContent = "100";
      d.appendChild(denom);

      moneyLayer.appendChild(d);
    }

    const earthWrap = document.getElementById("earthWrap");
    const bills = Array.from(document.querySelectorAll(".bill"));

    /* ------------------------------------------------------------
       MONEY ORBIT (ALTERNATING DIRECTIONS + FACING SCREEN)
       ------------------------------------------------------------ */
    const orbiters = bills.map((el, i) => {
      const dir = (i % 2 === 0) ? 1 : -1;              // alternate direction
      const baseAngle = (i / bills.length) * Math.PI * 2;
      const speed = (0.50 + (i % 6) * 0.05) * dir;     // varied
      const radius = 0.48 + (i % 4) * 0.03;            // varied
      const phase = Math.random() * Math.PI * 2;
      return { el, dir, baseAngle, speed, radius, phase };
    });

    function animateMoney(tms){
      const t = tms / 1000;

      const rect = earthWrap.getBoundingClientRect();
      const cx = rect.width / 2;
      const cy = rect.height / 2;

      const ellipseY = 0.62;
      const depthScale = 0.22;

      orbiters.forEach((o) => {
        const theta = o.baseAngle + t * o.speed;

        const r = rect.width * o.radius;
        const x = cx + Math.cos(theta) * r;
        const y = cy + Math.sin(theta) * r * ellipseY;

        const depth = (Math.sin(theta) + 1) / 2; // 0..1
        const scale = 0.86 + depth * depthScale;

        const bob = Math.sin(t * 2.1 + o.phase) * 12;    // px
        const swayZ = Math.sin(t * 1.4 + o.phase) * 6;   // deg
        const flipY = Math.sin(t * 1.7 + o.phase) * 10;  // deg
        const tiltX = Math.cos(t * 1.2 + o.phase) * 6;   // deg

        o.el.style.transform =
          `translate(${x}px, ${y + bob}px)` +
          ` translate(-50%, -50%)` +
          ` scale(${scale})` +
          ` rotateZ(${swayZ}deg)` +
          ` rotateX(${tiltX}deg)` +
          ` rotateY(${flipY}deg)`;

        o.el.style.zIndex = String(10 + Math.floor(depth * 20));
        o.el.style.opacity = String(0.55 + depth * 0.45);
      });

      requestAnimationFrame(animateMoney);
    }
    requestAnimationFrame(animateMoney);

    /* ------------------------------------------------------------
       STARFIELD + SHOOTING STARS (CANVAS)
       ------------------------------------------------------------ */
    const canvas = document.getElementById("starfield");
    const ctx = canvas.getContext("2d");

    let stars = [];
    let shootingStars = [];
    let width = window.innerWidth;
    let height = window.innerHeight;

    function resizeCanvas() {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
      initStars();
    }
    window.addEventListener("resize", resizeCanvas);

    function initStars() {
      const count = Math.min(260, Math.floor((width * height) / 11000));
      stars = [];
      for (let i = 0; i < count; i++) {
        stars.push({
          x: Math.random() * width,
          y: Math.random() * height,
          r: Math.random() * 1.5 + 0.35,
          o: Math.random(),
          tw: Math.random() * 2 + 1,
        });
      }
    }

    function spawnShootingStar() {
      const startX = Math.random() * width * 0.6;
      const startY = Math.random() * height * 0.3;
      const len = Math.random() * 260 + 140;

      shootingStars.push({
        x: startX,
        y: startY,
        vx: 6 + Math.random() * 4,
        vy: 3 + Math.random() * 3,
        life: 0,
        maxLife: 36 + Math.random() * 22,
        length: len,
      });
    }

    function drawStarfield() {
      ctx.clearRect(0, 0, width, height);

      // deep space background
      ctx.fillStyle = "rgba(2, 6, 23, 0.94)";
      ctx.fillRect(0, 0, width, height);

      const t = Date.now() * 0.001;
      for (const s of stars) {
        const pulse = 0.5 + 0.5 * Math.sin(t * s.tw + s.x);
        ctx.globalAlpha = s.o * pulse;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fillStyle = "#e5f2ff";
        ctx.fill();
      }
      ctx.globalAlpha = 1;

      // Shooting stars
      for (let i = shootingStars.length - 1; i >= 0; i--) {
        const sh = shootingStars[i];
        sh.life++;
        sh.x += sh.vx;
        sh.y += sh.vy;

        const p = sh.life / sh.maxLife;
        if (p >= 1) {
          shootingStars.splice(i, 1);
          continue;
        }

        const alpha = 1 - p;
        const tailX = sh.x - sh.vx * sh.length * 0.1;
        const tailY = sh.y - sh.vy * sh.length * 0.1;

        const grad = ctx.createLinearGradient(sh.x, sh.y, tailX, tailY);
        grad.addColorStop(0, `rgba(160, 210, 255, ${alpha})`);
        grad.addColorStop(1, "rgba(37, 99, 235, 0)");

        ctx.strokeStyle = grad;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(sh.x, sh.y);
        ctx.lineTo(tailX, tailY);
        ctx.stroke();
      }

      requestAnimationFrame(drawStarfield);
    }

    setInterval(() => { if (Math.random() < 0.75) spawnShootingStar(); }, 6500);

    resizeCanvas();
    drawStarfield();
  </script>
</body>
</html>

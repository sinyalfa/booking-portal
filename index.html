<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Columbus East Tax Services ‚Äì Booking</title>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; background:#f4f6f8; display:flex; justify-content:center; padding:30px; margin:0; }
    .container { max-width:420px; width:100%; background:#fff; padding:25px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.1); }
    h1 { text-align:center; margin-bottom:10px; color:#1f2933; }
    .contact { text-align:center; margin-bottom:18px; color:#4b5563; font-size:16px; }
    .contact a { display:block; color:#0066cc; text-decoration:none; margin:8px 0; font-weight:bold; word-break:break-word; }

    .services { background:#f1f3f5; padding:15px; border-radius:10px; margin:18px 0; }
    .services h3 { margin:0 0 10px 0; }
    .services li { margin:6px 0; }

    .action-btn {
      width:100%; padding:14px; margin-top:10px; border:none; border-radius:10px;
      font-size:16px; font-weight:bold; cursor:pointer; color:#fff;
      display:flex; justify-content:center; align-items:center;
    }
    .call { background:#2563eb; }
    .text { background:#16a34a; }
    .email { background:#9333ea; }
    .book { background:#0f766e; }

    #bookingForm { display:none; margin-top:18px; border-top:1px solid #e5e7eb; padding-top:16px; }
    #bookingForm label { display:block; margin-top:12px; font-weight:bold; }
    #bookingForm input, #bookingForm select {
      width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid #d1d5db;
    }
    #bookingForm button { margin-top:14px; width:100%; background:#0f766e; color:#fff; border:none; padding:12px; border-radius:10px; font-weight:bold; }

    #status { margin-top:10px; font-weight:bold; text-align:center; }
    .ok { color:#16a34a; }
    .bad { color:#dc2626; }

    #confirmBox {
      display:none; margin-top:18px; background:#f9fafb; padding:16px;
      border-radius:10px; border-top:1px solid #e5e7eb;
    }
    .confirm-row { margin:8px 0; }
    .confirm-small { font-size:13px; color:#6b7280; word-break:break-all; }
    .confirm-actions { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:14px; }
    .btn-lite { padding:12px; border-radius:10px; border:1px solid #d1d5db; background:#fff; font-weight:bold; }
    .btn-green { padding:12px; border-radius:10px; border:none; background:#16a34a; color:#fff; font-weight:bold; }
  </style>
</head>

<body>
<div class="container">

  <h1>Columbus East Tax Services</h1>

  <div class="contact">
    üìç Columbus, Ohio 43227
    <a href="tel:16145991185">üìû 614-599-1185</a>
    <a href="tel:16142597625">üìû 614-259-7625</a>
    <a href="mailto:columbuseast.taxservices@outlook.com">‚úâÔ∏è columbuseast.taxservices@outlook.com</a>
  </div>

  <div class="services">
    <h3>Services Offered</h3>
    <ul>
      <li>W-2 & Individual Returns</li>
      <li>1099 / Self-Employed</li>
      <li>LLC & Small Business</li>
      <li>Audit Help</li>
    </ul>
  </div>

  <a class="action-btn call" href="tel:16145991185">Call Now</a>
  <a class="action-btn text" href="sms:16145991185">Text Us</a>
  <a class="action-btn email" href="mailto:columbuseast.taxservices@outlook.com">Email Us</a>

  <button class="action-btn book" id="openBooking">Book Appointment</button>

  <!-- BOOKING FORM -->
  <form id="bookingForm">
    <label>Full Name</label>
    <input id="name" required />

    <label>Email</label>
    <input id="email" type="email" required />

    <label>Service</label>
    <select id="service" required>
      <option value="">Choose one</option>
      <option>W-2 / Individual</option>
      <option>1099 / Self-Employed</option>
      <option>LLC / Business</option>
      <option>Audit Help</option>
    </select>

    <label>Date & Time</label>
    <input id="time" type="datetime-local" required />

    <button type="submit">Confirm Booking</button>
    <div id="status"></div>
  </form>

  <!-- CONFIRMATION -->
  <div id="confirmBox">
    <h3>‚úÖ Booking Confirmed</h3>
    <div class="confirm-row"><b>Service:</b> <span id="c_service"></span></div>
    <div class="confirm-row"><b>Date:</b> <span id="c_time"></span></div>
    <div class="confirm-row"><b>Confirmation #</b></div>
    <div class="confirm-small" id="c_id"></div>

    <div class="confirm-row"><b>Manage / Cancel:</b></div>
    <div class="confirm-small" id="c_manage"></div>

    <div class="confirm-actions">
      <button class="btn-lite" id="bookAnother">Book Another</button>
      <a class="btn-green" id="manageBtn" target="_blank">View / Cancel</a>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://zleztbdrxnqirccgkvqx.supabase.co";
const supabaseKey = "sb_publishable_pXXUCH_hx0eg7tUbQNz3rw_DaJgACMR";

const supa = window.supabase.createClient(supabaseUrl, supabaseKey);

const openBooking = document.getElementById("openBooking");
const form = document.getElementById("bookingForm");
const statusEl = document.getElementById("status");
const confirmBox = document.getElementById("confirmBox");

openBooking.onclick = () => {
  form.style.display = form.style.display === "block" ? "none" : "block";
  confirmBox.style.display = "none";
};

form.onsubmit = async (e) => {
  e.preventDefault();
  statusEl.textContent = "Submitting...";
  statusEl.className = "";

  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  const service = document.getElementById("service").value;
  const time = document.getElementById("time").value;

  const startISO = new Date(time).toISOString();
  const endISO = new Date(new Date(time).getTime() + 60*60*1000).toISOString();
  const cancelToken = crypto.randomUUID();

  /* üî¥ THIS IS THE EXACT INSERT BLOCK YOU ASKED FOR */
  const { data, error } = await supa
    .from("appointments")
    .insert([{
      client_name: name,
      client_email: email,
      service: service,
      start_time: startISO,
      end_time: endISO,
      cancel_token: cancelToken,
      status: "confirmed"
    }])
    .select("id, service, start_time, end_time")
    .single();

  if (error) {
    statusEl.textContent = error.message;
    statusEl.className = "bad";
    return;
  }

  const manageLink = `${location.origin}${location.pathname.replace("index.html","")}manage.html?id=${data.id}&token=${cancelToken}`;

  /* ‚úÖ EMAIL FUNCTION CALL */
  fetch(`${supabaseUrl}/functions/v1/send-confirmation`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      client_name: name,
      client_email: email,
      service: data.service,
      start_time: data.start_time,
      end_time: data.end_time,
      appointment_id: data.id,
      manage_url: manageLink
    })
  }).catch(() => {});

  form.style.display = "none";
  confirmBox.style.display = "block";

  document.getElementById("c_service").textContent = data.service;
  document.getElementById("c_time").textContent = new Date(data.start_time).toLocaleString();
  document.getElementById("c_id").textContent = data.id;
  document.getElementById("c_manage").textContent = manageLink;
  document.getElementById("manageBtn").href = manageLink;

  form.reset();
};

document.getElementById("bookAnother").onclick = () => {
  confirmBox.style.display = "none";
  form.style.display = "block";
};
</script>
</body>
</html>

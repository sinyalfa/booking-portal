<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Columbus East Tax Services ‚Äì Booking</title>

  <style>
    *{ box-sizing:border-box; }
    html, body{ width:100%; max-width:100%; overflow-x:hidden; }

    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(79,70,229,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(16,185,129,.16), transparent 55%),
        linear-gradient(180deg, #0b1220, #111827);
      padding:16px;
      color:#e5e7eb;
    }

    .wrap{
      width:100%;
      max-width:1040px;
      margin:0 auto;
      display:grid;
      grid-template-columns: minmax(0, 380px) minmax(0, 1fr);
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns:1fr; }
    }

    .card, .panel{
      background: rgba(255,255,255,.96);
      color:#0f172a;
      border:1px solid rgba(255,255,255,.15);
      border-radius:18px;
      box-shadow: 0 20px 55px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card{ padding:16px; text-align:center; }
    .panel{ padding:16px; }

    .logo{
      width:56px;height:56px;border-radius:18px;
      margin:0 auto 10px auto;
      background: linear-gradient(135deg, rgba(79,70,229,1), rgba(16,185,129,1));
      box-shadow: 0 14px 30px rgba(79,70,229,.28);
    }

    h1{ margin:0; font-size:22px; font-weight:900; }
    .sub{ margin-top:8px; color:#475569; font-size:14px; line-height:1.45; }
    .info{ margin-top:10px; font-size:15px; color:#334155; line-height:1.6; }
    .info a{ color:#0f172a; font-weight:800; text-decoration:none; }
    .info a:hover{ text-decoration:underline; }

    .servicesBox{
      margin-top:14px;
      text-align:left;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px 14px;
    }
    .servicesBox h2{ margin:0 0 10px 0; font-size:16px; font-weight:900; }
    .servicesBox ul{ margin:0; padding-left:18px; color:#334155; font-weight:700; }
    .servicesBox li{ margin:6px 0; }

    .btns{ margin-top:14px; display:flex; flex-direction:column; gap:10px; }
    .btn{
      display:flex; align-items:center; justify-content:center; gap:10px;
      border:none; cursor:pointer;
      font-weight:900;
      padding:14px 14px;
      border-radius:14px;
      text-decoration:none;
      color:white;
      transition: transform .12s ease, opacity .12s ease;
      min-height:48px;
    }
    .btn:hover{ transform: translateY(-1px); opacity:.98; }
    .btn.call{ background:#2563eb; }
    .btn.text{ background:#16a34a; }
    .btn.email{ background:#9333ea; }
    .btn.book{ background:#0f766e; }

    .footer{ margin-top:12px; color:#64748b; font-size:13px; }

    .panelTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panelTitle h2{ margin:0; font-size:18px; font-weight:900; color:#0f172a; }
    .badge{
      font-size:12px;
      font-weight:900;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid #e5e7eb;
      background:#f8fafc;
      color:#111827;
    }

    .healthRow{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 2px 0; }
    .pill{
      font-size:12px;
      font-weight:900;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid #e5e7eb;
      background:#f8fafc;
      color:#111827;
    }
    .pill.ok{ background:#dcfce7; border-color:#86efac; color:#166534; }
    .pill.bad{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }

    label{
      display:block;
      text-align:left;
      font-size:13px;
      font-weight:900;
      color:#0f172a;
      margin:12px 0 6px 2px;
    }

    input, select, button{
      max-width:100%;
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid #d1d5db;
      font-size:14px;
      outline:none;
      background:#fff;
      min-height:44px;
    }
    input:focus, select:focus{
      border-color: rgba(79,70,229,.55);
      box-shadow: 0 0 0 4px rgba(99,102,241,.20);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .grid2{ grid-template-columns:1fr; }
    }

    .slots{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 920px){
      .slots{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (max-width: 520px){
      .slots{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    .slotBtn{
      border-radius:14px;
      border:1px solid rgba(16,185,129,.55);
      background: rgba(16,185,129,.08);
      color:#065f46;
      font-weight:900;
      padding:12px 10px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      min-height:46px;
      white-space:nowrap;
    }
    .slotBtn:hover{ transform: translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.10); }
    .slotBtn.selected{
      border-color: rgba(79,70,229,.65);
      background: rgba(79,70,229,.10);
      color:#1e1b4b;
      box-shadow: 0 0 0 4px rgba(99,102,241,.18);
    }

    .confirmBtn{
      margin-top:14px;
      border:none;
      border-radius:14px;
      background: linear-gradient(135deg, #111827, #0b1220);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      padding:14px;
      min-height:52px;
    }
    .confirmBtn:disabled{ opacity:.6; cursor:not-allowed; }

    .note{ margin-top:10px; font-size:13px; color:#475569; line-height:1.4; }

    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      border:1px solid transparent;
      display:none;
    }
    .msg.ok{ background:#dcfce7; color:#166534; border-color:#86efac; }
    .msg.bad{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
    .msg.warn{ background:#fef3c7; color:#92400e; border-color:#fde68a; }

    /* Confirmation card */
    .confirmCard{
      display:none;
      margin-top:14px;
      border-radius:18px;
      border:1px solid #e5e7eb;
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      padding:16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.10);
    }
    .confirmHeader{ display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .checkIcon{
      width:44px;height:44px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      font-size:22px;font-weight:900;
      background:#dcfce7;color:#166534;
      border:1px solid #86efac;
    }
    .confirmTitle{ font-size:18px;font-weight:900;margin:0;color:#0f172a; line-height:1.2; }
    .confirmSub{ margin:4px 0 0 0; font-size:13px; color:#475569; font-weight:800; }

    .confirmGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 520px){
      .confirmGrid{ grid-template-columns:1fr; }
    }
    .confirmItem{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
    }
    .confirmItem .k{ font-size:12px;font-weight:900;color:#64748b;margin-bottom:4px; }
    .confirmItem .v{ font-size:14px;font-weight:900;color:#0f172a; overflow-wrap:anywhere; }

    .confirmActions{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
    .miniBtn{
      flex:1;
      min-width:180px;
      border:none;
      border-radius:14px;
      padding:12px 12px;
      font-weight:900;
      cursor:pointer;
      min-height:44px;
    }
    .miniBtn.primary{ background:#0f766e; color:#fff; }
    .miniBtn.secondary{ background:#111827; color:#fff; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="logo"></div>
      <h1>Columbus East Tax Services</h1>
      <div class="sub">Columbus, Ohio 43227</div>

      <div class="info" style="margin-top:12px;">
        üìû <a href="tel:16145991185">614-599-1185</a><br/>
        üìû <a href="tel:16142597625">614-259-7625</a><br/>
        ‚úâÔ∏è <a href="mailto:Columbuseast.taxservices@outlook.com">Columbuseast.taxservices@outlook.com</a>
      </div>

      <div class="servicesBox">
        <h2>Services Offered</h2>
        <ul>
          <li>W-2 & Individual Tax Returns</li>
          <li>1099 & Self-Employed Taxes</li>
          <li>LLC & Small Business Filing</li>
          <li>Audit Help & IRS Letters</li>
          <li>Amended Returns (1040-X)</li>
        </ul>
      </div>

      <div class="btns">
        <a class="btn call" href="tel:16145991185">üìû Call Now</a>
        <a class="btn text" href="sms:16145991185">üí¨ Text Us</a>
        <a class="btn email" href="mailto:Columbuseast.taxservices@outlook.com">‚úâÔ∏è Email Us</a>
        <a class="btn book" href="#booking">üìÖ Book Appointment</a>
      </div>

      <div class="footer">Tap to call, text, email, or book online</div>
    </div>

    <div class="panel" id="booking">
      <div class="panelTitle">
        <h2>Book an Appointment</h2>
        <span class="badge">60 minutes</span>
      </div>

      <div class="healthRow">
        <span id="pillJs" class="pill">JS: loading‚Ä¶</span>
        <span id="pillSb" class="pill">Supabase: loading‚Ä¶</span>
      </div>

      <!-- Booking Form -->
      <div id="bookingForm">
        <div class="grid2">
          <div>
            <label for="clientName">Full Name</label>
            <input id="clientName" type="text" placeholder="Your name" aria-label="Full name" />
          </div>

          <div>
            <label for="clientEmail">Email Address</label>
            <input id="clientEmail" type="email" placeholder="you@email.com" aria-label="Email address" />
          </div>
        </div>

        <div class="grid2">
          <div>
            <label for="serviceSelect">Select Service</label>
            <select id="serviceSelect" aria-label="Select service">
              <option value="W-2 / Individual Taxes">W-2 / Individual Taxes</option>
              <option value="1099 / Self-Employed">1099 / Self-Employed</option>
              <option value="LLC / Small Business Filing">LLC / Small Business Filing</option>
              <option value="Audit Help">Audit Help</option>
              <option value="Amended Return (1040-X)">Amended Return (1040-X)</option>
            </select>
          </div>

          <div>
            <label for="locationSelect">Location</label>
            <select id="locationSelect" aria-label="Location">
              <option value="CML Whitehall Branch ‚Äî 4445 E Broad St, Columbus, OH 43213">CML Whitehall Branch ‚Äî 4445 E Broad St, Columbus, OH 43213</option>
              <option value="CML Barnett Branch ‚Äî 3434 E Livingston Ave, Columbus, OH 43227">CML Barnett Branch ‚Äî 3434 E Livingston Ave, Columbus, OH 43227</option>
              <option value="CML Reynoldsburg Branch ‚Äî 1402 Brice Rd, Reynoldsburg, OH 43068">CML Reynoldsburg Branch ‚Äî 1402 Brice Rd, Reynoldsburg, OH 43068</option>
              <option value="CML Southeast Branch ‚Äî 3980 S Hamilton Rd, Groveport, OH 43125">CML Southeast Branch ‚Äî 3980 S Hamilton Rd, Groveport, OH 43125</option>
            </select>
          </div>
        </div>

        <label for="datePick">Pick a Date</label>
        <input id="datePick" type="date" aria-label="Pick a date" />

        <div class="note">
          <b>Hours:</b><br/>
          Mon‚ÄìFri: 9:00 AM‚Äì8:00 PM (Blocked 2:00‚Äì5:00 PM)<br/>
          Sat: 10:00 AM‚Äì6:00 PM<br/>
          Sun: 12:00 PM‚Äì6:00 PM
        </div>

        <label>Available Times</label>
        <div id="slots" class="slots"></div>

        <button id="confirmBtn" class="confirmBtn" type="button" disabled>Confirm Booking</button>

        <div id="msg" class="msg"></div>
        <div id="afterNote" class="note">Pick a time, then press Confirm Booking.</div>
      </div>

      <!-- Confirmation Card -->
      <div id="confirmCard" class="confirmCard">
        <div class="confirmHeader">
          <div class="checkIcon">‚úì</div>
          <div>
            <p class="confirmTitle">Booking Confirmed</p>
            <p class="confirmSub">You are scheduled successfully.</p>
          </div>
        </div>

        <div class="confirmGrid">
          <div class="confirmItem">
            <div class="k">Client</div>
            <div id="ccClient" class="v">‚Äî</div>
          </div>
          <div class="confirmItem">
            <div class="k">Email</div>
            <div id="ccEmail" class="v">‚Äî</div>
          </div>
          <div class="confirmItem">
            <div class="k">Date & Time</div>
            <div id="ccDateTime" class="v">‚Äî</div>
          </div>
          <div class="confirmItem">
            <div class="k">Service</div>
            <div id="ccService" class="v">‚Äî</div>
          </div>
          <div class="confirmItem">
            <div class="k">Location</div>
            <div id="ccLocation" class="v">‚Äî</div>
          </div>
          <div class="confirmItem">
            <div class="k">Status</div>
            <div class="v" style="color:#166534;">Confirmed ‚úÖ</div>
          </div>
        </div>

        <div class="confirmActions">
          <button id="btnBookAnother" class="miniBtn primary" type="button">üìÖ Book Another Appointment</button>
          <button id="btnBackTop" class="miniBtn secondary" type="button">‚¨Ü Back to Top</button>
        </div>

        <div class="note" style="margin-top:12px;">
          Need changes? Call or text us anytime.
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const pillJs = document.getElementById("pillJs");
    const pillSb = document.getElementById("pillSb");
    function pillOK(el, text){ el.textContent = text; el.className = "pill ok"; }
    function pillBAD(el, text){ el.textContent = text; el.className = "pill bad"; }

    const msg = document.getElementById("msg");
    function clearMsg(){ msg.style.display="none"; msg.textContent=""; msg.className="msg"; }
    function setMsg(type, text){ msg.style.display="block"; msg.className="msg "+type; msg.textContent=text; }

    pillOK(pillJs, "JS: loaded");

    if (!window.supabase) {
      pillBAD(pillSb, "Supabase: NOT loaded");
      setMsg("bad", "Supabase library failed to load.");
      throw new Error("Supabase library missing");
    }
    pillOK(pillSb, "Supabase: loaded");

    // ‚úÖ Supabase
    const supabaseUrl = "https://zleztbdrxnqirccgkvqx.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsZXp0YmRyeG5xaXJjY2drdnF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwODU5MjAsImV4cCI6MjA4MzY2MTkyMH0.k2BeeoNXCStyq5JqfGCEMYHhuPLN5LUSru9M-_HrOgs";

    const supa = window.supabase.createClient(supabaseUrl, supabaseKey, {
      auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
    });

    const bookingForm = document.getElementById("bookingForm");
    const confirmCard = document.getElementById("confirmCard");

    const clientName = document.getElementById("clientName");
    const clientEmail = document.getElementById("clientEmail");
    const serviceSelect = document.getElementById("serviceSelect");
    const locationSelect = document.getElementById("locationSelect");
    const datePick = document.getElementById("datePick");
    const slotsEl = document.getElementById("slots");
    const confirmBtn = document.getElementById("confirmBtn");
    const afterNote = document.getElementById("afterNote");

    // confirmation fields
    const ccClient = document.getElementById("ccClient");
    const ccEmail = document.getElementById("ccEmail");
    const ccDateTime = document.getElementById("ccDateTime");
    const ccService = document.getElementById("ccService");
    const ccLocation = document.getElementById("ccLocation");

    const btnBookAnother = document.getElementById("btnBookAnother");
    const btnBackTop = document.getElementById("btnBackTop");

    const SLOT_MINUTES = 30;
    const APPT_MINUTES = 60;

    function dayRules(d){
      const dow = d.getDay(); // 0 Sun ... 6 Sat
      if(dow >= 1 && dow <= 5) return { startHour:9, endHour:20, blocks:[{start:14,end:17}] };
      if(dow === 6) return { startHour:10, endHour:18, blocks:[] };
      return { startHour:12, endHour:18, blocks:[] };
    }
    function inBlockedHours(hour, blocks){ return blocks.some(b => hour >= b.start && hour < b.end); }
    function makeSlot(dateObj){
      return { iso: dateObj.toISOString(), label: dateObj.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" }) };
    }
    function localDateFromYMD(ymdStr){
      const [y,m,dd] = ymdStr.split("-").map(Number);
      const d = new Date();
      d.setFullYear(y); d.setMonth(m-1); d.setDate(dd);
      d.setHours(0,0,0,0);
      return d;
    }
    function overlaps(aStart, aEnd, bStart, bEnd){ return aStart < bEnd && bStart < aEnd; }

    async function fetchDayAppointments(day){
      const start = new Date(day); start.setHours(0,0,0,0);
      const end = new Date(day); end.setDate(end.getDate()+1); end.setHours(0,0,0,0);

      const { data, error } = await supa
        .from("appointments")
        .select("start_time, end_time, status")
        .gte("start_time", start.toISOString())
        .lt("start_time", end.toISOString());

      if(error){
        console.warn(error);
        setMsg("bad", "Availability load failed: " + (error.message || "unknown"));
        return [];
      }
      return (data || []).filter(r => (r.status || "confirmed").toLowerCase() !== "cancelled");
    }

    let selectedSlotISO = null;

    function formatDateTimePretty(iso){
      const d = new Date(iso);
      return d.toLocaleString([], {
        weekday:"short", year:"numeric", month:"short", day:"2-digit",
        hour:"2-digit", minute:"2-digit"
      });
    }

    async function renderSlots(){
      selectedSlotISO = null;
      confirmBtn.disabled = true;
      slotsEl.innerHTML = "";
      clearMsg();
      if(afterNote) afterNote.textContent = "Pick a time, then press Confirm Booking.";

      const ymdStr = datePick.value;
      if(!ymdStr) return;

      const day = localDateFromYMD(ymdStr);
      const rules = dayRules(day);
      const existing = await fetchDayAppointments(day);

      const slots = [];
      const base = new Date(day);
      base.setHours(rules.startHour, 0, 0, 0);

      const endBoundary = new Date(day);
      endBoundary.setHours(rules.endHour, 0, 0, 0);

      while(base < endBoundary){
        const h = base.getHours();

        if(!inBlockedHours(h, rules.blocks)){
          const startTime = new Date(base);
          const endTime = new Date(base);
          endTime.setMinutes(endTime.getMinutes() + APPT_MINUTES);

          if(endTime <= endBoundary){
            const isConflict = existing.some(r => {
              const aStart = new Date(r.start_time);
              const aEnd = new Date(r.end_time || r.start_time);
              if(!r.end_time) aEnd.setMinutes(aStart.getMinutes() + APPT_MINUTES);
              return overlaps(startTime, endTime, aStart, aEnd);
            });
            if(!isConflict) slots.push(makeSlot(startTime));
          }
        }

        base.setMinutes(base.getMinutes() + SLOT_MINUTES);
      }

      if(!slots.length){
        slotsEl.innerHTML = `<div class="note">No available times for that date. Try another day.</div>`;
        return;
      }

      slots.forEach(s => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "slotBtn";
        b.textContent = s.label;
        b.addEventListener("click", () => {
          document.querySelectorAll(".slotBtn").forEach(x => x.classList.remove("selected"));
          b.classList.add("selected");
          selectedSlotISO = s.iso;
          confirmBtn.disabled = false;
          clearMsg();
          if(afterNote) afterNote.textContent = "‚úÖ Selected: " + formatDateTimePretty(selectedSlotISO);
        });
        slotsEl.appendChild(b);
      });
    }

    datePick.addEventListener("change", renderSlots);

    confirmBtn.addEventListener("click", async () => {
      const name = (clientName.value || "").trim();
      const email = (clientEmail.value || "").trim();
      const service = serviceSelect.value;
      const location = locationSelect.value;

      if(!name || !email || !selectedSlotISO){
        setMsg("bad", "Please fill name, email, and choose a time.");
        return;
      }

      confirmBtn.disabled = true;
      setMsg("warn", "Submitting‚Ä¶");

      const startISO = selectedSlotISO;
      const end = new Date(startISO);
      end.setMinutes(end.getMinutes() + APPT_MINUTES);
      const endISO = end.toISOString();

      const { data, error } = await supa
        .from("appointments")
        .insert([{
          client_name: name,
          client_email: email,
          service,
          location,
          start_time: startISO,
          end_time: endISO,
          status: "confirmed"
        }])
        .select("*")
        .single();

      if(error){
        console.warn(error);
        setMsg("bad", error.message || "Booking failed.");
        confirmBtn.disabled = false;
        return;
      }

      // Fill confirmation card
      ccClient.textContent = data.client_name || name;
      ccEmail.textContent = data.client_email || email;
      ccDateTime.textContent = formatDateTimePretty(data.start_time || startISO);
      ccService.textContent = data.service || service;
      ccLocation.textContent = data.location || location;

      // Show confirmation card + hide form
      bookingForm.style.display = "none";
      confirmCard.style.display = "block";
      confirmCard.scrollIntoView({ behavior:"smooth", block:"start" });

      clearMsg();
    });

    btnBookAnother.addEventListener("click", async () => {
      confirmCard.style.display = "none";
      bookingForm.style.display = "block";

      clientName.value = "";
      selectedSlotISO = null;

      await renderSlots();
      window.location.hash = "#booking";
    });

    btnBackTop.addEventListener("click", () => {
      window.scrollTo({ top:0, behavior:"smooth" });
    });

    (function init(){
      const now = new Date();
      datePick.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
      renderSlots();
    })();
  </script>
</body>
</html>

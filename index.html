<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Columbus East Tax Services ‚Äì Booking Portal</title>

  <style>
    /* ============================================================
       1) GLOBAL RESETS + VARIABLES
       ============================================================ */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      /* Real-time galaxy hue (JS updates this) */
      --galaxy-hue: 220;

      /* Card + text */
      --card-bg: rgba(170, 215, 255, 0.22);
      --card-border: rgba(210, 235, 255, 0.38);
      --card-shadow: 0 32px 90px rgba(0, 0, 0, 0.62);
      --text-main: #0b1220;
      --muted: #64748b;
      --ring: rgba(96, 165, 250, 0.4);

      /* Buttons */
      --btn-call: #2563eb;
      --btn-text: #16a34a;
      --btn-email: #9333ea;
      --btn-calc: #f59e0b;  /* calculator button */
      --btn-book: #0f766e;

      /* Slots */
      --slot-border: #34d399;
      --slot-bg: #ecfdf5;
      --slot-active-bg: #c7d2fe;
      --slot-active-border: #6366f1;
      --slot-disabled-bg: #f1f5f9;
      --slot-disabled-border: #cbd5e1;
      --slot-disabled-text: #94a3b8;

      /* Clock glow */
      --clock-anim-speed: 2.4s;

      /* Calculator panel */
      --calc-bg1: rgba(255, 251, 235, 0.98); /* light yellow */
      --calc-bg2: rgba(255, 255, 255, 0.98); /* white */
      --calc-border: rgba(226, 232, 240, 1);
    }

    html, body { height: 100%; }

    body {
      font-family: Arial, Helvetica, sans-serif;
      color: #fff;
      overflow-x: hidden;
      background: radial-gradient(circle at 30% 20%, #0b1a3c, #020617 70%);
      transition: background 1.4s ease, filter 1.2s ease;
      position: relative;
    }

    /* Day/Night theme (JS toggles data-theme) */
    body[data-theme="day"] { filter: brightness(1.06) saturate(1.08); }
    body[data-theme="night"] { filter: brightness(0.98) saturate(1.0); }

    /* ============================================================
       2) CANVAS STARFIELD + SHOOTING STARS LAYER
       ============================================================ */
    canvas#starfield {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: -3;
      display: block;
    }

    /* ============================================================
       3) ORBITING GLASS PLANETS AROUND CARD
       ============================================================ */
    .space-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -2;
    }

    .planet-orbit {
      position: absolute;
      border-radius: 50%;
      width: 560px;
      height: 560px;
      transform-origin: center center;
      animation: orbit-slow 26s linear infinite;
    }

    .planet-orbit.fast {
      width: 380px;
      height: 380px;
      animation-duration: 16s;
    }

    .planet-orbit.medium {
      width: 480px;
      height: 480px;
      animation-duration: 20s;
    }

    .planet-orbit.orbit-1 { top: 6%; left: calc(50% - 280px); }
    .planet-orbit.orbit-2 { top: 62%; left: calc(50% - 240px); }
    .planet-orbit.orbit-3 { top: 26%; left: calc(50% - 190px); }

    .planet-glass {
      position: absolute;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 30%,
          rgba(255, 255, 255, 0.95),
          rgba(255, 255, 255, 0.12) 40%,
          rgba(0, 0, 0, 0) 70%
        ),
        conic-gradient(from 120deg,
          hsl(calc(var(--galaxy-hue) * 1deg), 90%, 65%),
          hsl(calc((var(--galaxy-hue) + 70) * 1deg), 90%, 60%),
          hsl(calc((var(--galaxy-hue) + 140) * 1deg), 90%, 62%),
          hsl(calc((var(--galaxy-hue) + 210) * 1deg), 90%, 60%),
          hsl(calc((var(--galaxy-hue) + 280) * 1deg), 90%, 60%),
          hsl(calc(var(--galaxy-hue) * 1deg), 90%, 65%)
        );

      box-shadow:
        0 0 22px hsla(calc(var(--galaxy-hue) * 1deg), 90%, 65%, 0.75),
        0 0 70px hsla(calc((var(--galaxy-hue) + 110) * 1deg), 90%, 62%, 0.50);

      opacity: 0.78;
      animation: floaty 5.2s ease-in-out infinite;
    }

    .planet-orbit.fast .planet-glass { animation-duration: 4.5s; }
    .planet-orbit.medium .planet-glass { animation-duration: 6.0s; }

    .planet-glass.big {
      width: 160px;
      height: 160px;
      top: -80px;
      left: calc(50% - 80px);
    }
    .planet-glass.medium {
      width: 110px;
      height: 110px;
      top: calc(50% - 55px);
      left: -55px;
    }
    .planet-glass.small {
      width: 86px;
      height: 86px;
      top: calc(100% - 43px);
      left: calc(50% - 43px);
    }

    @keyframes orbit-slow { to { transform: rotate(360deg); } }
    @keyframes floaty {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-12px); }
    }

    /* ============================================================
       4) LAYOUT: CARD WRAPPER + GLOSSY GLASS CARD
       ============================================================ */
    .wrap {
      position: relative;
      z-index: 5;
      max-width: 980px;
      margin: 0 auto;
      padding: 22px;
    }

    .card {
      position: relative;
      background: linear-gradient(
        180deg,
        rgba(210, 235, 255, 0.26),
        rgba(170, 215, 255, 0.18)
      );
      border-radius: 28px;
      border: 1px solid var(--card-border);
      box-shadow: var(--card-shadow);
      padding: 36px 24px 28px;
      text-align: center;
      color: var(--text-main);
      backdrop-filter: blur(18px) saturate(185%);
      -webkit-backdrop-filter: blur(18px) saturate(185%);
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -2px;
      background:
        radial-gradient(circle at 20% 0%,
          rgba(255, 255, 255, 0.45),
          rgba(255, 255, 255, 0.08) 45%,
          rgba(255, 255, 255, 0) 70%
        ),
        radial-gradient(circle at 80% 10%,
          rgba(59, 130, 246, 0.20),
          rgba(59, 130, 246, 0) 60%
        );
      pointer-events: none;
      z-index: 0;
    }
    .card > * { position: relative; z-index: 1; }

    @media (max-width: 640px) {
      .card { padding: 28px 18px 20px; }
    }

    /* ============================================================
       5) LOGO + NEON CLOCK
       ============================================================ */
    .logo {
      width: 360px;
      max-width: 92%;
      display: block;
      margin: 0 auto 14px;
      background: transparent !important;
      mix-blend-mode: normal;
      filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.18));
    }

    @keyframes glowPulse {
      0%, 100% {
        box-shadow:
          0 0 14px rgba(59, 130, 246, 0.55),
          0 0 40px rgba(37, 99, 235, 0.45);
        transform: translateY(0);
      }
      50% {
        box-shadow:
          0 0 24px rgba(59, 130, 246, 0.85),
          0 0 70px rgba(37, 99, 235, 0.75);
        transform: translateY(-1px);
      }
    }

    .clock-line {
      margin: 10px auto 26px;
      max-width: 520px;
      font-size: 20px;
      font-weight: 900;
      color: #e5f0ff;
      text-align: center;
      padding: 10px 16px;
      border-radius: 999px;
      background: radial-gradient(
        circle at 50% 0%,
        hsla(calc(var(--galaxy-hue) * 1deg), 90%, 60%, 0.22),
        rgba(15, 23, 42, 0.95)
      );
      border: 1px solid rgba(191, 219, 254, 0.3);
      letter-spacing: 0.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      animation: glowPulse var(--clock-anim-speed) ease-in-out infinite;
    }

    @media (max-width: 480px) {
      .clock-line { font-size: 16px; padding: 9px 10px; }
    }

    /* ============================================================
       6) MAIN CTA BUTTONS (5 buttons)
       ============================================================ */
    .btn {
      width: 100%;
      padding: 18px;
      margin: 12px 0;
      border: none;
      border-radius: 18px;
      font-size: 18px;
      font-weight: 900;
      color: #fff;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.5);
    }

    .btn:hover { transform: translateY(-1px); box-shadow: 0 14px 30px rgba(15, 23, 42, 0.7); }
    .btn:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(15, 23, 42, 0.5); }

    .btn.call { background: var(--btn-call); }
    .btn.text { background: var(--btn-text); }
    .btn.email { background: var(--btn-email); }
    .btn.calc { background: var(--btn-calc); color: #111827; }
    .btn.book { background: var(--btn-book); }

    /* ============================================================
       7) COLLAPSIBLE PANELS (Calculator + Booking)
       ============================================================ */
    .panel-wrap{
      margin-top: 18px;
      text-align: left;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.55s ease;
    }
    .panel-wrap.open { max-height: 3600px; }

    .section {
      margin-top: 12px;
      border-radius: 20px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: 16px;
    }

    .subline { font-size: 15px; font-weight: 900; color: #0f172a; }
    .now { margin-top: 4px; font-weight: 700; font-size: 13px; color: #2563eb; }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 720px) {
      .row { grid-template-columns: 1fr; }
    }

    label {
      font-size: 13px;
      font-weight: 900;
      color: #0f172a;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .today-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      color: #0b1220;
      background: rgba(34, 197, 94, 0.18);
      border: 1px solid rgba(34, 197, 94, 0.45);
    }

    input, select {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
      outline: none;
    }

    input:focus, select:focus {
      border-color: rgba(37, 99, 235, 0.85);
      box-shadow: 0 0 0 3px var(--ring);
    }

    input.today {
      border-color: rgba(34, 197, 94, 0.7);
      box-shadow:
        0 0 0 3px rgba(34, 197, 94, 0.18),
        0 0 18px rgba(34, 197, 94, 0.18);
    }

    .slots-title { margin: 16px 0 10px; font-weight: 900; color: #0f172a; font-size: 15px; }

    .times {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
    }

    .slot {
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--slot-border);
      background: var(--slot-bg);
      font-size: 14px;
      font-weight: 900;
      color: #065f46;
      text-align: center;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .slot:hover { transform: translateY(-1px); box-shadow: 0 8px 16px rgba(15, 23, 42, 0.12); }

    .slot.active {
      background: var(--slot-active-bg);
      border-color: var(--slot-active-border);
      color: #1e1b4b;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.24);
    }

    .slot.disabled {
      background: var(--slot-disabled-bg);
      border-color: var(--slot-disabled-border);
      color: var(--slot-disabled-text);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn.confirm {
      margin-top: 16px;
      background: #020617;
      width: 100%;
    }

    .btn.confirm:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .msg {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 900;
      display: none;
    }

    .msg.ok { display: block; background: #dcfce7; color: #166534; border: 1px solid #86efac; }
    .msg.bad { display: block; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .msg.warn { display: block; background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }

    /* ============================================================
       8) CONFIRMATION CARD (after successful booking)
       ============================================================ */
    .confirm-card {
      display: none;
      margin-top: 16px;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 14px;
    }
    .confirm-card.show { display: block; }

    .confirm-head {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .check {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: #dcfce7;
      border: 1px solid #86efac;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: #166534;
      font-size: 20px;
    }

    .confirm-title { font-size: 17px; font-weight: 900; color: #0f172a; }
    .confirm-sub { font-size: 13px; color: #475569; font-weight: 700; }

    .grid2 {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px) { .grid2 { grid-template-columns: 1fr; } }

    .mini-box {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #ffffff;
    }

    .mini-label { font-size: 12px; font-weight: 900; color: #64748b; margin-bottom: 4px; }
    .mini-val { font-size: 14px; font-weight: 900; color: #0f172a; word-break: break-word; }

    /* ============================================================
       9) CALCULATOR PANEL (Tabs + soft yellow/white)
       ============================================================ */
    .toolShell{
      border: 1px solid var(--calc-border);
      border-radius: 18px;
      overflow: hidden;
      background: linear-gradient(180deg, var(--calc-bg1), var(--calc-bg2));
    }
    .toolHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 14px;
      border-bottom: 1px solid rgba(226,232,240,.9);
      background: rgba(255,255,255,0.65);
      backdrop-filter: blur(10px);
    }
    .toolTitle{
      font-weight: 900;
      color: #0f172a;
      font-size: 15px;
    }
    .toolBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      color: #0f172a;
      border: 1px solid rgba(226,232,240,1);
      background: rgba(255,255,255,0.8);
      white-space: nowrap;
    }

    .tabs{
      display:flex;
      gap: 8px;
      padding: 12px 14px 0;
      flex-wrap: wrap;
    }
    .tabBtn{
      border: 1px solid rgba(203,213,225,1);
      background: rgba(255,255,255,0.92);
      color: #0f172a;
      font-weight: 900;
      font-size: 13px;
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      user-select: none;
    }
    .tabBtn:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(15,23,42,.08); }
    .tabBtn.active{
      background: #0b1220;
      border-color: rgba(15,23,42,0.9);
      color: #fff;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.18);
    }

    .toolBody{
      padding: 14px;
    }
    .toolPane{ display:none; }
    .toolPane.show{ display:block; }

    .hint{
      margin-top: 8px;
      font-size: 12px;
      font-weight: 800;
      color: #475569;
      line-height: 1.35;
    }
    .noteBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(226,232,240,1);
      background: rgba(255,255,255,0.85);
      color: #0f172a;
      font-size: 12px;
      font-weight: 800;
      line-height: 1.4;
    }

    .resultCard{
      margin-top: 14px;
      border-radius: 18px;
      border: 1px solid rgba(226,232,240,1);
      background: rgba(255,255,255,0.92);
      padding: 14px;
      box-shadow: 0 12px 26px rgba(15,23,42,0.08);
    }
    .resultTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .resultTitle{
      font-weight: 900;
      color:#0f172a;
      font-size: 14px;
    }
    .bigNumber{
      font-weight: 900;
      font-size: 28px;
      color:#0f172a;
      letter-spacing: .2px;
    }
    .bigSub{
      margin-top: 6px;
      font-size: 12px;
      font-weight: 800;
      color: #475569;
    }
    .miniGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){ .miniGrid{ grid-template-columns:1fr; } }
    .miniMetric{
      border-radius: 14px;
      border: 1px solid rgba(226,232,240,1);
      padding: 10px 12px;
      background: rgba(255,255,255,0.92);
    }
    .miniMetric .k{ font-size: 11px; font-weight: 900; color: #64748b; }
    .miniMetric .v{ margin-top: 4px; font-size: 14px; font-weight: 900; color:#0f172a; }

    .goalTiles{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 720px){ .goalTiles{ grid-template-columns: 1fr; } }
    .goalTile{
      border-radius: 14px;
      border: 1px solid rgba(203,213,225,1);
      background: rgba(255,255,255,0.9);
      padding: 12px;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      user-select: none;
    }
    .goalTile:hover{ transform: translateY(-1px); box-shadow: 0 12px 22px rgba(15,23,42,.08); }
    .goalTile.active{
      border-color: rgba(59,130,246,0.7);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.18);
    }
    .goalTile .t{ font-weight: 900; color:#0f172a; }
    .goalTile .d{ margin-top: 4px; font-weight: 800; font-size: 12px; color:#475569; }

    .toolActions{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .miniBtn{
      border: none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      cursor: pointer;
      background: #0b1220;
      color: #fff;
      box-shadow: 0 10px 22px rgba(15,23,42,0.14);
      transition: transform .12s ease, opacity .12s ease;
    }
    .miniBtn:hover{ transform: translateY(-1px); }
    .miniBtn.secondary{
      background: rgba(255,255,255,0.9);
      color: #0b1220;
      border: 1px solid rgba(203,213,225,1);
      box-shadow: none;
    }

    /* small modal */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width: 100%;
      max-width: 560px;
      border-radius: 18px;
      border: 1px solid rgba(226,232,240,1);
      background: rgba(255,255,255,0.96);
      padding: 14px;
      box-shadow: 0 28px 90px rgba(0,0,0,0.45);
      color: #0f172a;
    }
    .modal h3{ font-size: 15px; font-weight: 900; margin-bottom: 8px; }
    .modal p{ font-size: 13px; font-weight: 800; color:#334155; line-height:1.45; margin-top: 8px; }
  </style>
</head>

<body>
  <canvas id="starfield"></canvas>

  <div class="space-layer">
    <div class="planet-orbit orbit-1">
      <div class="planet-glass big"></div>
    </div>
    <div class="planet-orbit orbit-2 medium">
      <div class="planet-glass medium"></div>
    </div>
    <div class="planet-orbit orbit-3 fast">
      <div class="planet-glass small"></div>
    </div>
  </div>

  <!-- W-4 modal -->
  <div id="w4ModalBack" class="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="How to fill W-4">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3>How to fill the W-4 (simple)</h3>
        <button id="w4Close" class="miniBtn secondary" type="button">Close</button>
      </div>
      <p><b>Step 1:</b> Choose filing status (Single / MFJ / HOH).</p>
      <p><b>Step 3:</b> Dependents reduce withholding (credits). Enter children/other dependents if applicable.</p>
      <p><b>Step 4(a):</b> Other income (like interest, side income) can increase withholding needs.</p>
      <p><b>Step 4(b):</b> Deductions: use standard unless you itemize a lot.</p>
      <p><b>Step 4(c):</b> Extra withholding per paycheck (best way to avoid owing).</p>
      <p style="opacity:.9;">This page provides general guidance only. Payroll systems may differ.</p>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <img
        class="logo"
        src="https://raw.githubusercontent.com/sinyalfa/booking-portal/main/logo11.png"
        alt="Columbus East Tax Services Logo"
      />

      <div id="clockLine" class="clock-line"></div>

      <!-- ‚úÖ KEEP 5 BUTTONS -->
      <button class="btn call" onclick="window.location='tel:6142597625'">üìû Call Now</button>
      <button class="btn text" onclick="window.location='sms:6142597625'">üí¨ Text Us</button>
      <button class="btn email" onclick="window.location='mailto:columbuseast.taxservices@outlook.com'">‚úâÔ∏è Email Us</button>

      <button class="btn calc" id="toggleCalcBtn" type="button">üßæ Calculator</button>
      <button class="btn book" id="toggleBookBtn" type="button">üìÖ Book Appointment</button>

      <!-- CALCULATOR PANEL (expand/retract) -->
      <div id="calcPanel" class="panel-wrap" aria-label="Calculator panel">
        <div class="section">
          <div class="toolShell">
            <div class="toolHead">
              <div class="toolTitle">Tools</div>
              <div class="toolBadge">Federal only ‚Ä¢ Estimate</div>
            </div>

            <div class="tabs" role="tablist" aria-label="Calculator tabs">
              <button id="tabTax" class="tabBtn active" type="button" role="tab" aria-selected="true">Tax Calculator</button>
              <button id="tabW4" class="tabBtn" type="button" role="tab" aria-selected="false">W-4 Helper</button>
            </div>

            <div class="toolBody">
              <!-- TAX CALCULATOR PANE -->
              <div id="paneTax" class="toolPane show" role="tabpanel" aria-label="Tax Calculator">
                <div class="subline">Tax Calculator (simple)</div>
                <div class="hint">
                  Uses a simplified estimate (not official). For exact results, we recommend a full review.
                </div>

                <div class="row" style="margin-top:12px;">
                  <div>
                    <label for="tcStatus">Filing Status</label>
                    <select id="tcStatus">
                      <option value="single">Single</option>
                      <option value="mfj">Married Filing Joint</option>
                      <option value="hoh">Head of Household</option>
                    </select>
                  </div>
                  <div>
                    <label for="tcYear">Tax Year (display only)</label>
                    <select id="tcYear">
                      <option>2025</option>
                      <option>2024</option>
                    </select>
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label for="tcWages">W-2 Box 1 Wages</label>
                    <input id="tcWages" type="number" inputmode="decimal" placeholder="e.g. 56000" />
                  </div>
                  <div>
                    <label for="tcWithheld">W-2 Box 2 Federal Withheld</label>
                    <input id="tcWithheld" type="number" inputmode="decimal" placeholder="e.g. 2300" />
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label for="tcDeps">Number of Dependents</label>
                    <input id="tcDeps" type="number" inputmode="numeric" min="0" value="0" />
                  </div>
                  <div>
                    <label for="tcOther">Other Income (optional)</label>
                    <input id="tcOther" type="number" inputmode="decimal" placeholder="e.g. 0" />
                  </div>
                </div>

                <div class="toolActions">
                  <button id="tcCalcBtn" class="miniBtn" type="button">Calculate</button>
                  <button id="tcResetBtn" class="miniBtn secondary" type="button">Reset</button>
                </div>

                <div id="tcMsg" class="noteBox" style="display:none;"></div>

                <div id="tcResults" class="resultCard" style="display:none;">
                  <div class="resultTop">
                    <div>
                      <div class="resultTitle">Estimated Result</div>
                      <div class="bigSub">Refund = withheld ‚àí estimated tax</div>
                    </div>
                    <div style="text-align:right;">
                      <div id="tcBig" class="bigNumber">$0</div>
                      <div id="tcBigSub" class="bigSub">‚Äî</div>
                    </div>
                  </div>

                  <div class="miniGrid">
                    <div class="miniMetric">
                      <div class="k">Estimated Tax</div>
                      <div id="tcTax" class="v">$0</div>
                    </div>
                    <div class="miniMetric">
                      <div class="k">Withheld</div>
                      <div id="tcWh" class="v">$0</div>
                    </div>
                    <div class="miniMetric">
                      <div class="k">Taxable Income (approx.)</div>
                      <div id="tcTaxable" class="v">$0</div>
                    </div>
                    <div class="miniMetric">
                      <div class="k">Dependent Credit (simple)</div>
                      <div id="tcCred" class="v">$0</div>
                    </div>
                  </div>

                  <div class="noteBox" style="margin-top:12px;">
                    Note: This is a simplified estimate and may not match software for all situations (credits, deductions, other forms).
                  </div>
                </div>
              </div>

              <!-- W-4 HELPER PANE -->
              <div id="paneW4" class="toolPane" role="tabpanel" aria-label="W-4 Helper">
                <div class="subline">W-4 Withholding Helper</div>
                <div class="hint">
                  Fill your basics and we‚Äôll suggest an <b>extra withholding per paycheck</b> directionally.
                </div>

                <div class="row" style="margin-top:12px;">
                  <div>
                    <label for="w4Status">Filing Status</label>
                    <select id="w4Status">
                      <option value="single">Single</option>
                      <option value="mfj">Married Filing Joint</option>
                      <option value="hoh">Head of Household</option>
                    </select>
                  </div>
                  <div>
                    <label for="w4Freq">Pay Frequency</label>
                    <select id="w4Freq">
                      <option value="52">Weekly (52)</option>
                      <option value="26" selected>Biweekly (26)</option>
                      <option value="24">Semi-monthly (24)</option>
                      <option value="12">Monthly (12)</option>
                    </select>
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label for="w4Gross">Gross Pay per Paycheck</label>
                    <input id="w4Gross" type="number" inputmode="decimal" placeholder="e.g. 2150" />
                  </div>
                  <div>
                    <label for="w4Withhold">Current Federal Withholding per Paycheck</label>
                    <input id="w4Withhold" type="number" inputmode="decimal" placeholder="e.g. 90" />
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label for="w4Kids">Children under 17</label>
                    <input id="w4Kids" type="number" inputmode="numeric" min="0" value="0" />
                  </div>
                  <div>
                    <label for="w4OtherDeps">Other dependents</label>
                    <input id="w4OtherDeps" type="number" inputmode="numeric" min="0" value="0" />
                  </div>
                </div>

                <div class="noteBox">
                  Goal: pick what you prefer at tax time.
                </div>

                <div class="goalTiles" aria-label="W-4 goal">
                  <div class="goalTile active" data-goal="zero" role="button" tabindex="0">
                    <div class="t">Near $0</div>
                    <div class="d">Aim for break-even</div>
                  </div>
                  <div class="goalTile" data-goal="refund" role="button" tabindex="0">
                    <div class="t">Refund</div>
                    <div class="d">Withhold a bit more</div>
                  </div>
                  <div class="goalTile" data-goal="owe" role="button" tabindex="0">
                    <div class="t">Owe a little</div>
                    <div class="d">Keep more in paychecks</div>
                  </div>
                </div>

                <div class="toolActions">
                  <button id="w4CalcBtn" class="miniBtn" type="button">Get Recommendation</button>
                  <button id="w4HowBtn" class="miniBtn secondary" type="button">How to fill W-4</button>
                  <button id="w4BookBtn" class="miniBtn secondary" type="button">Book appointment</button>
                </div>

                <div id="w4Results" class="resultCard" style="display:none;">
                  <div class="resultTop">
                    <div>
                      <div class="resultTitle">Suggested change</div>
                      <div class="bigSub">This is directional guidance (estimate).</div>
                    </div>
                    <div style="text-align:right;">
                      <div id="w4Big" class="bigNumber">$0</div>
                      <div id="w4BigSub" class="bigSub">per paycheck</div>
                    </div>
                  </div>

                  <div class="miniGrid">
                    <div class="miniMetric">
                      <div class="k">Estimated annual tax</div>
                      <div id="w4EstTax" class="v">$0</div>
                    </div>
                    <div class="miniMetric">
                      <div class="k">Estimated annual withholding</div>
                      <div id="w4EstWh" class="v">$0</div>
                    </div>
                    <div class="miniMetric">
                      <div class="k">Where to enter</div>
                      <div class="v">W-4 Step 4(c)</div>
                    </div>
                    <div class="miniMetric">
                      <div class="k">Notes</div>
                      <div class="v">Review during appt</div>
                    </div>
                  </div>

                  <div class="noteBox" style="margin-top:12px;">
                    Tip: If you have multiple jobs or big deductions/credits, we‚Äôll fine-tune this during your appointment.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BOOKING PANEL (expand/retract) -->
      <div id="bookingPanel" class="panel-wrap" aria-label="Booking panel">
        <div class="section">
          <div class="subline">Book an Appointment</div>
          <div id="nowLine" class="now"></div>

          <div class="row">
            <div>
              <label for="fullName">Full Name</label>
              <input id="fullName" placeholder="Your full name" />
            </div>
            <div>
              <label for="clientEmail">Email</label>
              <input id="clientEmail" placeholder="you@example.com" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="service">Service</label>
              <select id="service">
                <option>W-2 / Individual Taxes</option>
                <option>1099 / Self-Employed Taxes</option>
                <option>LLC / Small Business Filing</option>
                <option>Audit Help & IRS Letters</option>
                <option>Amended Returns (1040-X)</option>
              </select>
            </div>

            <div>
              <label for="location">Location</label>
              <select id="location">
                <option>CML Whitehall Branch ‚Äî 4445 E Broad St</option>
                <option>CML Reynoldsburg Branch ‚Äî 1402 Brice Rd</option>
                <option>CML Livingston Branch ‚Äî 3434 E Livingston Ave</option>
                <option>CML Groveport Branch ‚Äî 4980 S Hamilton Rd</option>
                <option>Online / Phone / Text</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="date">Date <span id="todayBadge" class="today-pill" style="display:none;">Today</span></label>
              <input id="date" type="date" />
            </div>
            <div>
              <label for="duration">Length</label>
              <select id="duration">
                <option value="60">60 minutes</option>
              </select>
            </div>
          </div>

          <div class="slots-title">Available Times</div>
          <div id="times" class="times"></div>

          <button id="confirmBtn" class="btn confirm" disabled>Confirm Booking</button>

          <div id="msg" class="msg"></div>

          <div id="confirmCard" class="confirm-card">
            <div class="confirm-head">
              <div class="check">‚úì</div>
              <div>
                <div class="confirm-title">Booking Confirmed</div>
                <div class="confirm-sub">Your appointment has been added to our schedule.</div>
              </div>
            </div>

            <div class="grid2">
              <div class="mini-box">
                <div class="mini-label">Client</div>
                <div id="cName" class="mini-val"></div>
              </div>
              <div class="mini-box">
                <div class="mini-label">Email</div>
                <div id="cEmail" class="mini-val"></div>
              </div>
              <div class="mini-box">
                <div class="mini-label">Date & Time</div>
                <div id="cWhen" class="mini-val"></div>
              </div>
              <div class="mini-box">
                <div class="mini-label">Service</div>
                <div id="cService" class="mini-val"></div>
              </div>
              <div class="mini-box">
                <div class="mini-label">Location</div>
                <div id="cLoc" class="mini-val"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
      <!-- /bookingPanel -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ------------------------------------------------------------
       1) SUPABASE CLIENT CONFIG (booking uses this)
       ------------------------------------------------------------ */
    const supabaseUrl = "https://zleztbdrxnqirccgkvqx.supabase.co";
    const supabaseKey = "sb_publishable_pXXUCH_hx0eg7tUbQNz3rw_DaJgACMR";
    const supa = window.supabase.createClient(supabaseUrl, supabaseKey);

    /* ------------------------------------------------------------
       2) UTILITIES
       ------------------------------------------------------------ */
    function pad(n) { return String(n).padStart(2, "0"); }
    function todayYMD() {
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }
    function fmtNice(dt) {
      return dt.toLocaleString("en-US", {
        weekday: "short",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true,
      });
    }
    function makeLocalDateTimeFrom24(dateStr, hm) {
      const [H, M] = hm.split(":").map(Number);
      const [Y, m, D] = dateStr.split("-").map(Number);
      return new Date(Y, m - 1, D, H, M, 0, 0);
    }
    function isValidEmail(v) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }
    function money(n){
      const x = Number(n || 0);
      return x.toLocaleString("en-US", { style:"currency", currency:"USD", maximumFractionDigits: 0 });
    }

    /* ------------------------------------------------------------
       3) AUTO SWITCH DAY/NIGHT + SYNC GALAXY HUE WITH REAL TIME
       ------------------------------------------------------------ */
    function applyThemeAndGalaxy() {
      const now = new Date();
      const h = now.getHours();
      const m = now.getMinutes();
      const s = now.getSeconds();

      document.body.dataset.theme = (h >= 7 && h < 19) ? "day" : "night";

      const hue = (h * 15 + m * 0.25 + s * (0.25 / 60)) % 360;
      document.documentElement.style.setProperty("--galaxy-hue", hue.toFixed(2));

      const c1 = `hsl(${hue.toFixed(1)}, 72%, ${(h >= 7 && h < 19) ? "26%" : "18%"})`;
      const c2 = `hsl(${((hue + 55) % 360).toFixed(1)}, 78%, 10%)`;
      const c3 = `hsl(${((hue + 120) % 360).toFixed(1)}, 82%, 6%)`;
      document.body.style.background = `radial-gradient(circle at 30% 20%, ${c1}, ${c2} 55%, ${c3} 100%)`;
    }
    applyThemeAndGalaxy();
    setInterval(applyThemeAndGalaxy, 10000);

    /* ------------------------------------------------------------
       4) NEON CLOCK (short weekday + short month + 24h)
       ------------------------------------------------------------ */
    const clockLine = document.getElementById("clockLine");
    const nowLine = document.getElementById("nowLine");

    function updateClock() {
      const now = new Date();
      const datePart = new Intl.DateTimeFormat("en-US", {
        weekday: "short",
        month: "short",
        day: "2-digit",
        year: "numeric",
      }).format(now);

      const timePart = new Intl.DateTimeFormat("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
      }).format(now);

      clockLine.textContent = `${datePart} ‚Ä¢ ${timePart}`;
      if (nowLine) nowLine.textContent = `Now: ${datePart} ‚Ä¢ ${timePart}`;
    }
    updateClock();
    setInterval(updateClock, 1000);

    /* ------------------------------------------------------------
       5) PANEL TOGGLES (Calculator + Booking)
       ------------------------------------------------------------ */
    const toggleCalcBtn = document.getElementById("toggleCalcBtn");
    const toggleBookBtn = document.getElementById("toggleBookBtn");
    const calcPanel = document.getElementById("calcPanel");
    const bookingPanel = document.getElementById("bookingPanel");

    function openPanel(panelEl){
      panelEl.classList.add("open");
    }
    function closePanel(panelEl){
      panelEl.classList.remove("open");
    }
    function togglePanel(panelEl){
      panelEl.classList.toggle("open");
    }

    toggleCalcBtn.addEventListener("click", () => {
      // keep both possible, but if you prefer only one open at a time, uncomment next line:
      // closePanel(bookingPanel);
      togglePanel(calcPanel);
      if (calcPanel.classList.contains("open")) {
        // scroll gently into view
        setTimeout(() => calcPanel.scrollIntoView({ behavior:"smooth", block:"start" }), 50);
      }
    });

    toggleBookBtn.addEventListener("click", () => {
      // closePanel(calcPanel);
      togglePanel(bookingPanel);
      if (bookingPanel.classList.contains("open")) {
        if (!dateEl.value) dateEl.value = todayYMD();
        refreshSlots();
        setTimeout(() => bookingPanel.scrollIntoView({ behavior:"smooth", block:"start" }), 50);
      }
    });

    /* ------------------------------------------------------------
       6) CALCULATOR TABS (A)
       ------------------------------------------------------------ */
    const tabTax = document.getElementById("tabTax");
    const tabW4 = document.getElementById("tabW4");
    const paneTax = document.getElementById("paneTax");
    const paneW4 = document.getElementById("paneW4");

    function showTab(which){
      const isTax = which === "tax";
      tabTax.classList.toggle("active", isTax);
      tabW4.classList.toggle("active", !isTax);
      tabTax.setAttribute("aria-selected", isTax ? "true":"false");
      tabW4.setAttribute("aria-selected", !isTax ? "true":"false");
      paneTax.classList.toggle("show", isTax);
      paneW4.classList.toggle("show", !isTax);
    }
    tabTax.addEventListener("click", () => showTab("tax"));
    tabW4.addEventListener("click", () => showTab("w4"));

    /* ------------------------------------------------------------
       7) SIMPLE TAX CALC (illustrative only)
       ------------------------------------------------------------ */
    const tcStatus = document.getElementById("tcStatus");
    const tcWages = document.getElementById("tcWages");
    const tcWithheld = document.getElementById("tcWithheld");
    const tcDeps = document.getElementById("tcDeps");
    const tcOther = document.getElementById("tcOther");
    const tcCalcBtn = document.getElementById("tcCalcBtn");
    const tcResetBtn = document.getElementById("tcResetBtn");
    const tcMsg = document.getElementById("tcMsg");
    const tcResults = document.getElementById("tcResults");
    const tcBig = document.getElementById("tcBig");
    const tcBigSub = document.getElementById("tcBigSub");
    const tcTax = document.getElementById("tcTax");
    const tcWh = document.getElementById("tcWh");
    const tcTaxable = document.getElementById("tcTaxable");
    const tcCred = document.getElementById("tcCred");

    // NOTE: simplified constants (not official). You can swap later with IRS-accurate logic.
    const STD_DED = { single: 14600, mfj: 29200, hoh: 21900 }; // placeholder-ish
    const DEP_CREDIT_SIMPLE = 2200; // user asked earlier; used as simple credit indicator

    const BRACKETS = {
      single: [
        [0, 0.10],
        [11600, 0.12],
        [47150, 0.22],
        [100525, 0.24],
        [191950, 0.32],
        [243725, 0.35],
        [609350, 0.37],
      ],
      mfj: [
        [0, 0.10],
        [23200, 0.12],
        [94300, 0.22],
        [201050, 0.24],
        [383900, 0.32],
        [487450, 0.35],
        [731200, 0.37],
      ],
      hoh: [
        [0, 0.10],
        [16550, 0.12],
        [63100, 0.22],
        [100500, 0.24],
        [191950, 0.32],
        [243700, 0.35],
        [609350, 0.37],
      ],
    };

    function calcTaxFromBrackets(taxable, status){
      const b = BRACKETS[status] || BRACKETS.single;
      let tax = 0;
      for (let i=0; i<b.length; i++){
        const start = b[i][0];
        const rate = b[i][1];
        const nextStart = (i < b.length-1) ? b[i+1][0] : Infinity;
        if (taxable > start){
          const amt = Math.min(taxable, nextStart) - start;
          tax += amt * rate;
        }
      }
      return Math.max(0, tax);
    }

    function showTcMsg(text){
      tcMsg.style.display = "block";
      tcMsg.textContent = text;
    }

    tcCalcBtn.addEventListener("click", () => {
      const status = tcStatus.value;
      const wages = Number(tcWages.value || 0);
      const other = Number(tcOther.value || 0);
      const withheld = Number(tcWithheld.value || 0);
      const deps = Math.max(0, parseInt(tcDeps.value || "0", 10) || 0);

      if (!wages || wages < 0){
        showTcMsg("Enter a valid W-2 Box 1 wage amount.");
        tcResults.style.display = "none";
        return;
      }

      tcMsg.style.display = "none";

      const gross = wages + other;
      const taxable = Math.max(0, gross - (STD_DED[status] || STD_DED.single));

      const preCreditTax = calcTaxFromBrackets(taxable, status);
      const credit = deps * DEP_CREDIT_SIMPLE; // simplified
      const estTax = Math.max(0, preCreditTax - credit);

      const estRefund = withheld - estTax;

      tcResults.style.display = "block";
      tcTax.textContent = money(estTax);
      tcWh.textContent = money(withheld);
      tcTaxable.textContent = money(taxable);
      tcCred.textContent = money(credit);

      tcBig.textContent = money(Math.abs(estRefund));
      tcBigSub.textContent = estRefund >= 0 ? "Estimated refund" : "Estimated amount owed";
    });

    tcResetBtn.addEventListener("click", () => {
      tcWages.value = "";
      tcWithheld.value = "";
      tcOther.value = "";
      tcDeps.value = "0";
      tcMsg.style.display = "none";
      tcResults.style.display = "none";
    });

    /* ------------------------------------------------------------
       8) W-4 Helper (design + light guidance)
       ------------------------------------------------------------ */
    const w4Status = document.getElementById("w4Status");
    const w4Freq = document.getElementById("w4Freq");
    const w4Gross = document.getElementById("w4Gross");
    const w4Withhold = document.getElementById("w4Withhold");
    const w4Kids = document.getElementById("w4Kids");
    const w4OtherDeps = document.getElementById("w4OtherDeps");
    const w4CalcBtn = document.getElementById("w4CalcBtn");
    const w4HowBtn = document.getElementById("w4HowBtn");
    const w4BookBtn = document.getElementById("w4BookBtn");

    const w4Results = document.getElementById("w4Results");
    const w4Big = document.getElementById("w4Big");
    const w4EstTax = document.getElementById("w4EstTax");
    const w4EstWh = document.getElementById("w4EstWh");

    let w4Goal = "zero";

    document.querySelectorAll(".goalTile").forEach(tile => {
      function activate(){
        document.querySelectorAll(".goalTile").forEach(x => x.classList.remove("active"));
        tile.classList.add("active");
        w4Goal = tile.getAttribute("data-goal") || "zero";
      }
      tile.addEventListener("click", activate);
      tile.addEventListener("keydown", (e) => { if(e.key === "Enter" || e.key === " ") activate(); });
    });

    function estimateAnnualTaxFromIncome(status, annualIncome, kids, otherDeps){
      const taxable = Math.max(0, annualIncome - (STD_DED[status] || STD_DED.single));
      const pre = calcTaxFromBrackets(taxable, status);
      // very simplified credit placeholder: kids * 2000-ish, other deps * 500-ish (directional)
      const credit = Math.max(0, kids * 2000 + otherDeps * 500);
      return Math.max(0, pre - credit);
    }

    w4CalcBtn.addEventListener("click", () => {
      const status = w4Status.value;
      const freq = Number(w4Freq.value || 26);
      const grossPer = Number(w4Gross.value || 0);
      const whPer = Number(w4Withhold.value || 0);
      const kids = Math.max(0, parseInt(w4Kids.value || "0", 10) || 0);
      const otherDeps = Math.max(0, parseInt(w4OtherDeps.value || "0", 10) || 0);

      if (!grossPer || grossPer <= 0 || !freq){
        alert("Enter your gross pay per paycheck.");
        return;
      }
      if (whPer < 0){
        alert("Enter a valid withholding per paycheck.");
        return;
      }

      const annualIncome = grossPer * freq;
      const annualWithholding = whPer * freq;
      const estTax = estimateAnnualTaxFromIncome(status, annualIncome, kids, otherDeps);

      // goal targets:
      // refund: aim to over-withhold by $600/year
      // zero: aim ~0
      // owe: allow owing ~$400/year
      let targetDelta = 0;
      if (w4Goal === "refund") targetDelta = 600;
      else if (w4Goal === "owe") targetDelta = -400;

      const neededAnnualWithholding = estTax + targetDelta;
      const diffAnnual = neededAnnualWithholding - annualWithholding;
      const diffPerPay = diffAnnual / freq;

      w4Results.style.display = "block";
      w4EstTax.textContent = money(estTax);
      w4EstWh.textContent = money(annualWithholding);
      w4Big.textContent = money(Math.round(diffPerPay));
    });

    // modal
    const w4ModalBack = document.getElementById("w4ModalBack");
    const w4Close = document.getElementById("w4Close");
    w4HowBtn.addEventListener("click", () => { w4ModalBack.classList.add("show"); w4ModalBack.setAttribute("aria-hidden","false"); });
    w4Close.addEventListener("click", () => { w4ModalBack.classList.remove("show"); w4ModalBack.setAttribute("aria-hidden","true"); });
    w4ModalBack.addEventListener("click", (e) => { if(e.target === w4ModalBack){ w4ModalBack.classList.remove("show"); w4ModalBack.setAttribute("aria-hidden","true"); } });

    w4BookBtn.addEventListener("click", () => {
      openPanel(bookingPanel);
      setTimeout(() => bookingPanel.scrollIntoView({ behavior:"smooth", block:"start" }), 50);
      // optionally auto-open booking if closed
      if (!bookingPanel.classList.contains("open")) bookingPanel.classList.add("open");
    });

    /* ------------------------------------------------------------
       9) BOOKING LOGIC (your existing Supabase booking)
       ------------------------------------------------------------ */
    const timesBox = document.getElementById("times");
    const confirmBtn = document.getElementById("confirmBtn");
    const msg = document.getElementById("msg");
    const confirmCard = document.getElementById("confirmCard");
    const todayBadge = document.getElementById("todayBadge");

    const fullNameEl = document.getElementById("fullName");
    const clientEmailEl = document.getElementById("clientEmail");
    const serviceEl = document.getElementById("service");
    const locationEl = document.getElementById("location");
    const dateEl = document.getElementById("date");

    const cName = document.getElementById("cName");
    const cEmail = document.getElementById("cEmail");
    const cWhen = document.getElementById("cWhen");
    const cService = document.getElementById("cService");
    const cLoc = document.getElementById("cLoc");

    let selectedSlot = null; // "HH:MM"
    let bookedSet = new Set();

    function updateTodayHighlight() {
      const isToday = dateEl.value === todayYMD();
      todayBadge.style.display = isToday ? "inline-flex" : "none";
      dateEl.classList.toggle("today", isToday);
    }

    function getAllowedHours(dow) {
      if (dow >= 1 && dow <= 5) return [9, 10, 11, 12, 17, 18, 19, 20];
      if (dow === 6) return [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19];
      return [9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19];
    }

    function to12hLabel(hm) {
      let [H, M] = hm.split(":").map(Number);
      const ampm = H >= 12 ? "PM" : "AM";
      H = H % 12;
      if (H === 0) H = 12;
      return `${pad(H)}:${pad(M)} ${ampm}`;
    }

    async function fetchBookedForDate(ymd) {
      const start = new Date(ymd + "T00:00:00");
      const end = new Date(ymd + "T23:59:59");
      const { data, error } = await supa
        .from("appointments")
        .select("start_time,status")
        .gte("start_time", start.toISOString())
        .lte("start_time", end.toISOString());

      if (error) {
        console.error("Fetch booked error:", error);
        return new Set();
      }

      const set = new Set();
      (data || []).forEach((row) => {
        if ((row.status || "").toLowerCase() === "cancelled") return;
        const dt = new Date(row.start_time);
        set.add(`${pad(dt.getHours())}:${pad(dt.getMinutes())}`);
      });
      return set;
    }

    async function refreshSlots() {
      const ymd = dateEl.value;
      timesBox.innerHTML = "";
      selectedSlot = null;
      confirmBtn.disabled = true;
      msg.className = "msg";
      msg.textContent = "";
      confirmCard.classList.remove("show");
      updateTodayHighlight();

      if (!ymd) {
        msg.className = "msg warn";
        msg.textContent = "Please pick a date.";
        return;
      }

      const dateObj = new Date(ymd + "T00:00:00");
      const dow = dateObj.getDay();
      const allowedHours = getAllowedHours(dow);

      bookedSet = await fetchBookedForDate(ymd);

      const now = new Date();
      let anyAvailable = false;

      allowedHours.forEach((H) => {
        const hm = `${pad(H)}:00`;
        const slotDate = makeLocalDateTimeFrom24(ymd, hm);
        const isPast = slotDate <= now;
        const isBooked = bookedSet.has(hm);

        const div = document.createElement("div");
        div.className = "slot";
        div.textContent = to12hLabel(hm);

        if (isBooked || isPast) {
          div.classList.add("disabled");
        } else {
          anyAvailable = true;
          div.addEventListener("click", () => {
            document.querySelectorAll(".slot").forEach((x) => x.classList.remove("active"));
            div.classList.add("active");
            selectedSlot = hm;
            validateForm();
          });
        }

        timesBox.appendChild(div);
      });

      if (!anyAvailable) {
        msg.className = "msg warn";
        msg.textContent = "No available times for this date.";
      } else {
        msg.className = "msg warn";
        msg.textContent = "Select a time to continue.";
      }
    }

    function validateForm() {
      const nameOk = (fullNameEl.value || "").trim().length > 1;
      const emailOk = isValidEmail((clientEmailEl.value || "").trim());
      const slotOk = !!selectedSlot;
      confirmBtn.disabled = !(nameOk && emailOk && slotOk);
    }

    fullNameEl.addEventListener("input", validateForm);
    clientEmailEl.addEventListener("input", validateForm);
    dateEl.addEventListener("change", () => { refreshSlots(); validateForm(); });

    async function hasSameDayBooking(email, ymd) {
      const start = new Date(ymd + "T00:00:00");
      const end = new Date(ymd + "T23:59:59");

      const { data, error } = await supa
        .from("appointments")
        .select("start_time,status")
        .eq("client_email", email)
        .gte("start_time", start.toISOString())
        .lte("start_time", end.toISOString());

      if (error) {
        console.error("Same-day check error:", error);
        return false;
      }
      return (data || []).some((row) => (row.status || "").toLowerCase() !== "cancelled");
    }

    confirmBtn.addEventListener("click", async () => {
      msg.className = "msg warn";
      msg.textContent = "Submitting your booking...";
      confirmBtn.disabled = true;

      const name = (fullNameEl.value || "").trim();
      const email = (clientEmailEl.value || "").trim().toLowerCase();
      const service = serviceEl.value;
      const location = locationEl.value;
      const ymd = dateEl.value;

      if (!name || !isValidEmail(email) || !selectedSlot || !ymd) {
        msg.className = "msg bad";
        msg.textContent = "Please fill all fields and pick a time.";
        validateForm();
        return;
      }

      const already = await hasSameDayBooking(email, ymd);
      if (already) {
        msg.className = "msg bad";
        msg.textContent = "You already have an appointment booked for this day.";
        confirmBtn.disabled = false;
        return;
      }

      const startDT = makeLocalDateTimeFrom24(ymd, selectedSlot);
      const durationMin = parseInt(document.getElementById("duration").value, 10) || 60;
      const endDT = new Date(startDT.getTime() + durationMin * 60000);

      const { error } = await supa.from("appointments").insert([{
        client_name: name,
        client_email: email,
        service,
        location,
        start_time: startDT.toISOString(),
        end_time: endDT.toISOString(),
        status: "confirmed",
      }]);

      if (error) {
        console.error("Insert error:", error);
        msg.className = "msg bad";
        msg.textContent = "Booking failed. Please try again in a moment.";
        confirmBtn.disabled = false;
        return;
      }

      msg.className = "msg ok";
      msg.textContent = "Appointment confirmed! A staff member will review it.";
      confirmCard.classList.add("show");
      cName.textContent = name;
      cEmail.textContent = email;
      cWhen.textContent = fmtNice(startDT);
      cService.textContent = service;
      cLoc.textContent = location;

      await refreshSlots();
      validateForm();
    });

    /* Init booking + clock line in booking */
    const nowLineEl = document.getElementById("nowLine");
    function updateNowLine(){
      const now = new Date();
      const datePart = new Intl.DateTimeFormat("en-US", {
        weekday: "short", month: "short", day: "2-digit", year: "numeric",
      }).format(now);
      const timePart = new Intl.DateTimeFormat("en-US", {
        hour: "2-digit", minute:"2-digit", second:"2-digit", hour12:false
      }).format(now);
      if (nowLineEl) nowLineEl.textContent = `Now: ${datePart} ‚Ä¢ ${timePart}`;
    }
    updateNowLine();
    setInterval(updateNowLine, 1000);

    dateEl.value = todayYMD();
    updateTodayHighlight();
    refreshSlots();
    validateForm();

    /* ------------------------------------------------------------
       10) CANVAS STARFIELD + SHOOTING STARS
       ------------------------------------------------------------ */
    const canvas = document.getElementById("starfield");
    const ctx = canvas.getContext("2d");

    let stars = [];
    let width = window.innerWidth;
    let height = window.innerHeight;

    function resizeCanvas() {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
      initStars();
    }
    window.addEventListener("resize", resizeCanvas);

    function initStars() {
      const count = Math.min(220, Math.floor((width * height) / 12000));
      stars = [];
      for (let i = 0; i < count; i++) {
        stars.push({
          x: Math.random() * width,
          y: Math.random() * height,
          r: Math.random() * 1.4 + 0.4,
          o: Math.random(),
          tw: Math.random() * 2 + 1,
        });
      }
    }

    let shootingStars = [];

    function spawnShootingStar() {
      const startX = Math.random() * width * 0.6;
      const startY = Math.random() * height * 0.3;
      const len = Math.random() * 250 + 120;
      shootingStars.push({
        x: startX,
        y: startY,
        vx: 6 + Math.random() * 4,
        vy: 3 + Math.random() * 3,
        life: 0,
        maxLife: 35 + Math.random() * 20,
        length: len,
      });
    }

    function drawStarfield() {
      ctx.clearRect(0, 0, width, height);

      const hue = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--galaxy-hue")) || 220;
      ctx.fillStyle = `hsla(${hue}, 55%, 6%, 0.92)`;
      ctx.fillRect(0, 0, width, height);

      const t = Date.now() * 0.001;
      for (const s of stars) {
        const pulse = 0.5 + 0.5 * Math.sin(t * s.tw + s.x);
        ctx.globalAlpha = s.o * pulse;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fillStyle = "#e5f2ff";
        ctx.fill();
      }
      ctx.globalAlpha = 1;

      for (let i = shootingStars.length - 1; i >= 0; i--) {
        const sh = shootingStars[i];
        sh.life++;
        sh.x += sh.vx;
        sh.y += sh.vy;
        const p = sh.life / sh.maxLife;
        if (p >= 1) {
          shootingStars.splice(i, 1);
          continue;
        }
        const alpha = 1 - p;
        const tailX = sh.x - sh.vx * sh.length * 0.1;
        const tailY = sh.y - sh.vy * sh.length * 0.1;

        const grad = ctx.createLinearGradient(sh.x, sh.y, tailX, tailY);
        grad.addColorStop(0, `hsla(${(hue + 10) % 360}, 90%, 78%, ${alpha})`);
        grad.addColorStop(1, "rgba(37, 99, 235, 0)");

        ctx.strokeStyle = grad;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(sh.x, sh.y);
        ctx.lineTo(tailX, tailY);
        ctx.stroke();
      }

      requestAnimationFrame(drawStarfield);
    }

    setInterval(() => { if (Math.random() < 0.7) spawnShootingStar(); }, 7000);

    resizeCanvas();
    drawStarfield();
  </script>
</body>
</html>

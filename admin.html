import { serve } from "https://deno.land/std@0.203.0/http/server.ts";
import nodemailer from "npm:nodemailer";

const jsonHeaders = { "content-type": "application/json" };
const corsHeaders = {
  "access-control-allow-origin": "*",
  "access-control-allow-headers": "content-type, x-webhook-secret, authorization",
  "access-control-allow-methods": "POST, OPTIONS",
};

function pickRecord(payload: any) {
  // If your booking page sends flat JSON, keep it:
  if (payload?.client_name || payload?.client_email || payload?.start_time) return payload;

  // If Supabase webhook sends wrapped shapes, try common paths:
  return (
    payload?.record ??
    payload?.new?.record ??
    payload?.old?.record ??
    payload?.data?.record ??
    payload?.data ??
    {}
  );
}

function fmtNice(start_time: string) {
  if (!start_time) return "";
  const d = new Date(start_time);
  if (Number.isNaN(d.getTime())) return start_time;

  const datePart = d.toLocaleDateString("en-US", {
    weekday: "short",
    month: "short",
    day: "numeric",
    year: "numeric",
  });

  const timePart = d.toLocaleTimeString("en-US", {
    hour: "2-digit",
    minute: "2-digit",
    hour12: false,
  });

  return `${datePart} â€¢ ${timePart}`;
}

serve(async (req) => {
  // âœ… Preflight (prevents â€œfailed to fetchâ€ sometimes)
  if (req.method === "OPTIONS") {
    return new Response(null, { status: 204, headers: corsHeaders });
  }

  try {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1) Verify webhook secret
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const expected = Deno.env.get("WEBHOOK_SECRET") || "";
    const got = req.headers.get("x-webhook-secret") || "";

    if (!expected) {
      return new Response(
        JSON.stringify({ error: "Server misconfigured: WEBHOOK_SECRET missing" }),
        { status: 500, headers: { ...jsonHeaders, ...corsHeaders } }
      );
    }

    if (got !== expected) {
      return new Response(
        JSON.stringify({
          error: "Unauthorized (bad webhook secret)",
          hint: "Your request MUST include header: x-webhook-secret",
        }),
        { status: 401, headers: { ...jsonHeaders, ...corsHeaders } }
      );
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2) Read payload
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const payload = await req.json().catch(() => ({}));
    const record = pickRecord(payload);

    const client_name = record?.client_name || "(missing)";
    const client_email = record?.client_email || "(missing)";
    const service = record?.service || "(missing)";
    const location = record?.location || "(missing)";
    const start_time = record?.start_time || "(missing)";

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3) Setup Gmail transport
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const GMAIL_USER = Deno.env.get("GMAIL_USER") || "";
    const GMAIL_APP_PASSWORD = Deno.env.get("GMAIL_APP_PASSWORD") || "";
    const ADMIN_EMAIL = Deno.env.get("ADMIN_EMAIL") || "";

    if (!GMAIL_USER || !GMAIL_APP_PASSWORD || !ADMIN_EMAIL) {
      return new Response(
        JSON.stringify({
          error: "Server misconfigured: missing email env var(s)",
          missing: {
            GMAIL_USER: !GMAIL_USER,
            GMAIL_APP_PASSWORD: !GMAIL_APP_PASSWORD,
            ADMIN_EMAIL: !ADMIN_EMAIL,
          },
        }),
        { status: 500, headers: { ...jsonHeaders, ...corsHeaders } }
      );
    }

    const transporter = nodemailer.createTransport({
      service: "gmail",
      auth: { user: GMAIL_USER, pass: GMAIL_APP_PASSWORD },
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4) Send email
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    await transporter.sendMail({
      from: `"Appointment Bot" <${GMAIL_USER}>`,
      to: ADMIN_EMAIL,
      subject: "ðŸ“… New Appointment Booked",
      html: `
        <div style="font-family:Arial,sans-serif;line-height:1.5">
          <h2 style="margin:0 0 10px;">New Appointment</h2>
          <p><b>Client:</b> ${client_name}</p>
          <p><b>Email:</b> ${client_email}</p>
          <p><b>Service:</b> ${service}</p>
          <p><b>Location:</b> ${location}</p>
          <p><b>Date & Time:</b> ${fmtNice(start_time)}<br/>
            <small style="color:#64748b">Raw: ${start_time}</small>
          </p>
        </div>
      `,
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 5) Done
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    return new Response(
      JSON.stringify({ success: true, message: "Email sent" }),
      { status: 200, headers: { ...jsonHeaders, ...corsHeaders } }
    );
  } catch (err) {
    return new Response(
      JSON.stringify({ error: "Unhandled error", details: String(err?.message || err) }),
      { status: 500, headers: { ...jsonHeaders, ...corsHeaders } }
    );
  }
});

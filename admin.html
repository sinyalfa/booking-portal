// supabase/functions/send-update/index.ts
import { serve } from "https://deno.land/std@0.224.0/http/server.ts";

type Payload =
  | {
      type: "confirm";
      appointment_id: string;
      client_name: string;
      client_email: string;
      service: string;
      location?: string | null;
      start_time: string;
      manage_url?: string;
    }
  | {
      type: "cancel";
      appointment_id: string;
      client_name: string;
      client_email: string;
      service: string;
      location?: string | null;
      start_time: string;
    }
  | {
      type: "reschedule";
      appointment_id: string;
      client_name: string;
      client_email: string;
      service: string;
      location?: string | null;
      old_start_time: string;
      new_start_time: string;
    };

function formatLocation(raw?: string | null): string {
  const s = String(raw ?? "").trim();
  if (!s) return "‚Äî";
  return s
    .replace(/^Columbus Metropolitan Library\s*[:\-]\s*/i, "CML ‚Äì ")
    .replace(/^Columbus Metropolitan Library/i, "CML");
}

function fmtDateTime(iso: string): string {
  try {
    return new Intl.DateTimeFormat("en-US", {
      timeZone: "America/New_York",
      weekday: "short",
      year: "numeric",
      month: "short",
      day: "2-digit",
      hour: "numeric",
      minute: "2-digit",
    }).format(new Date(iso));
  } catch {
    return iso;
  }
}

function escapeHtml(s: string): string {
  return s
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function emailShell(title: string, bodyHtml: string) {
  return `
  <div style="font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;padding:24px;">
    <div style="max-width:640px;margin:0 auto;background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 26px rgba(0,0,0,.08);">
      <div style="font-weight:900;font-size:18px;color:#111827;margin-bottom:6px;">${escapeHtml(title)}</div>
      <div style="color:#4b5563;font-size:13px;margin-bottom:14px;">Columbus East Tax Services</div>
      ${bodyHtml}
      <div style="margin-top:18px;color:#6b7280;font-size:12px;line-height:1.5;">
        Admin alert only ‚Ä¢ Call/Text 614-599-1185
      </div>
    </div>
  </div>`;
}

function detailsBlock(p: {
  name: string;
  email: string;
  service: string;
  location: string;
  when: string;
  manageUrl?: string;
  apptId: string;
}) {
  const manage = p.manageUrl
    ? `<div style="margin-top:12px;">
        <a href="${escapeHtml(p.manageUrl)}" style="display:inline-block;background:#111827;color:#fff;text-decoration:none;font-weight:900;padding:10px 14px;border-radius:12px;">
          Open Manage Link
        </a>
      </div>`
    : "";

  return `
    <div style="border:1px solid #e5e7eb;border-radius:14px;padding:14px;background:#fafafa;">
      <div style="font-weight:900;color:#111827;margin-bottom:6px;">Appointment Details</div>
      <div style="color:#111827;font-size:14px;line-height:1.6;">
        <div><b>Client:</b> ${escapeHtml(p.name)}</div>
        <div><b>Email:</b> ${escapeHtml(p.email)}</div>
        <div><b>Service:</b> ${escapeHtml(p.service)}</div>
        <div><b>Location:</b> ${escapeHtml(p.location)}</div>
        <div><b>When:</b> ${escapeHtml(p.when)}</div>
        <div style="margin-top:10px;color:#6b7280;font-size:12px;"><b>ID:</b> ${escapeHtml(p.apptId)}</div>
      </div>
      ${manage}
    </div>
  `;
}

async function sendWithResend(args: { to: string; subject: string; html: string }) {
  const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY") ?? "";
  const FROM_EMAIL = Deno.env.get("FROM_EMAIL") ?? "";
  if (!RESEND_API_KEY || !FROM_EMAIL) {
    throw new Error("Missing RESEND_API_KEY or FROM_EMAIL env vars");
  }

  const res = await fetch("https://api.resend.com/emails", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${RESEND_API_KEY}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      from: FROM_EMAIL,
      to: args.to,
      subject: args.subject,
      html: args.html,
    }),
  });

  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Resend error ${res.status}: ${txt}`);
  }
}

serve(async (req) => {
  // CORS preflight
  if (req.method === "OPTIONS") {
    return new Response("ok", {
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Headers": "authorization, apikey, content-type",
        "Access-Control-Allow-Methods": "POST, OPTIONS",
      },
    });
  }

  try {
    const ADMIN_EMAIL = Deno.env.get("ADMIN_EMAIL") ?? "";
    if (!ADMIN_EMAIL) throw new Error("Missing ADMIN_EMAIL env var");

    const payload = (await req.json()) as Payload;

    const name = payload.client_name ?? "";
    const email = payload.client_email ?? "";
    const service = payload.service ?? "";
    const location = formatLocation((payload as any).location);

    // ADMIN ONLY ‚Äî no client emails are sent
    if (payload.type === "confirm") {
      const when = fmtDateTime(payload.start_time);
      const htmlAdmin = emailShell(
        "üìå New Appointment Booked",
        detailsBlock({
          name,
          email,
          service,
          location,
          when,
          manageUrl: payload.manage_url,
          apptId: payload.appointment_id,
        }),
      );
      await sendWithResend({ to: ADMIN_EMAIL, subject: "New booking received", html: htmlAdmin });
    }

    if (payload.type === "cancel") {
      const when = fmtDateTime(payload.start_time);
      const htmlAdmin = emailShell(
        "‚ùå Appointment Cancelled",
        detailsBlock({
          name,
          email,
          service,
          location,
          when,
          apptId: payload.appointment_id,
        }),
      );
      await sendWithResend({ to: ADMIN_EMAIL, subject: "Booking cancelled", html: htmlAdmin });
    }

    if (payload.type === "reschedule") {
      const oldWhen = fmtDateTime(payload.old_start_time);
      const newWhen = fmtDateTime(payload.new_start_time);
      const htmlAdmin = emailShell(
        "üîÅ Appointment Rescheduled",
        `
          ${detailsBlock({
            name,
            email,
            service,
            location,
            when: newWhen,
            apptId: payload.appointment_id,
          })}
          <div style="margin-top:12px;border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fff;">
            <div style="font-weight:900;color:#111827;">Previous time</div>
            <div style="color:#4b5563;margin-top:4px;">${escapeHtml(oldWhen)}</div>
          </div>
        `,
      );
      await sendWithResend({ to: ADMIN_EMAIL, subject: "Booking rescheduled", html: htmlAdmin });
    }

    return new Response(JSON.stringify({ ok: true }), {
      headers: {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*",
      },
    });
  } catch (e) {
    return new Response(JSON.stringify({ ok: false, error: String(e?.message ?? e) }), {
      status: 400,
      headers: {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*",
      },
    });
  }
});

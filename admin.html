<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CETS Admin — Appointments</title>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }

    body{
      font-family: Arial, Helvetica, sans-serif;
      color: #e5e7eb;
      background: radial-gradient(circle at 20% 15%, #0b2458, #020617 70%);
      overflow-x: hidden;
    }

    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 26px 18px 40px;
    }

    .card{
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 30px 80px rgba(0,0,0,0.55);
      border-radius: 22px;
      padding: 22px;
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
    }

    h1{
      font-size: 42px;
      font-weight: 900;
      letter-spacing: 0.5px;
      color: #f8fafc;
      margin-bottom: 6px;
    }
    .sub{
      color: rgba(226,232,240,0.82);
      font-weight: 700;
      margin-bottom: 18px;
    }

    .topbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .badge{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(2, 6, 23, 0.65);
      border: 1px solid rgba(148,163,184,0.25);
      font-weight: 900;
      color: #e2e8f0;
      white-space: nowrap;
    }
    .dot{ width: 10px; height: 10px; border-radius: 999px; background: #ef4444; box-shadow: 0 0 10px rgba(239,68,68,0.65); }
    .dot.ok{ background: #22c55e; box-shadow: 0 0 10px rgba(34,197,94,0.55); }

    .grid{
      display: grid;
      grid-template-columns: 1fr 1fr 220px;
      gap: 12px;
      margin-top: 10px;
      margin-bottom: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .input{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(2, 6, 23, 0.55);
      color: #f8fafc;
      padding: 14px 14px;
      font-size: 14px;
      outline: none;
    }
    .input::placeholder{ color: rgba(226,232,240,0.55); }

    .row2{
      display: grid;
      grid-template-columns: 1fr 220px 220px 180px;
      gap: 12px;
      margin-top: 12px;
      margin-bottom: 10px;
    }
    @media (max-width: 980px){
      .row2{ grid-template-columns: 1fr; }
    }

    .btn{
      border: none;
      border-radius: 14px;
      padding: 14px 14px;
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      color: #fff;
      background: rgba(59,130,246,0.92);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      transition: transform .12s ease, opacity .12s ease, box-shadow .12s ease;
      user-select: none;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 30px rgba(0,0,0,0.45); }
    .btn:active{ transform: translateY(0); box-shadow: 0 8px 18px rgba(0,0,0,0.35); }
    .btn:disabled{ opacity: .55; cursor: not-allowed; transform: none; box-shadow: none; }

    .btn.secondary{ background: rgba(100,116,139,0.55); }
    .btn.good{ background: rgba(16,185,129,0.85); }
    .btn.bad{ background: rgba(239,68,68,0.78); }
    .btn.dark{ background: rgba(2,6,23,0.9); }

    .toolbar{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
      margin: 12px 0 14px;
    }
    @media (max-width: 980px){ .toolbar{ grid-template-columns: 1fr; } }

    .msg{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(2,6,23,0.6);
      color: rgba(226,232,240,0.95);
      font-weight: 800;
      font-size: 13px;
      min-height: 44px;
      white-space: pre-wrap;
    }

    table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(2,6,23,0.45);
    }

    thead th{
      text-align: left;
      font-size: 13px;
      letter-spacing: .2px;
      padding: 14px 14px;
      color: #f8fafc;
      background: rgba(148,163,184,0.12);
      border-bottom: 1px solid rgba(148,163,184,0.18);
      font-weight: 900;
    }
    tbody td{
      padding: 14px 14px;
      color: rgba(226,232,240,0.95);
      border-bottom: 1px solid rgba(148,163,184,0.10);
      font-size: 14px;
      vertical-align: top;
    }
    tbody tr:hover td{
      background: rgba(148,163,184,0.08);
    }

    .pill{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(2,6,23,0.65);
      color: #e2e8f0;
      white-space: nowrap;
    }
    .pill.ok{ background: rgba(34,197,94,0.18); border-color: rgba(34,197,94,0.38); color: #bbf7d0; }
    .pill.bad{ background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.35); color: #fecaca; }
    .pill.warn{ background: rgba(245,158,11,0.18); border-color: rgba(245,158,11,0.38); color: #fde68a; }

    .actions{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .mini{
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
    }

    .muted{ color: rgba(226,232,240,0.70); font-weight: 700; font-size: 12px; }
    .hint{
      margin-top: 10px;
      color: rgba(226,232,240,0.75);
      font-weight: 700;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>CETS Admin — Appointments</h1>
        <div class="sub">Sign in with Supabase Auth, then view / filter / confirm / cancel appointments.</div>
      </div>

      <div class="badge" id="statusBadge">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Not connected</span>
      </div>
    </div>

    <div class="card">
      <!-- Auth -->
      <div class="grid">
        <input id="email" class="input" type="email" placeholder="Admin email (Supabase Auth)" autocomplete="username" />
        <input id="password" class="input" type="password" placeholder="Password" autocomplete="current-password" />
        <button id="btnSignIn" class="btn">Sign In</button>
      </div>

      <div class="toolbar">
        <button id="btnSignOut" class="btn secondary">Sign Out</button>
        <button id="btnWhoAmI" class="btn secondary">Who am I?</button>
        <button id="btnTestRead" class="btn good">Test Appointments Read</button>
        <button id="btnRefresh" class="btn">Refresh</button>
      </div>

      <!-- Filters -->
      <div class="row2">
        <input id="q" class="input" placeholder="Search name/email/service/location..." />
        <input id="date" class="input" type="date" />
        <select id="status" class="input">
          <option value="">All statuses</option>
          <option value="confirmed">confirmed</option>
          <option value="cancelled">cancelled</option>
          <option value="pending">pending</option>
        </select>
        <button id="btnToday" class="btn secondary">Today</button>
      </div>

      <div class="toolbar">
        <button id="btnClear" class="btn secondary">Clear Filters</button>
        <button id="btnConfirmFiltered" class="btn good">Confirm Filtered</button>
        <button id="btnCancelFiltered" class="btn bad">Cancel Filtered</button>
        <button id="btnExport" class="btn dark">Export CSV</button>
      </div>

      <div class="msg" id="log">Ready.</div>

      <!-- Table -->
      <div style="margin-top:14px;">
        <table>
          <thead>
            <tr>
              <th style="width: 24%;">Client</th>
              <th style="width: 22%;">Appointment</th>
              <th style="width: 28%;">Service / Location</th>
              <th style="width: 12%;">Status</th>
              <th style="width: 14%;">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" class="muted">Sign in, then click Refresh.</td></tr>
          </tbody>
        </table>
        <div class="hint">
          Tip: Keep this page private (private repo / password protect / basic auth). It uses your Supabase anon key.
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /*****************************************************************
     * 1) CONFIG (PASTE YOUR KEYS HERE)
     *****************************************************************/
    const SUPABASE_URL = "https://zleztbdrxnqirccgkvqx.supabase.co";
    const SUPABASE_ANON_KEY = "PASTE_YOURS_HERE"; // <-- paste your anon key

    /*****************************************************************
     * 2) DOM
     *****************************************************************/
    const el = (id) => document.getElementById(id);

    const statusDot  = el("statusDot");
    const statusText = el("statusText");
    const logBox     = el("log");

    const emailEl = el("email");
    const passEl  = el("password");

    const qEl     = el("q");
    const dateEl  = el("date");
    const statusEl= el("status");

    const tbody   = el("tbody");

    const btnSignIn = el("btnSignIn");
    const btnSignOut = el("btnSignOut");
    const btnWhoAmI = el("btnWhoAmI");
    const btnTestRead = el("btnTestRead");
    const btnRefresh = el("btnRefresh");
    const btnToday = el("btnToday");
    const btnClear = el("btnClear");
    const btnConfirmFiltered = el("btnConfirmFiltered");
    const btnCancelFiltered = el("btnCancelFiltered");
    const btnExport = el("btnExport");

    /*****************************************************************
     * 3) HELPERS
     *****************************************************************/
    function log(msg) {
      const ts = new Date().toLocaleTimeString();
      logBox.textContent = `[${ts}] ${msg}\n` + logBox.textContent;
    }

    function setConnected(ok, text) {
      statusDot.classList.toggle("ok", !!ok);
      statusText.textContent = text || (ok ? "Connected" : "Not connected");
    }

    function pad(n){ return String(n).padStart(2,"0"); }

    function todayYMD(){
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function fmtNice(iso){
      // show local time but still readable
      const d = new Date(iso);
      return d.toLocaleString("en-US", {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "numeric",
        minute: "2-digit",
      });
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function pillForStatus(st){
      const v = (st || "").toLowerCase();
      if (v === "confirmed") return `<span class="pill ok">confirmed</span>`;
      if (v === "cancelled") return `<span class="pill bad">cancelled</span>`;
      return `<span class="pill warn">${escapeHtml(v || "pending")}</span>`;
    }

    function downloadText(filename, text){
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /*****************************************************************
     * 4) SUPABASE CLIENT
     *****************************************************************/
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Keep badge accurate
    supa.auth.onAuthStateChange((_event, session) => {
      if (session?.user) {
        setConnected(true, `Connected — ${session.user.email}`);
      } else {
        setConnected(false, "Not connected");
      }
    });

    async function initStatus() {
      const { data } = await supa.auth.getSession();
      if (data?.session?.user) {
        setConnected(true, `Connected — ${data.session.user.email}`);
      } else {
        setConnected(false, "Not connected");
      }
      log("JS loaded & Supabase client ready.");
    }

    /*****************************************************************
     * 5) DATA LOADING + RENDERING
     *****************************************************************/
    let lastRows = [];

    function applyClientSideFilters(rows) {
      const q = (qEl.value || "").trim().toLowerCase();
      const date = dateEl.value; // YYYY-MM-DD
      const st = (statusEl.value || "").trim().toLowerCase();

      return rows.filter(r => {
        const hay = [
          r.client_name, r.client_email, r.service, r.location, r.status
        ].map(x => String(x||"").toLowerCase()).join(" ");

        if (q && !hay.includes(q)) return false;

        if (st && String(r.status||"").toLowerCase() !== st) return false;

        if (date) {
          // match by start_time date in local time
          const d = new Date(r.start_time);
          const localYMD = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
          if (localYMD !== date) return false;
        }

        return true;
      });
    }

    function render(rows) {
      lastRows = rows;

      const filtered = applyClientSideFilters(rows);

      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">No appointments match filters.</td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map(r => {
        const when = r.start_time ? fmtNice(r.start_time) : "—";
        const client = `
          <div style="font-weight:900;">${escapeHtml(r.client_name || "—")}</div>
          <div class="muted">${escapeHtml(r.client_email || "—")}</div>
        `;

        const appt = `
          <div style="font-weight:900;">${escapeHtml(when)}</div>
          <div class="muted">ID: ${escapeHtml(r.id || "")}</div>
        `;

        const svc = `
          <div style="font-weight:900;">${escapeHtml(r.service || "—")}</div>
          <div class="muted">${escapeHtml(r.location || "—")}</div>
        `;

        const actions = `
          <div class="actions">
            <button class="btn mini good" data-action="confirm" data-id="${escapeHtml(r.id)}">Confirm</button>
            <button class="btn mini bad" data-action="cancel" data-id="${escapeHtml(r.id)}">Cancel</button>
          </div>
        `;

        return `
          <tr>
            <td>${client}</td>
            <td>${appt}</td>
            <td>${svc}</td>
            <td>${pillForStatus(r.status)}</td>
            <td>${actions}</td>
          </tr>
        `;
      }).join("");
    }

    async function loadAppointments() {
      log("Reading appointments...");

      // Must be signed in to pass RLS
      const { data: sess } = await supa.auth.getSession();
      if (!sess?.session?.user) {
        log("No session — sign in first.");
        setConnected(false, "Not connected");
        return;
      }

      // Pull recent appointments (you can widen this later)
      const { data, error } = await supa
        .from("appointments")
        .select("*")
        .order("start_time", { ascending: true })
        .limit(500);

      if (error) {
        console.error(error);
        log(`ERROR reading appointments: ${error.message}`);
        return;
      }

      log(`SUCCESS — rows: ${(data || []).length}`);
      render(data || []);
    }

    /*****************************************************************
     * 6) UPDATES (CONFIRM/CANCEL)
     *****************************************************************/
    async function updateStatus(id, newStatus) {
      const { data: sess } = await supa.auth.getSession();
      if (!sess?.session?.user) {
        log("No session — sign in first.");
        return;
      }

      log(`Updating ${id} → ${newStatus}...`);

      const patch = { status: newStatus };

      // Optional columns (only apply if your table has them)
      if (newStatus === "confirmed") patch.confirmed_at = new Date().toISOString();
      if (newStatus === "cancelled") patch.cancelled_at = new Date().toISOString();

      const { error } = await supa
        .from("appointments")
        .update(patch)
        .eq("id", id);

      if (error) {
        console.error(error);
        log(`ERROR update: ${error.message}`);
        return;
      }

      log(`OK — ${id} updated`);
      await loadAppointments();
    }

    async function bulkUpdateFiltered(newStatus) {
      const filtered = applyClientSideFilters(lastRows);
      if (!filtered.length) {
        log("No rows match filters.");
        return;
      }

      if (!confirm(`Update ${filtered.length} appointment(s) to "${newStatus}"?`)) return;

      for (const r of filtered) {
        // sequential so you can see logging + avoid rate limits
        await updateStatus(r.id, newStatus);
      }
    }

    /*****************************************************************
     * 7) EVENTS
     *****************************************************************/
    btnSignIn.addEventListener("click", async () => {
      try {
        const email = (emailEl.value || "").trim().toLowerCase();
        const password = (passEl.value || "").trim();
        if (!email || !password) {
          log("Enter email + password.");
          return;
        }

        log("Signing in...");
        const { data, error } = await supa.auth.signInWithPassword({ email, password });

        if (error) {
          console.error(error);
          log(`SIGN-IN ERROR: ${error.message}`);
          setConnected(false, "Not connected");
          return;
        }

        setConnected(true, `Connected — ${data.user.email}`);
        log("Signed in successfully.");
      } catch (e) {
        console.error(e);
        log(`SIGN-IN EXCEPTION: ${String(e?.message || e)}`);
      }
    });

    btnSignOut.addEventListener("click", async () => {
      log("Signing out...");
      await supa.auth.signOut();
      setConnected(false, "Not connected");
      log("Signed out.");
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Signed out.</td></tr>`;
    });

    btnWhoAmI.addEventListener("click", async () => {
      const { data } = await supa.auth.getUser();
      if (!data?.user) {
        log("No user session.");
        return;
      }
      log(`User: ${data.user.email} | id: ${data.user.id}`);
    });

    btnTestRead.addEventListener("click", async () => {
      // quick read to see if RLS blocks
      log("Testing read (limit 1)...");
      const { data, error } = await supa.from("appointments").select("*").limit(1);
      if (error) {
        console.error(error);
        log(`TEST READ ERROR: ${error.message}`);
        return;
      }
      log(`TEST READ OK — rows: ${(data || []).length}`);
      if (data?.[0]) log(JSON.stringify(data[0], null, 2));
    });

    btnRefresh.addEventListener("click", loadAppointments);

    btnToday.addEventListener("click", () => {
      dateEl.value = todayYMD();
      render(lastRows);
      log("Filter: Today");
    });

    btnClear.addEventListener("click", () => {
      qEl.value = "";
      dateEl.value = "";
      statusEl.value = "";
      render(lastRows);
      log("Filters cleared.");
    });

    btnConfirmFiltered.addEventListener("click", () => bulkUpdateFiltered("confirmed"));
    btnCancelFiltered.addEventListener("click", () => bulkUpdateFiltered("cancelled"));

    btnExport.addEventListener("click", () => {
      const filtered = applyClientSideFilters(lastRows);

      if (!filtered.length) {
        log("No rows to export.");
        return;
      }

      const headers = ["id","client_name","client_email","service","location","start_time","end_time","status","created_at"];
      const csv = [
        headers.join(","),
        ...filtered.map(r => headers.map(h => {
          const v = r[h] ?? "";
          const s = String(v).replaceAll('"','""');
          return `"${s}"`;
        }).join(","))
      ].join("\n");

      downloadText(`appointments-${Date.now()}.csv`, csv);
      log(`Exported CSV — rows: ${filtered.length}`);
    });

    // Filter typing updates view immediately
    qEl.addEventListener("input", () => render(lastRows));
    dateEl.addEventListener("change", () => render(lastRows));
    statusEl.addEventListener("change", () => render(lastRows));

    // Row actions (event delegation)
    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (!action || !id) return;

      if (action === "confirm") {
        await updateStatus(id, "confirmed");
      } else if (action === "cancel") {
        await updateStatus(id, "cancelled");
      }
    });

    /*****************************************************************
     * 8) INIT
     *****************************************************************/
    initStatus();
  </script>
</body>
</html>

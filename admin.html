<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Columbus East Tax Services</title>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#111827;
      --card:rgba(255,255,255,.96);
      --muted:#6b7280;
      --text:#0f172a;
      --ring:rgba(99,102,241,.35);
      --accent:#4f46e5;

      --okBg:#dcfce7; --okText:#166534; --okBorder:#86efac;
      --badBg:#fee2e2; --badText:#991b1b; --badBorder:#fecaca;
      --warnBg:#fef3c7; --warnText:#92400e; --warnBorder:#fde68a;
    }

    *{ box-sizing:border-box; }

    html, body{
      width:100%;
      max-width:100%;
      overflow-x:hidden;
    }

    body{
      margin:0;
      padding:14px;
      font-family: Arial, Helvetica, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(79,70,229,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(16,185,129,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:#e5e7eb;
    }

    .wrap{
      width:100%;
      max-width: 1100px;
      margin:0 auto;
      display:grid;
      gap:14px;
      grid-template-columns: minmax(0, 1fr);
      align-items:start;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 18px;
      box-shadow: 0 20px 55px rgba(0,0,0,.35);
      padding:14px;
      color: var(--text);
      backdrop-filter: blur(8px);
      overflow:hidden;
      max-width:100%;
    }

    .topBar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .title{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(79,70,229,1), rgba(16,185,129,1));
      box-shadow: 0 14px 30px rgba(79,70,229,.35);
      flex:0 0 auto;
    }
    h1{ margin:0; font-size:18px; font-weight:900; }
    .muted{ color: var(--muted); font-size:13px; line-height:1.4; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      width:100%;
      min-width:0;
      margin-top:12px;
    }

    input, select, button{
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline:none;
      background:#fff;
      min-height:44px;
      flex:1;
      min-width:0;
      max-width:100%;
    }

    input:focus, select:focus{
      border-color: rgba(79,70,229,.55);
      box-shadow: 0 0 0 4px var(--ring);
    }

    button{
      border:none;
      background: linear-gradient(135deg, #111827, #0b1220);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      transition: transform .12s ease, opacity .12s ease;
      min-height:46px;
    }
    button:hover{ transform: translateY(-1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .secondary{
      background:#fff;
      border:1px solid #d1d5db;
      color:#111827;
      font-weight:900;
      box-shadow:none;
      min-height:44px;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px;
      border: 1px solid transparent;
    }
    .pill.ok{ background:var(--okBg); color:var(--okText); border-color:var(--okBorder); }
    .pill.bad{ background:var(--badBg); color:var(--badText); border-color:var(--badBorder); }
    .pill.warn{ background:var(--warnBg); color:var(--warnText); border-color:var(--warnBorder); }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .split{
      display:grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
      gap:14px;
      align-items:start;
    }

    @media (max-width: 980px){
      .split{ grid-template-columns:1fr; }
    }

    /* Calendar */
    .calendarHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .monthTitle{
      font-weight:900;
      font-size:16px;
      color:#0f172a;
    }

    .weekdays{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .weekday{
      text-align:center;
      font-weight:900;
      font-size:12px;
      color:#6b7280;
    }

    .calGrid{
      margin-top:8px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      width:100%;
      max-width:100%;
    }

    .dayCell{
      border:1px solid #e5e7eb;
      border-radius:14px;
      background:#fff;
      padding:10px;
      min-height:84px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      overflow:hidden;
    }
    .dayCell:hover{ transform: translateY(-1px); box-shadow:0 12px 22px rgba(0,0,0,.08); }
    .dayCell.dim{ opacity:.35; cursor:default; }
    .dayNum{
      font-weight:900;
      font-size:13px;
      color:#111827;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .badge{
      font-size:11px;
      font-weight:900;
      border-radius:999px;
      padding:4px 8px;
      border:1px solid #e5e7eb;
      color:#111827;
      background:#f8fafc;
      white-space:nowrap;
    }
    .badge.ok{ background:var(--okBg); border-color:var(--okBorder); color:var(--okText); }
    .badge.bad{ background:var(--badBg); border-color:var(--badBorder); color:var(--badText); }

    .miniList{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .miniItem{
      font-size:11px;
      font-weight:900;
      color:#334155;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#fafafa;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Right panel list */
    .listTitle{
      font-size:14px;
      font-weight:900;
      margin:0;
    }
    .list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .apptCard{
      border:1px solid #e5e7eb;
      border-radius:16px;
      background:#fff;
      padding:12px;
      overflow:hidden;
    }
    .apptTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .apptName{
      font-weight:900;
      color:#111827;
      font-size:14px;
      margin:0;
    }
    .apptMeta{
      font-size:13px;
      color:#334155;
      line-height:1.5;
      margin-top:6px;
    }
    .apptMeta b{ color:#111827; }
    .statusDot{
      width:10px;height:10px;border-radius:999px; display:inline-block;
      margin-right:6px; vertical-align:middle;
    }
    .dotOk{ background:#22c55e; }
    .dotBad{ background:#ef4444; }

    .smallBtns{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .note{
      margin-top:10px;
      font-size:12px;
      color:#6b7280;
      line-height:1.5;
    }

    /* Login overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .loginCard{
      width:100%;
      max-width:420px;
      background: var(--card);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 24px 80px rgba(0,0,0,.45);
      color: var(--text);
      border:1px solid rgba(255,255,255,.12);
    }
  </style>
</head>
<body>

  <!-- LOGIN OVERLAY -->
  <div id="overlay" class="overlay">
    <div class="loginCard">
      <div class="title" style="margin-bottom:8px;">
        <div class="logo"></div>
        <div>
          <h1>Admin Login</h1>
          <div class="muted">Columbus East Tax Services</div>
        </div>
      </div>

      <div class="muted" style="margin-top:8px;">Enter admin password to continue.</div>

      <div class="row">
        <input id="adminPass" type="password" placeholder="Admin password" aria-label="Admin password" />
        <button id="loginBtn" type="button">Login</button>
      </div>

      <div id="loginStatus" class="muted" style="margin-top:10px;"></div>

      <div class="note">
        Tip: If you ever want to change the password, tell me and I’ll generate a new hash for you.
      </div>
    </div>
  </div>

  <div class="wrap">

    <div class="card">
      <div class="topBar">
        <div class="title">
          <div class="logo"></div>
          <div>
            <h1>Admin Dashboard</h1>
            <div class="muted">Month Calendar + Daily Appointments</div>
          </div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="secondary" id="refreshBtn" type="button">Refresh</button>
          <button class="secondary" id="logoutBtn" type="button">Logout</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <input id="searchBox" type="text" placeholder="Search name, email, service, location..." aria-label="Search" />
        <select id="statusFilter" aria-label="Status filter">
          <option value="all">All</option>
          <option value="confirmed">Confirmed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>

      <div class="grid">
        <div class="split">

          <!-- Calendar Panel -->
          <div class="card" style="padding:14px;">
            <div class="calendarHeader">
              <div class="monthTitle" id="monthTitle">Month</div>
              <div style="display:flex; gap:8px;">
                <button class="secondary" id="prevMonth" type="button">◀</button>
                <button class="secondary" id="todayBtn" type="button">Today</button>
                <button class="secondary" id="nextMonth" type="button">▶</button>
              </div>
            </div>

            <div class="weekdays">
              <div class="weekday">Sun</div>
              <div class="weekday">Mon</div>
              <div class="weekday">Tue</div>
              <div class="weekday">Wed</div>
              <div class="weekday">Thu</div>
              <div class="weekday">Fri</div>
              <div class="weekday">Sat</div>
            </div>

            <div class="calGrid" id="calGrid"></div>

            <div class="note">
              Color Key: <span class="badge ok">Confirmed</span> <span class="badge bad">Cancelled</span>
            </div>
          </div>

          <!-- Day List Panel -->
          <div class="card" style="padding:14px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
              <div>
                <div class="listTitle" id="dayTitle">Select a day</div>
                <div class="muted" id="daySub">Tap a day on the calendar</div>
              </div>
              <div id="summaryPills" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
            </div>

            <div class="list" id="apptList"></div>

            <div class="note" id="footerNote"></div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // =========================
    // SUPABASE SETTINGS
    // =========================
    const supabaseUrl = "https://zleztbdrxnqirccgkvqx.supabase.co";
    const supabaseKey = "sb_publishable_pXXUCH_hx0eg7tUbQNz3rw_DaJgACMR";
    const supa = window.supabase.createClient(supabaseUrl, supabaseKey);

    // =========================
    // LOGIN (HASHED PASSWORD)
    // =========================
    // ✅ This is SHA-256 of "Alfusain42!"
    // (so password is NOT stored in plain text)
    const ADMIN_PASS_HASH_HEX = "2c40490f9a3d3c7ce7a9f7d10c75fe5c5a52f6de27e3b6e45af2c0b4dc2b88a0";

    const overlay = document.getElementById("overlay");
    const adminPass = document.getElementById("adminPass");
    const loginBtn = document.getElementById("loginBtn");
    const loginStatus = document.getElementById("loginStatus");

    const refreshBtn = document.getElementById("refreshBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const searchBox = document.getElementById("searchBox");
    const statusFilter = document.getElementById("statusFilter");

    const monthTitle = document.getElementById("monthTitle");
    const calGrid = document.getElementById("calGrid");
    const prevMonth = document.getElementById("prevMonth");
    const nextMonth = document.getElementById("nextMonth");
    const todayBtn = document.getElementById("todayBtn");

    const dayTitle = document.getElementById("dayTitle");
    const daySub = document.getElementById("daySub");
    const apptList = document.getElementById("apptList");
    const summaryPills = document.getElementById("summaryPills");
    const footerNote = document.getElementById("footerNote");

    function pad(n){ return String(n).padStart(2,"0"); }

    function ymd(d){
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function fmtNice(iso){
      return new Intl.DateTimeFormat("en-US", {
        timeZone:"America/New_York",
        weekday:"short", month:"short", day:"2-digit",
        hour:"numeric", minute:"2-digit"
      }).format(new Date(iso));
    }

    function monthLabel(d){
      return d.toLocaleDateString([], { month:"long", year:"numeric" });
    }

    async function sha256Hex(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
    }

    function setLoggedIn(on){
      if(on){
        overlay.style.display = "none";
        localStorage.setItem("admin_logged_in", "1");
      } else {
        overlay.style.display = "flex";
        localStorage.removeItem("admin_logged_in");
      }
    }

    async function tryLogin(){
      loginStatus.innerHTML = `<span class="pill warn">Checking…</span>`;
      const entered = adminPass.value || "";
      const hex = await sha256Hex(entered);
      if(hex === ADMIN_PASS_HASH_HEX){
        loginStatus.innerHTML = `<span class="pill ok">Success</span>`;
        setLoggedIn(true);
        await loadMonthData();
      } else {
        loginStatus.innerHTML = `<span class="pill bad">Wrong password</span>`;
      }
    }

    loginBtn.addEventListener("click", tryLogin);
    adminPass.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryLogin(); });

    logoutBtn.addEventListener("click", () => {
      setLoggedIn(false);
      adminPass.value = "";
      loginStatus.textContent = "";
    });

    // =========================
    // DATA + CALENDAR
    // =========================
    let currentMonth = new Date();
    currentMonth.setDate(1);
    currentMonth.setHours(0,0,0,0);

    let allRows = [];            // month data
    let selectedDay = null;      // Date object

    function getMonthRange(d){
      const start = new Date(d);
      start.setDate(1);
      start.setHours(0,0,0,0);

      const end = new Date(start);
      end.setMonth(end.getMonth()+1);
      end.setHours(0,0,0,0);

      return { start, end };
    }

    async function fetchMonthAppointments(monthDate){
      const { start, end } = getMonthRange(monthDate);

      const { data, error } = await supa
        .from("appointments")
        .select("client_name, client_email, service, location, start_time, status")
        .gte("start_time", start.toISOString())
        .lt("start_time", end.toISOString())
        .order("start_time", { ascending:true });

      if(error){
        console.warn(error);
        return [];
      }
      return data || [];
    }

    function summarizeByDay(rows){
      const map = new Map();
      for(const r of rows){
        const d = new Date(r.start_time);
        d.setHours(0,0,0,0);
        const key = ymd(d);

        if(!map.has(key)){
          map.set(key, { confirmed:0, cancelled:0, items:[] });
        }
        const entry = map.get(key);
        const st = (r.status || "confirmed").toLowerCase();
        if(st === "cancelled") entry.cancelled++;
        else entry.confirmed++;

        entry.items.push(r);
      }
      return map;
    }

    function buildCalendarGrid(monthDate, byDayMap){
      calGrid.innerHTML = "";

      monthTitle.textContent = monthLabel(monthDate);

      const first = new Date(monthDate);
      first.setDate(1);
      const firstDow = first.getDay();

      // starting cell date (Sunday before the 1st)
      const startCell = new Date(first);
      startCell.setDate(first.getDate() - firstDow);
      startCell.setHours(0,0,0,0);

      for(let i=0;i<42;i++){
        const cellDate = new Date(startCell);
        cellDate.setDate(startCell.getDate()+i);

        const key = ymd(cellDate);
        const entry = byDayMap.get(key);

        const isCurrent = cellDate.getMonth() === monthDate.getMonth();
        const isToday = ymd(cellDate) === ymd(new Date());
        const isSelected = selectedDay && ymd(cellDate) === ymd(selectedDay);

        const box = document.createElement("div");
        box.className = "dayCell" + (!isCurrent ? " dim" : "");
        box.style.borderColor = isSelected ? "rgba(79,70,229,.55)" : "#e5e7eb";
        box.style.boxShadow = isSelected ? "0 0 0 4px rgba(99,102,241,.20)" : "none";

        const confirmed = entry ? entry.confirmed : 0;
        const cancelled = entry ? entry.cancelled : 0;

        const badgeHtml = (confirmed + cancelled) > 0
          ? `<span class="badge ${confirmed>0 ? "ok" : "bad"}">${confirmed + cancelled}</span>`
          : (isToday ? `<span class="badge">Today</span>` : `<span class="badge">—</span>`);

        const mini = entry && entry.items.length
          ? entry.items.slice(0,2).map(a => {
              const t = new Date(a.start_time).toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
              return `<div class="miniItem">${t} • ${escapeHtml(a.client_name || "")}</div>`;
            }).join("")
          : "";

        box.innerHTML = `
          <div class="dayNum">
            <span>${cellDate.getDate()}</span>
            ${badgeHtml}
          </div>
          <div class="miniList">${mini}</div>
        `;

        if(isCurrent){
          box.addEventListener("click", () => {
            selectedDay = new Date(cellDate);
            selectedDay.setHours(0,0,0,0);
            renderDayList();
            buildCalendarGrid(currentMonth, summarizeByDay(allRows));
          });
        }

        calGrid.appendChild(box);
      }
    }

    function filterRows(rows){
      const q = (searchBox.value || "").toLowerCase().trim();
      const st = statusFilter.value;

      return rows.filter(r => {
        const status = (r.status || "confirmed").toLowerCase();
        if(st !== "all" && status !== st) return false;

        if(!q) return true;

        const blob = [
          r.client_name, r.client_email, r.service, r.location
        ].join(" ").toLowerCase();

        return blob.includes(q);
      });
    }

    function renderDayList(){
      if(!selectedDay){
        dayTitle.textContent = "Select a day";
        daySub.textContent = "Tap a day on the calendar";
        apptList.innerHTML = "";
        summaryPills.innerHTML = "";
        footerNote.textContent = "";
        return;
      }

      const dayKey = ymd(selectedDay);
      const dayRows = filterRows(allRows).filter(r => {
        const d = new Date(r.start_time);
        d.setHours(0,0,0,0);
        return ymd(d) === dayKey;
      });

      dayTitle.textContent = selectedDay.toLocaleDateString([], { weekday:"long", month:"long", day:"numeric", year:"numeric" });
      daySub.textContent = `${dayRows.length} appointment(s)`;

      const confirmed = dayRows.filter(r => (r.status||"confirmed").toLowerCase() !== "cancelled").length;
      const cancelled = dayRows.filter(r => (r.status||"confirmed").toLowerCase() === "cancelled").length;

      summaryPills.innerHTML = `
        <span class="pill ok">Confirmed: ${confirmed}</span>
        <span class="pill bad">Cancelled: ${cancelled}</span>
      `;

      if(!dayRows.length){
        apptList.innerHTML = `<div class="muted">No appointments found for this day.</div>`;
        footerNote.textContent = "Tip: change month, search, or status filter.";
        return;
      }

      apptList.innerHTML = dayRows.map(r => {
        const status = (r.status || "confirmed").toLowerCase();
        const dot = status === "cancelled" ? "dotBad" : "dotOk";
        const pill = status === "cancelled"
          ? `<span class="pill bad"><span class="statusDot ${dot}"></span>Cancelled</span>`
          : `<span class="pill ok"><span class="statusDot ${dot}"></span>Confirmed</span>`;

        const time = fmtNice(r.start_time);

        return `
          <div class="apptCard">
            <div class="apptTop">
              <div>
                <div class="apptName">${escapeHtml(r.client_name || "Client")}</div>
                <div class="apptMeta">
                  <div><b>Time:</b> ${escapeHtml(time)}</div>
                  <div><b>Service:</b> ${escapeHtml(r.service || "")}</div>
                  <div><b>Location:</b> ${escapeHtml(r.location || "")}</div>
                  <div><b>Email:</b> ${escapeHtml(r.client_email || "")}</div>
                </div>
              </div>
              <div>${pill}</div>
            </div>
          </div>
        `;
      }).join("");

      footerNote.textContent = "This view updates automatically when you Refresh.";
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function loadMonthData(){
      // pick first day if none selected yet
      if(!selectedDay){
        selectedDay = new Date();
        selectedDay.setHours(0,0,0,0);
      }

      allRows = await fetchMonthAppointments(currentMonth);
      const map = summarizeByDay(allRows);

      buildCalendarGrid(currentMonth, map);
      renderDayList();
    }

    prevMonth.addEventListener("click", async () => {
      currentMonth.setMonth(currentMonth.getMonth()-1);
      currentMonth.setDate(1);
      await loadMonthData();
    });

    nextMonth.addEventListener("click", async () => {
      currentMonth.setMonth(currentMonth.getMonth()+1);
      currentMonth.setDate(1);
      await loadMonthData();
    });

    todayBtn.addEventListener("click", async () => {
      currentMonth = new Date();
      currentMonth.setDate(1);
      currentMonth.setHours(0,0,0,0);

      selectedDay = new Date();
      selectedDay.setHours(0,0,0,0);

      await loadMonthData();
    });

    refreshBtn.addEventListener("click", loadMonthData);

    searchBox.addEventListener("input", () => renderDayList());
    statusFilter.addEventListener("change", () => renderDayList());

    // Auto-login if previously logged in
    (function init(){
      const ok = localStorage.getItem("admin_logged_in") === "1";
      if(ok){
        setLoggedIn(true);
        loadMonthData();
      } else {
        setLoggedIn(false);
      }
    })();
  </script>
</body>
</html>

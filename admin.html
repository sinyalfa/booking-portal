<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CETS — Admin Appointments</title>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#020617;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.04);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --good: #22c55e;
      --bad: #ef4444;
      --warn: #f59e0b;
      --blue: #60a5fa;
      --shadow: 0 24px 80px rgba(0,0,0,0.65);
    }

    html,body{height:100%}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      background: radial-gradient(circle at 30% 20%, #0b1a3c, var(--bg) 70%);
      color: var(--text);
      padding: 22px;
    }

    .wrap{max-width:1100px;margin:0 auto}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:16px;
    }
    .title{
      font-size:22px; font-weight:950; letter-spacing:.2px;
    }
    .sub{margin-top:6px;color:var(--muted);font-weight:700;font-size:13px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.85);
      font-weight:900; font-size:12px;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 0 3px rgba(34,197,94,0.18)}

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:hidden;
    }

    .toolbar{
      display:grid;
      grid-template-columns: 1.1fr 0.8fr 0.8fr 0.7fr;
      gap:10px;
      margin-bottom: 12px;
    }
    @media (max-width:900px){
      .toolbar{grid-template-columns: 1fr 1fr}
    }

    input, select, button{
      font: inherit;
    }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.92);
      outline:none;
    }
    select option{background:#fff;color:#0b1220}

    .btn{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(96,165,250,0.22);
      color: rgba(255,255,255,0.95);
      cursor:pointer;
      font-weight: 950;
      transition: transform .10s ease, filter .10s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn.secondary{background: rgba(255,255,255,0.08)}
    .btn.danger{background: rgba(239,68,68,0.22)}
    .btn.good{background: rgba(34,197,94,0.22)}

    .msg{
      margin: 10px 0 0;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.85);
      font-weight: 900;
      font-size: 13px;
      display:none;
    }
    .msg.show{display:block}
    .msg.ok{border-color: rgba(34,197,94,0.30); color: rgba(187,247,208,0.95)}
    .msg.bad{border-color: rgba(239,68,68,0.30); color: rgba(254,202,202,0.95)}
    .msg.warn{border-color: rgba(245,158,11,0.30); color: rgba(253,230,138,0.95)}

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.10);
    }
    thead th{
      text-align:left;
      font-size: 12px;
      letter-spacing:.2px;
      font-weight: 950;
      color: rgba(255,255,255,0.78);
      padding: 10px 10px;
      background: rgba(255,255,255,0.06);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    tbody td{
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      vertical-align: top;
      font-size: 13px;
      color: rgba(255,255,255,0.90);
    }
    tbody tr:hover{background: rgba(255,255,255,0.03)}
    .small{color: rgba(255,255,255,0.62); font-size: 12px; font-weight: 800}
    .status{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 950; font-size: 12px;
      background: rgba(255,255,255,0.04);
    }
    .status.confirmed{border-color: rgba(34,197,94,0.35); color: rgba(187,247,208,0.95)}
    .status.pending{border-color: rgba(245,158,11,0.35); color: rgba(253,230,138,0.95)}
    .status.cancelled{border-color: rgba(239,68,68,0.35); color: rgba(254,202,202,0.95)}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">CETS Admin — Appointments</div>
        <div class="sub">View, filter, confirm, or cancel appointments stored in Supabase.</div>
      </div>
      <div class="pill"><span class="dot"></span><span id="connText">Connecting…</span></div>
    </div>

    <div class="card">
      <div class="toolbar">
        <input id="search" placeholder="Search name/email/service/location…" />
        <input id="date" type="date" />
        <select id="status">
          <option value="">All statuses</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <button id="refresh" class="btn">Refresh</button>

        <button id="todayBtn" class="btn secondary">Today</button>
        <button id="clearBtn" class="btn secondary">Clear Filters</button>
        <button id="confirmAllBtn" class="btn good">Confirm Filtered</button>
        <button id="cancelAllBtn" class="btn danger">Cancel Filtered</button>
      </div>

      <div id="msg" class="msg"></div>

      <div style="overflow:auto; border-radius:14px;">
        <table>
          <thead>
            <tr>
              <th style="min-width:210px;">Client</th>
              <th style="min-width:210px;">Appointment</th>
              <th style="min-width:260px;">Service / Location</th>
              <th style="min-width:150px;">Status</th>
              <th style="min-width:220px;">Actions</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="5" class="small">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="small" style="margin-top:10px;">
        Tip: Keep this page private (password protect / private repo / basic auth) since it uses your Supabase anon key.
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===========================
    // 1) CONFIG (PUT YOUR KEYS)
    // ===========================
    const SUPABASE_URL = "https://zleztbdrxnqirccgkvqx.supabase.co";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE"; // <-- replace
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===========================
    // 2) UI HELPERS
    // ===========================
    const $ = (id)=>document.getElementById(id);
    const rowsEl = $("rows");
    const msgEl = $("msg");
    const connText = $("connText");

    function showMsg(type, text){
      msgEl.className = "msg show " + (type || "");
      msgEl.textContent = text;
    }
    function clearMsg(){
      msgEl.className = "msg";
      msgEl.textContent = "";
    }
    function pad(n){ return String(n).padStart(2,"0"); }
    function todayYMD(){
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function fmtNY(iso){
      const d = new Date(iso);
      return new Intl.DateTimeFormat("en-US",{
        timeZone:"America/New_York",
        weekday:"short", month:"short", day:"2-digit", year:"numeric",
        hour:"numeric", minute:"2-digit"
      }).format(d);
    }
    function esc(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===========================
    // 3) FETCH APPOINTMENTS
    // ===========================
    async function fetchAppointments(){
      clearMsg();
      rowsEl.innerHTML = `<tr><td colspan="5" class="small">Loading…</td></tr>`;

      // filters
      const q = ($("search").value || "").trim().toLowerCase();
      const date = $("date").value || "";
      const status = $("status").value || "";

      // build query
      let query = supa
        .from("appointments")
        .select("id, client_name, client_email, service, location, start_time, end_time, status, created_at")
        .order("start_time", { ascending: true });

      if (status) query = query.eq("status", status);

      if (date){
        const start = new Date(date + "T00:00:00");
        const end = new Date(date + "T23:59:59");
        query = query.gte("start_time", start.toISOString()).lte("start_time", end.toISOString());
      }

      const { data, error } = await query;

      if (error){
        console.error(error);
        rowsEl.innerHTML = `<tr><td colspan="5" class="small">Error loading data.</td></tr>`;
        showMsg("bad", "Error loading appointments: " + error.message);
        return [];
      }

      // text filter (client-side)
      const filtered = (data || []).filter(r=>{
        if (!q) return true;
        const hay = [
          r.client_name, r.client_email, r.service, r.location,
          r.start_time, r.end_time, r.status
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });

      renderRows(filtered);
      return filtered;
    }

    function renderRows(items){
      if (!items.length){
        rowsEl.innerHTML = `<tr><td colspan="5" class="small">No appointments match your filters.</td></tr>`;
        return;
      }

      rowsEl.innerHTML = items.map(r=>{
        const st = r.start_time ? fmtNY(r.start_time) : "—";
        const en = r.end_time ? fmtNY(r.end_time) : "—";
        const stat = (r.status || "pending").toLowerCase();
        const sClass = stat === "confirmed" ? "confirmed" : stat === "cancelled" ? "cancelled" : "pending";

        return `
          <tr data-id="${esc(r.id)}">
            <td>
              <div style="font-weight:950;">${esc(r.client_name || "Client")}</div>
              <div class="small">${esc(r.client_email || "")}</div>
            </td>
            <td>
              <div style="font-weight:950;">${esc(st)}</div>
              <div class="small">Ends: ${esc(en)}</div>
              <div class="small mono">ID: ${esc(r.id)}</div>
            </td>
            <td>
              <div style="font-weight:950;">${esc(r.service || "")}</div>
              <div class="small">${esc(r.location || "")}</div>
            </td>
            <td>
              <span class="status ${sClass}">${esc(stat)}</span>
            </td>
            <td>
              <div class="actions">
                <button class="btn good" data-action="confirm">Confirm</button>
                <button class="btn danger" data-action="cancel">Cancel</button>
                <button class="btn secondary" data-action="copy">Copy Email</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    // ===========================
    // 4) UPDATE STATUS
    // ===========================
    async function updateStatus(id, status){
      const { error } = await supa.from("appointments").update({ status }).eq("id", id);
      if (error) throw error;
    }

    // ===========================
    // 5) EVENTS
    // ===========================
    document.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;
      const id = tr.getAttribute("data-id");
      const action = btn.getAttribute("data-action");

      try{
        if (action === "confirm"){
          await updateStatus(id, "confirmed");
          showMsg("ok", "Confirmed appointment: " + id);
          await fetchAppointments();
        }
        if (action === "cancel"){
          await updateStatus(id, "cancelled");
          showMsg("warn", "Cancelled appointment: " + id);
          await fetchAppointments();
        }
        if (action === "copy"){
          const email = tr.querySelector("td .small")?.textContent || "";
          await navigator.clipboard.writeText(email.trim());
          showMsg("ok", "Copied email: " + email.trim());
        }
      }catch(err){
        console.error(err);
        showMsg("bad", "Action failed: " + (err?.message || err));
      }
    });

    $("refresh").addEventListener("click", fetchAppointments);

    $("todayBtn").addEventListener("click", ()=>{
      $("date").value = todayYMD();
      fetchAppointments();
    });

    $("clearBtn").addEventListener("click", ()=>{
      $("search").value = "";
      $("date").value = "";
      $("status").value = "";
      fetchAppointments();
    });

    $("confirmAllBtn").addEventListener("click", async ()=>{
      const items = await fetchAppointments();
      if (!items.length) return showMsg("warn","No filtered appointments to confirm.");
      if (!confirm(`Confirm ${items.length} appointment(s)?`)) return;

      try{
        for (const r of items) await updateStatus(r.id, "confirmed");
        showMsg("ok", `Confirmed ${items.length} appointment(s).`);
        await fetchAppointments();
      }catch(err){
        console.error(err);
        showMsg("bad","Bulk confirm failed: " + (err?.message || err));
      }
    });

    $("cancelAllBtn").addEventListener("click", async ()=>{
      const items = await fetchAppointments();
      if (!items.length) return showMsg("warn","No filtered appointments to cancel.");
      if (!confirm(`Cancel ${items.length} appointment(s)?`)) return;

      try{
        for (const r of items) await updateStatus(r.id, "cancelled");
        showMsg("warn", `Cancelled ${items.length} appointment(s).`);
        await fetchAppointments();
      }catch(err){
        console.error(err);
        showMsg("bad","Bulk cancel failed: " + (err?.message || err));
      }
    });

    // quick “connected” check + initial load
    (async ()=>{
      try{
        const { error } = await supa.from("appointments").select("id").limit(1);
        if (error) throw error;
        connText.textContent = "Connected";
        await fetchAppointments();
      }catch(err){
        console.error(err);
        connText.textContent = "Not connected";
        showMsg("bad", "Supabase connection failed. Check URL/Anon Key + RLS policies.");
        rowsEl.innerHTML = `<tr><td colspan="5" class="small">Connection failed.</td></tr>`;
      }
    })();
  </script>
</body>
</html>

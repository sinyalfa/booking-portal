<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Appointment – Columbus East Tax Services</title>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#111827;
      --card:rgba(255,255,255,.96);
      --muted:#6b7280;
      --text:#0f172a;
      --ring:rgba(99,102,241,.35);

      --okBg:#dcfce7; --okText:#166534; --okBorder:#86efac;
      --badBg:#fee2e2; --badText:#991b1b; --badBorder:#fecaca;
      --warnBg:#fef3c7; --warnText:#92400e; --warnBorder:#fde68a;

      --accent:#4f46e5;
    }

    *{ box-sizing:border-box; }

    html, body{
      width:100%;
      max-width:100%;
      overflow-x:hidden;
    }

    body{
      margin:0;
      padding:14px;
      font-family: Arial, Helvetica, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(79,70,229,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(16,185,129,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:#e5e7eb;
    }

    .wrap{
      width:100%;
      max-width: 880px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: minmax(0, 1fr);
      gap:14px;
      align-items:start;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 18px;
      box-shadow: 0 20px 55px rgba(0,0,0,.35);
      padding:14px;
      color: var(--text);
      backdrop-filter: blur(8px);
      overflow:hidden;
      max-width:100%;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:46px; height:46px; border-radius:14px;
      background: linear-gradient(135deg, rgba(79,70,229,1), rgba(16,185,129,1));
      box-shadow: 0 14px 30px rgba(79,70,229,.35);
      flex:0 0 auto;
    }
    h1{ margin:0; font-size:18px; font-weight:900; }
    .muted{ color: var(--muted); font-size:13px; line-height:1.4; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px;
      border: 1px solid transparent;
    }
    .pill.ok{ background:var(--okBg); color:var(--okText); border-color:var(--okBorder); }
    .pill.bad{ background:var(--badBg); color:var(--badText); border-color:var(--badBorder); }
    .pill.warn{ background:var(--warnBg); color:var(--warnText); border-color:var(--warnBorder); }

    .box{
      margin-top:12px;
      border:1px solid #e5e7eb;
      border-radius:16px;
      background:#fff;
      padding:14px;
      overflow:hidden;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .field{
      border:1px solid #e5e7eb;
      border-radius:14px;
      background:#fafafa;
      padding:10px;
      overflow:hidden;
    }
    .k{
      font-size:12px;
      font-weight:900;
      color:#6b7280;
      margin-bottom:4px;
    }
    .v{
      font-size:14px;
      font-weight:900;
      color:#111827;
      word-break: break-word;
    }

    @media (max-width: 760px){
      .grid{ grid-template-columns:1fr; }
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      width:100%;
      min-width:0;
    }

    button{
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      font-weight:900;
      cursor:pointer;
      min-height:46px;
      transition: transform .12s ease, opacity .12s ease;
      flex:1;
      min-width:0;
      max-width:100%;
    }
    button:hover{ transform: translateY(-1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .btnCancel{
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      color:#fff;
    }
    .btnBack{
      background:#fff;
      border:1px solid #d1d5db;
      color:#111827;
    }

    .note{
      margin-top:10px;
      font-size:12px;
      color:#6b7280;
      line-height:1.5;
    }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Manage Appointment</h1>
          <div class="muted">Columbus East Tax Services</div>
        </div>
      </div>

      <div id="statusLine" class="muted" style="margin-top:10px;"></div>

      <div class="box" id="box" style="display:none;">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div>
            <div class="pill ok" id="statusPill">Confirmed</div>
          </div>
          <div class="muted" id="niceTime"></div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div class="field">
            <div class="k">Client</div>
            <div class="v" id="clientName">—</div>
          </div>
          <div class="field">
            <div class="k">Email</div>
            <div class="v" id="clientEmail">—</div>
          </div>
          <div class="field">
            <div class="k">Service</div>
            <div class="v" id="service">—</div>
          </div>
          <div class="field">
            <div class="k">Location</div>
            <div class="v" id="location">—</div>
          </div>
        </div>

        <div class="row">
          <button class="btnBack" id="backBtn" type="button">Back to Booking</button>
          <button class="btnCancel" id="cancelBtn" type="button">Cancel Appointment</button>
        </div>

        <div class="note">
          If you need help, call/text: <b>614-599-1185</b>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase
    const supabaseUrl = "https://zleztbdrxnqirccgkvqx.supabase.co";
    const supabaseKey = "sb_publishable_pXXUCH_hx0eg7tUbQNz3rw_DaJgACMR";
    const supa = window.supabase.createClient(supabaseUrl, supabaseKey);

    const statusLine = document.getElementById("statusLine");
    const box = document.getElementById("box");
    const statusPill = document.getElementById("statusPill");
    const niceTime = document.getElementById("niceTime");

    const clientName = document.getElementById("clientName");
    const clientEmail = document.getElementById("clientEmail");
    const service = document.getElementById("service");
    const location = document.getElementById("location");

    const backBtn = document.getElementById("backBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    function fmtNice(iso){
      return new Intl.DateTimeFormat("en-US", {
        timeZone:"America/New_York",
        weekday:"long", month:"long", day:"2-digit", year:"numeric",
        hour:"numeric", minute:"2-digit"
      }).format(new Date(iso));
    }

    function qs(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name) || "";
    }

    let appt = null;

    async function load(){
      const id = qs("id");
      const email = qs("email");

      if(!id || !email){
        statusLine.innerHTML = `<span class="pill bad">Missing Link Info</span> This link is incomplete.`;
        return;
      }

      statusLine.innerHTML = `<span class="pill warn">Loading…</span>`;

      const { data, error } = await supa
        .from("appointments")
        .select("id, client_name, client_email, service, location, start_time, status")
        .eq("id", id)
        .eq("client_email", email)
        .single();

      if(error || !data){
        console.warn(error);
        statusLine.innerHTML = `<span class="pill bad">Not Found</span> Appointment not found.`;
        return;
      }

      appt = data;

      box.style.display = "block";
      statusLine.textContent = "";

      const st = (appt.status || "confirmed").toLowerCase();
      if(st === "cancelled"){
        statusPill.className = "pill bad";
        statusPill.textContent = "Cancelled";
        cancelBtn.disabled = true;
      } else {
        statusPill.className = "pill ok";
        statusPill.textContent = "Confirmed";
        cancelBtn.disabled = false;
      }

      niceTime.textContent = fmtNice(appt.start_time);

      clientName.textContent = appt.client_name || "—";
      clientEmail.textContent = appt.client_email || "—";
      service.textContent = appt.service || "—";
      location.textContent = appt.location || "—";
    }

    backBtn.addEventListener("click", () => {
      // back to booking page
      const u = new URL("index.html", window.location.href);
      window.location.href = u.toString();
    });

    cancelBtn.addEventListener("click", async () => {
      if(!appt) return;
      if(!confirm("Cancel this appointment?")) return;

      cancelBtn.disabled = true;
      statusLine.innerHTML = `<span class="pill warn">Cancelling…</span>`;

      const { error } = await supa
        .from("appointments")
        .update({ status: "cancelled" })
        .eq("id", appt.id);

      if(error){
        console.warn(error);
        statusLine.innerHTML = `<span class="pill bad">Error</span> Could not cancel.`;
        cancelBtn.disabled = false;
        return;
      }

      statusLine.innerHTML = `<span class="pill ok">Cancelled</span> Your appointment was cancelled.`;
      statusPill.className = "pill bad";
      statusPill.textContent = "Cancelled";
      cancelBtn.disabled = true;
    });

    load();
  </script>
</body>
</html>
